!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("imjoyRPC",[],t):"object"==typeof exports?exports.imjoyRPC=t():e.imjoyRPC=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t,r){"use strict";function n(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}r.d(t,"b",(function(){return n})),r.d(t,"d",(function(){return i})),r.d(t,"c",(function(){return c})),r.d(t,"a",(function(){return a}));const i={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"};function o(e){return new Promise((function(t,r){const n={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void r("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?r(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(n,[i.port2]):r("Service worker controller is not available")}))}async function s(e){if(Array.isArray(e)||(requirementsm.code.requirements=[e]),e&&e.length>0)for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await o(t).catch(e=>{console.error(e)})}function c(e,t){"serviceWorker"in navigator&&window.addEventListener("load",(function(){if(navigator.serviceWorker.register("/plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),e=e||"*",(t=t||s)&&"function"!=typeof t)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(r){if("*"===e||r.origin===e){const e=r.data;"cacheRequirements"===e.type&&t(e.requirements)}}))}))}class a{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const r=this._event_handlers[e].indexOf(t);r>=0&&this._event_handlers[e].splice(r,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var r=this._event_handlers[e].length;r--;){const n=this._event_handlers[e][r];try{n(t)}catch(e){console.error(e)}finally{n.___event_run_once&&this._event_handlers[e].splice(r,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return c}));var n=r(0);const i="0.2.1",o=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function s(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}class c extends n.a{constructor(e,t){super(t&&t.debug),this._connection=e,this.config=t||{},this._interface_store={},this._local_api=null;const r=this.config.name;this._connection.execute=this._connection.execute||function(){throw new Error(`connection.execute not implemented (in "${r}")`)},this._store=new a,this._method_refs=new a,this._method_refs.onReady(()=>{this._fire("remoteIdle")}),this._method_refs.onBusy(()=>{this._fire("remoteBusy")}),this._setupMessageHanlders()}init(){this._connection.emit({type:"initialized",config:this.config,peer_id:this._connection.peer_id})}getRemoteCallStack(){return this._method_refs.getStack()}getRemote(){return this._interface_store._rremote}setInterface(e){if(this.config.forwarding_functions)for(let t of this.config.forwarding_functions){const r=this._interface_store._rremote;r[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{r[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{r[t](...e)})))}this._local_api=e,this._fire("interfaceAvailable")}sendInterface(){if(!this._local_api)throw new Error("interface is not set.");this._local_api._rid="_rlocal";const e=this._encode(this._local_api,!0);this._connection.emit({type:"setInterface",api:e})}_setupMessageHanlders(){this._connection.on("init",this.init),this._connection.on("execute",e=>{Promise.resolve(this._connection.execute(e.code)).then(()=>{this._connection.emit({type:"executed"})}).catch(e=>{console.error(e),this._connection.emit({type:"executed",error:e})})}),this._connection.on("method",e=>{let t,r,n,i,o,s=this._interface_store[e.pid];const c=s.__this__||s;if(s)if(n=s[e.name],i=this._unwrap(e.args,!0),e.promise){[t,r]=this._unwrap(e.promise,!1);try{o=n.apply(c,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}catch(e){console.error(this.config.name,e,n),r(e)}}else try{n.apply(c,i)}catch(e){console.error(this.config.name,e,n,i)}else e.promise?([t,r]=this._unwrap(e.promise,!1),r(`plugin api function is not avaialbe in "${e.pid}", the plugin maybe terminated.`)):console.error(`plugin api function is not avaialbe in ${e.pid}, the plugin maybe terminated.`)}),this._connection.on("callback",e=>{let t,r,n,i,o;if(e.promise){[t,r]=this._unwrap(e.promise,!1);try{if(n=this._store.fetch(e._rindex),i=this._unwrap(e.args,!0),!n)throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");o=n.apply(null,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}catch(e){console.error(this.config.name,e,n),r(e)}}else try{if(n=this._store.fetch(e._rindex),i=this._unwrap(e.args,!0),!n)throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");n.apply(null,i)}catch(e){console.error(this.config.name,e,n,i)}}),this._connection.on("setInterface",e=>{this._setRemoteInterface(e.api)}),this._connection.on("getInterface",()=>{this._fire("getInterface"),this._local_api?this.sendInterface():this.once("interfaceAvailable",()=>{this.sendInterface()})}),this._connection.on("interfaceSetAsRemote",()=>{this._fire("interfaceSetAsRemote")}),this._connection.on("disconnect",()=>{this._fire("beforeDisconnect"),this._connection.disconnect(),this._fire("disconnected")})}requestRemote(){this._connection.emit({type:"getInterface"})}_ndarray(e,t,r){var i=n.d[e.constructor.name];if(r&&r!==i)throw"dtype doesn't match the type of the array: "+i+" != "+r;return{_rtype:"ndarray",_rvalue:e,_rshape:t=t||[e.length],_rdtype:i}}_setRemoteInterface(e){this._interface_store._rremote=this._decode(e),this._fire("remoteReady"),this._reportRemoteSet()}_genRemoteMethod(e,t){var r=this,n=function(){return new Promise((n,i)=>{let o=null;try{o=r._method_refs.put(t?t+"/"+e:e);var s=function(){return null!==o&&r._method_refs.fetch(o),n.apply(this,arguments)},c=function(){return null!==o&&r._method_refs.fetch(o),i.apply(this,arguments)};s.__jailed_pairs__=c,c.__jailed_pairs__=s;var a=Array.prototype.slice.call(arguments),_=(a="register"===e||"export"===e||"on"===e?r._wrap(a,!0):r._wrap(a)).args.__transferables__;_&&delete a.args.__transferables__,r._connection.emit({type:"method",name:e,pid:t,args:a,promise:r._wrap([s,c])},_)}catch(n){o&&r._method_refs.fetch(o),i(`Failed to exectue remote method (interface: ${t||r.id}, method: ${e}), error: ${n}`)}})};return n.__remote_method=!0,n}_reportRemoteSet(){this._connection.emit({type:"interfaceSetAsRemote"})}_encodeInterface(e){let t,r,i;const o={};if(e._rid=e._rid||Object(n.b)(),e.constructor===Object||Array.isArray(e))i=Object.keys(e);else{if(e.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(e.constructor.constructor!==Function)throw Error("Unsupported interface type");i=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e))}const s=Array.isArray(e)?[]:{};for(r of i)["hasOwnProperty","constructor"].includes(r)||r.startsWith("_")||(t=e[r],"function"==typeof t?(s[r]={_rtype:"interface",_rid:e._rid,_rvalue:r},o[r]=t):Object(t)!==t?(s[r]={_rtype:"argument",_rvalue:t},o[r]=t):"object"==typeof t&&(s[r]=this._encodeInterface(t)));return this._interface_store[e._rid]=o,e.on&&"function"==typeof e.on&&e.on("close",()=>{delete this._interface_store[e._rid]}),s}_encode(e,t){const r=[];if(!e)return e;const i=e._transfer;let s,c,a;const _=Array.isArray(e);if("object"==typeof e&&e._rtype&&e._rvalue)return e;if("object"==typeof e&&!Array.isArray(e)&&(e._rintf||t))return this._encodeInterface(e);for(a in t&&(e._rid=e._rid||Object(n.b)(),this._interface_store[e._rid]=this._interface_store[e._rid]||(_?[]:{})),s=_?[]:{},e)if(!["hasOwnProperty","constructor"].includes(a)&&(_||e.hasOwnProperty(a))){if(c=e[a],c&&"function"==typeof this._local_api._rpc_encode){const t=this._local_api._rpc_encode(c);if(t&&t._ctype){s[a]={_rtype:"custom",_rvalue:t,_rid:e._rid};continue}void 0!==t&&(c=t)}if("function"==typeof c){if(t){const t=this._interface_store[e._rid];s[a]={_rtype:"interface",_rid:e._rid,_rvalue:a},t[a]=c;continue}let r=null;for(var d in this._local_api)if(this._local_api.hasOwnProperty(d)){if(d.startsWith("_"))continue;if(this._local_api[d]===c){r=d;break}}for(var l=Object.getOwnPropertyNames(Object.getPrototypeOf(this._local_api)),u=0;u<l.length;u++){var p=l[u];if(!p.startsWith("_")&&this._local_api[p]===c){r=p;break}}if(r)s[a]={_rtype:"interface",_rvalue:r,_rid:"_rlocal"};else{var f=this._store.put(c);s[a]={_rtype:"callback",_rvalue:c.constructor&&c.constructor.name||f,_rindex:f}}}else if("undefined"!=typeof tf&&tf.Tensor&&c instanceof tf.Tensor){const e=c.dataSync();(c._transfer||i)&&(r.push(e.buffer),delete c._transfer),s[a]={_rtype:"ndarray",_rvalue:e,_rshape:c.shape,_rdtype:c.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&c instanceof nj.NdArray){var h=n.d[c.selection.data.constructor.name];(c._transfer||i)&&(r.push(c.selection.data.buffer),delete c._transfer),s[a]={_rtype:"ndarray",_rvalue:c.selection.data,_rshape:c.shape,_rdtype:h}}else if(c instanceof Error)console.error(c),s[a]={_rtype:"error",_rvalue:c.toString()};else if("undefined"!=typeof File&&c instanceof File)s[a]={_rtype:"file",_rvalue:c,_rrelative_path:c.relativePath||c.webkitRelativePath};else if(c!==Object(c)||c instanceof Boolean||c instanceof String||c instanceof Date||c instanceof RegExp||c instanceof Blob||c instanceof ImageData||"undefined"!=typeof FileList&&c instanceof FileList)s[a]={_rtype:"argument",_rvalue:c};else if(c instanceof ArrayBuffer)(c._transfer||i)&&(r.push(c),delete c._transfer),s[a]={_rtype:"argument",_rvalue:c};else if(c instanceof o)(c._transfer||i)&&(r.push(c.buffer),delete c._transfer),s[a]={_rtype:"argument",_rvalue:c};else if(c._rintf)s[a]=this._encode(c,!0);else{if("object"!=typeof c)throw"imjoy-rpc: Unsupported data type "+a+","+c;if(s[a]=this._encode(c,t),s[a].__transferables__){for(var y=0;y<s[a].__transferables__.length;y++)r.push(s[a].__transferables__[y]);delete s[a].__transferables__}}}return r.length>0&&(s.__transferables__=r),s}_decode(e,t,r){if(!e)return e;var n,i,o;if(e.hasOwnProperty("_rtype")&&e.hasOwnProperty("_rvalue")){if("custom"===e._rtype)e._rvalue&&"function"==typeof this._local_api._rpc_decode?void 0===(n=this._local_api._rpc_decode(e._rvalue))&&(n=e):n=e;else if("callback"===e._rtype)n=this._genRemoteCallback(t,e._rindex,r);else if("interface"===e._rtype){const t="_rlocal"===e._rid?"_rrmote":e._rid;n=this._interface_store[t]&&this._interface_store[t][e._rvalue]||this._genRemoteMethod(e._rvalue,e._rid)}else"ndarray"===e._rtype?"undefined"!=typeof nj&&nj.array?(Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(s)),n=nj.array(e._rvalue,e._rdtype).reshape(e._rshape)):"undefined"!=typeof tf&&tf.Tensor?(Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(s)),n=tf.tensor(e._rvalue,e._rshape,e._rdtype)):n=e:"error"===e._rtype?n=new Error(e._rvalue):"file"===e._rtype?(n=e._rvalue).relativePath=e._rrelative_path:"argument"===e._rtype&&(n=e._rvalue);return n}var c=Array.isArray(e);for(o in n=c?[]:{},e)(c||e.hasOwnProperty(o))&&("object"==typeof(i=e[o])||Array.isArray(i))&&(n[o]=this._decode(i,t,r));return n}_wrap(e,t){return{args:this._encode(e,t)}}_unwrap(e,t){return this._decode(e.args,e.callbackId,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise((r,i)=>{var o=n._wrap(Array.prototype.slice.call(arguments)),s=o.args.__transferables__;s&&delete o.args.__transferables__,r.__jailed_pairs__=i,i.__jailed_pairs__=r;try{n._connection.emit({type:"callback",id:e,_rindex:t,args:o,promise:n._wrap([r,i])},s)}catch(r){i(`Failed to exectue remote callback (id: ${e}, argNum: ${t}).`)}})}:function(){var r=n._wrap(Array.prototype.slice.call(arguments)),i=r.args.__transferables__;return i&&delete r.args.__transferables__,n._connection.emit({type:"callback",id:e,_rindex:t,args:r},i)}}disconnect(){this._connection.emit({type:"disconnect"}),setTimeout(()=>{this._connection.disconnect()},2e3)}}class a{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t,r,n=this._store[e];if(n&&!n.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),n&&n.__jailed_pairs__){const e=(t=this._store,r=n.__jailed_pairs__,Object.keys(t).find(e=>t[e]===r));this.fetch(e)}return n}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return Connection})),__webpack_require__.d(__webpack_exports__,"b",(function(){return setupIframe}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0);function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}var _importScript=function(e){return new Promise((t,r)=>{var n=document.createElement("script");n.src=e,n.type="text/javascript",n.onload=t,n.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},n.onerror=r,document.head.appendChild(n)})};async function importScripts(){for(var e=Array.prototype.slice.call(arguments),t=e.length,r=0;r<t;r++)await _importScript(e[r])}class Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__.a{constructor(e){super(e&&e.debug),this.config=e||{},this.peer_id=Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__.b)()}connect(){this.config.target_origin=this.config.target_origin||"*",window.addEventListener("message",this),this.emit({type:"initialized",config:this.config,origin:window.location.origin,peer_id:this.peer_id}),this._fire("connected")}handleEvent(e){"message"!==e.type||"*"!==this.config.target_origin&&e.origin!==this.config.target_origin||(e.data.peer_id===this.peer_id?this._fire(e.data.type,e.data):this.config.debug&&console.log(`connection peer id mismatch ${e.data.peer_id} !== ${this.peer_id}`))}disconnect(){this._fire("beforeDisconnect"),window.removeEventListener("message",this),this._fire("disconnected")}emit(e){let t;e.__transferables__&&(t=e.__transferables__,delete e.__transferables__),parent.postMessage(e,this.config.target_origin,t)}async execute(code){try{if("requirements"===code.type){if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{var link_node;if(code.requirements="string"==typeof code.requirements?[code.requirements]:code.requirements,!Array.isArray(code.requirements))throw"unsupported requirements definition";for(var i=0;i<code.requirements.length;i++)code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:")?(code.requirements[i].startsWith("css:")&&(code.requirements[i]=code.requirements[i].slice(4)),link_node=document.createElement("link"),link_node.rel="stylesheet",link_node.href=code.requirements[i],document.head.appendChild(link_node)):code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),await importScripts(code.requirements[i])):code.requirements[i].startsWith("http")?await importScripts(code.requirements[i]):code.requirements[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+code.requirements[i])}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}}else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(!code.content||code.attrs.type&&"text/javascript"!==code.attrs.type){var node=document.createElement("script");node.setAttribute("type",code.attrs.type),node.appendChild(document.createTextNode(code.content)),document.body.appendChild(node)}else eval(code.content);else if("style"===code.type){const e=document.createElement("style");code.src&&(e.src=code.src),e.innerHTML=code.content,document.head.appendChild(e)}else if("link"===code.type){const e=document.createElement("link");code.rel&&(e.rel=code.rel),code.href&&(e.href=code.href),code.attrs&&code.attrs.type&&(e.type=code.attrs.type),document.head.appendChild(e)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}parent.postMessage({type:"executed"},this.config.target_origin)}catch(e){console.error("failed to execute scripts: ",code,e),parent.postMessage({type:"executed",error:e.stack||String(e)},this.config.target_origin)}}}function setupIframe(e){(e=e||{}).dedicated_thread=!1,e.lang="javascript",e.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a;const t=new Connection(e);Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(t,e),t.connect()}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(1);function i(e,t){t=t||{};const r=new n.b(e,t);r.on("getInterface",(function(){s()})),r.on("remoteReady",(function(){const e=r.getRemote()||{};if(e.export)throw new Error("`export` is a reserved function name");if(e.onload)throw new Error("`onload` is a reserved function name");if(e.dispose)throw new Error("`dispose` is a reserved function name");e.export=function(e){r.setInterface(e)},e.onLoad=function(e){e=c(e),i?e():o.push(e)},e.dispose=function(e){r.disconnect()},"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"})):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));let i=!1;const o=[],s=function(){if(!i){let e;for(i=!0;e=o.pop();)e()}},c=function(e){const t=typeof e;if("function"!==t){throw new Error("A function may only be subsribed to the event, "+t+" was provided instead")}return e};return r}},function(e){e.exports=JSON.parse('{"a":"0.2.3"}')},function(e,t,r){e.exports=function(){return r(8)('!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t,r){"use strict";function n(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return i})),r.d(t,"a",(function(){return o}));const i={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"};class o{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const r=this._event_handlers[e].indexOf(t);r>=0&&this._event_handlers[e].splice(r,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var r=this._event_handlers[e].length;r--;){const n=this._event_handlers[e][r];try{n(t)}catch(e){console.error(e)}finally{n.___event_run_once&&this._event_handlers[e].splice(r,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return a}));var n=r(0);const i="0.2.1",o=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function s(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}class a extends n.a{constructor(e,t){super(t&&t.debug),this._connection=e,this.config=t||{},this._interface_store={},this._local_api=null;const r=this.config.name;this._connection.execute=this._connection.execute||function(){throw new Error(`connection.execute not implemented (in "${r}")`)},this._store=new c,this._method_refs=new c,this._method_refs.onReady(()=>{this._fire("remoteIdle")}),this._method_refs.onBusy(()=>{this._fire("remoteBusy")}),this._setupMessageHanlders()}init(){this._connection.emit({type:"initialized",config:this.config,peer_id:this._connection.peer_id})}getRemoteCallStack(){return this._method_refs.getStack()}getRemote(){return this._interface_store._rremote}setInterface(e){if(this.config.forwarding_functions)for(let t of this.config.forwarding_functions){const r=this._interface_store._rremote;r[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{r[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{r[t](...e)})))}this._local_api=e,this._fire("interfaceAvailable")}sendInterface(){if(!this._local_api)throw new Error("interface is not set.");this._local_api._rid="_rlocal";const e=this._encode(this._local_api,!0);this._connection.emit({type:"setInterface",api:e})}_setupMessageHanlders(){this._connection.on("init",this.init),this._connection.on("execute",e=>{Promise.resolve(this._connection.execute(e.code)).then(()=>{this._connection.emit({type:"executed"})}).catch(e=>{console.error(e),this._connection.emit({type:"executed",error:e})})}),this._connection.on("method",e=>{let t,r,n,i,o,s=this._interface_store[e.pid];const a=s.__this__||s;if(s)if(n=s[e.name],i=this._unwrap(e.args,!0),e.promise){[t,r]=this._unwrap(e.promise,!1);try{o=n.apply(a,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}catch(e){console.error(this.config.name,e,n),r(e)}}else try{n.apply(a,i)}catch(e){console.error(this.config.name,e,n,i)}else e.promise?([t,r]=this._unwrap(e.promise,!1),r(`plugin api function is not avaialbe in "${e.pid}", the plugin maybe terminated.`)):console.error(`plugin api function is not avaialbe in ${e.pid}, the plugin maybe terminated.`)}),this._connection.on("callback",e=>{let t,r,n,i,o;if(e.promise){[t,r]=this._unwrap(e.promise,!1);try{if(n=this._store.fetch(e._rindex),i=this._unwrap(e.args,!0),!n)throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");o=n.apply(null,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}catch(e){console.error(this.config.name,e,n),r(e)}}else try{if(n=this._store.fetch(e._rindex),i=this._unwrap(e.args,!0),!n)throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");n.apply(null,i)}catch(e){console.error(this.config.name,e,n,i)}}),this._connection.on("setInterface",e=>{this._setRemoteInterface(e.api)}),this._connection.on("getInterface",()=>{this._fire("getInterface"),this._local_api?this.sendInterface():this.once("interfaceAvailable",()=>{this.sendInterface()})}),this._connection.on("interfaceSetAsRemote",()=>{this._fire("interfaceSetAsRemote")}),this._connection.on("disconnect",()=>{this._fire("beforeDisconnect"),this._connection.disconnect(),this._fire("disconnected")})}requestRemote(){this._connection.emit({type:"getInterface"})}_ndarray(e,t,r){var i=n.c[e.constructor.name];if(r&&r!==i)throw"dtype doesn\'t match the type of the array: "+i+" != "+r;return{_rtype:"ndarray",_rvalue:e,_rshape:t=t||[e.length],_rdtype:i}}_setRemoteInterface(e){this._interface_store._rremote=this._decode(e),this._fire("remoteReady"),this._reportRemoteSet()}_genRemoteMethod(e,t){var r=this,n=function(){return new Promise((n,i)=>{let o=null;try{o=r._method_refs.put(t?t+"/"+e:e);var s=function(){return null!==o&&r._method_refs.fetch(o),n.apply(this,arguments)},a=function(){return null!==o&&r._method_refs.fetch(o),i.apply(this,arguments)};s.__jailed_pairs__=a,a.__jailed_pairs__=s;var c=Array.prototype.slice.call(arguments),_=(c="register"===e||"export"===e||"on"===e?r._wrap(c,!0):r._wrap(c)).args.__transferables__;_&&delete c.args.__transferables__,r._connection.emit({type:"method",name:e,pid:t,args:c,promise:r._wrap([s,a])},_)}catch(n){o&&r._method_refs.fetch(o),i(`Failed to exectue remote method (interface: ${t||r.id}, method: ${e}), error: ${n}`)}})};return n.__remote_method=!0,n}_reportRemoteSet(){this._connection.emit({type:"interfaceSetAsRemote"})}_encodeInterface(e){let t,r,i;const o={};if(e._rid=e._rid||Object(n.b)(),e.constructor===Object||Array.isArray(e))i=Object.keys(e);else{if(e.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(e.constructor.constructor!==Function)throw Error("Unsupported interface type");i=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e))}const s=Array.isArray(e)?[]:{};for(r of i)["hasOwnProperty","constructor"].includes(r)||r.startsWith("_")||(t=e[r],"function"==typeof t?(s[r]={_rtype:"interface",_rid:e._rid,_rvalue:r},o[r]=t):Object(t)!==t?(s[r]={_rtype:"argument",_rvalue:t},o[r]=t):"object"==typeof t&&(s[r]=this._encodeInterface(t)));return this._interface_store[e._rid]=o,e.on&&"function"==typeof e.on&&e.on("close",()=>{delete this._interface_store[e._rid]}),s}_encode(e,t){const r=[];if(!e)return e;const i=e._transfer;let s,a,c;const _=Array.isArray(e);if("object"==typeof e&&e._rtype&&e._rvalue)return e;if("object"==typeof e&&!Array.isArray(e)&&(e._rintf||t))return this._encodeInterface(e);for(c in t&&(e._rid=e._rid||Object(n.b)(),this._interface_store[e._rid]=this._interface_store[e._rid]||(_?[]:{})),s=_?[]:{},e)if(!["hasOwnProperty","constructor"].includes(c)&&(_||e.hasOwnProperty(c))){if(a=e[c],a&&"function"==typeof this._local_api._rpc_encode){const t=this._local_api._rpc_encode(a);if(t&&t._ctype){s[c]={_rtype:"custom",_rvalue:t,_rid:e._rid};continue}void 0!==t&&(a=t)}if("function"==typeof a){if(t){const t=this._interface_store[e._rid];s[c]={_rtype:"interface",_rid:e._rid,_rvalue:c},t[c]=a;continue}let r=null;for(var l in this._local_api)if(this._local_api.hasOwnProperty(l)){if(l.startsWith("_"))continue;if(this._local_api[l]===a){r=l;break}}for(var f=Object.getOwnPropertyNames(Object.getPrototypeOf(this._local_api)),u=0;u<f.length;u++){var d=f[u];if(!d.startsWith("_")&&this._local_api[d]===a){r=d;break}}if(r)s[c]={_rtype:"interface",_rvalue:r,_rid:"_rlocal"};else{var h=this._store.put(a);s[c]={_rtype:"callback",_rvalue:a.constructor&&a.constructor.name||h,_rindex:h}}}else if("undefined"!=typeof tf&&tf.Tensor&&a instanceof tf.Tensor){const e=a.dataSync();(a._transfer||i)&&(r.push(e.buffer),delete a._transfer),s[c]={_rtype:"ndarray",_rvalue:e,_rshape:a.shape,_rdtype:a.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&a instanceof nj.NdArray){var p=n.c[a.selection.data.constructor.name];(a._transfer||i)&&(r.push(a.selection.data.buffer),delete a._transfer),s[c]={_rtype:"ndarray",_rvalue:a.selection.data,_rshape:a.shape,_rdtype:p}}else if(a instanceof Error)console.error(a),s[c]={_rtype:"error",_rvalue:a.toString()};else if("undefined"!=typeof File&&a instanceof File)s[c]={_rtype:"file",_rvalue:a,_rrelative_path:a.relativePath||a.webkitRelativePath};else if(a!==Object(a)||a instanceof Boolean||a instanceof String||a instanceof Date||a instanceof RegExp||a instanceof Blob||a instanceof ImageData||"undefined"!=typeof FileList&&a instanceof FileList)s[c]={_rtype:"argument",_rvalue:a};else if(a instanceof ArrayBuffer)(a._transfer||i)&&(r.push(a),delete a._transfer),s[c]={_rtype:"argument",_rvalue:a};else if(a instanceof o)(a._transfer||i)&&(r.push(a.buffer),delete a._transfer),s[c]={_rtype:"argument",_rvalue:a};else if(a._rintf)s[c]=this._encode(a,!0);else{if("object"!=typeof a)throw"imjoy-rpc: Unsupported data type "+c+","+a;if(s[c]=this._encode(a,t),s[c].__transferables__){for(var y=0;y<s[c].__transferables__.length;y++)r.push(s[c].__transferables__[y]);delete s[c].__transferables__}}}return r.length>0&&(s.__transferables__=r),s}_decode(e,t,r){if(!e)return e;var n,i,o;if(e.hasOwnProperty("_rtype")&&e.hasOwnProperty("_rvalue")){if("custom"===e._rtype)e._rvalue&&"function"==typeof this._local_api._rpc_decode?void 0===(n=this._local_api._rpc_decode(e._rvalue))&&(n=e):n=e;else if("callback"===e._rtype)n=this._genRemoteCallback(t,e._rindex,r);else if("interface"===e._rtype){const t="_rlocal"===e._rid?"_rrmote":e._rid;n=this._interface_store[t]&&this._interface_store[t][e._rvalue]||this._genRemoteMethod(e._rvalue,e._rid)}else"ndarray"===e._rtype?"undefined"!=typeof nj&&nj.array?(Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(s)),n=nj.array(e._rvalue,e._rdtype).reshape(e._rshape)):"undefined"!=typeof tf&&tf.Tensor?(Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(s)),n=tf.tensor(e._rvalue,e._rshape,e._rdtype)):n=e:"error"===e._rtype?n=new Error(e._rvalue):"file"===e._rtype?(n=e._rvalue).relativePath=e._rrelative_path:"argument"===e._rtype&&(n=e._rvalue);return n}var a=Array.isArray(e);for(o in n=a?[]:{},e)(a||e.hasOwnProperty(o))&&("object"==typeof(i=e[o])||Array.isArray(i))&&(n[o]=this._decode(i,t,r));return n}_wrap(e,t){return{args:this._encode(e,t)}}_unwrap(e,t){return this._decode(e.args,e.callbackId,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise((r,i)=>{var o=n._wrap(Array.prototype.slice.call(arguments)),s=o.args.__transferables__;s&&delete o.args.__transferables__,r.__jailed_pairs__=i,i.__jailed_pairs__=r;try{n._connection.emit({type:"callback",id:e,_rindex:t,args:o,promise:n._wrap([r,i])},s)}catch(r){i(`Failed to exectue remote callback (id: ${e}, argNum: ${t}).`)}})}:function(){var r=n._wrap(Array.prototype.slice.call(arguments)),i=r.args.__transferables__;return i&&delete r.args.__transferables__,n._connection.emit({type:"callback",id:e,_rindex:t,args:r},i)}}disconnect(){this._connection.emit({type:"disconnect"}),setTimeout(()=>{this._connection.disconnect()},2e3)}}class c{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t,r,n=this._store[e];if(n&&!n.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),n&&n.__jailed_pairs__){const e=(t=this._store,r=n.__jailed_pairs__,Object.keys(t).find(e=>t[e]===r));this.fetch(e)}return n}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(1);function i(e,t){t=t||{};const r=new n.b(e,t);r.on("getInterface",(function(){s()})),r.on("remoteReady",(function(){const e=r.getRemote()||{};if(e.export)throw new Error("`export` is a reserved function name");if(e.onload)throw new Error("`onload` is a reserved function name");if(e.dispose)throw new Error("`dispose` is a reserved function name");e.export=function(e){r.setInterface(e)},e.onLoad=function(e){e=a(e),i?e():o.push(e)},e.dispose=function(e){r.disconnect()},"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"})):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));let i=!1;const o=[],s=function(){if(!i){let e;for(i=!0;e=o.pop();)e()}},a=function(e){const t=typeof e;if("function"!==t){throw new Error("A function may only be subsribed to the event, "+t+" was provided instead")}return e};return r}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0);!function(){if(!("undefined"!=typeof WorkerGlobalScope&&self&&self instanceof WorkerGlobalScope))throw new Error("This script can only loaded in a webworker");class Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__.a{constructor(e){super(e&&e.debug),this.config=e||{}}connect(){self.addEventListener("message",e=>{this._fire(e.data.type,e.data)}),this.emit({type:"initialized",config:this.config})}disconnect(){this._fire("beforeDisconnect"),self.close(),this._fire("disconnected")}emit(e){let t=void 0;e.__transferables__&&(t=e.__transferables__,delete e.__transferables__),self.postMessage(e,t)}async execute(code){if("requirements"===code.type)try{if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{Array.isArray(code.requirements)||(code.requirements=[code.requirements]);for(var i=0;i<code.requirements.length;i++){if(code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:"))throw"unable to import css in a webworker";code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),importScripts(code.requirements[i])):code.requirements[i].startsWith("http")?importScripts(code.requirements[i]):code.requirements[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+code.requirements[i])}}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}}catch(e){throw e}else{if("script"!==code.type)throw"unsupported code type.";try{if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{if(Array.isArray(code.requirements))for(let e=0;e<code.requirements.length;e++)importScripts(code.requirements[e]);else importScripts(code.requirements)}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}}"requirements"===code.type&&self.postMessage({type:"cacheRequirements",requirements:code.requirements})}}const config={type:"web-worker",dedicated_thread:!0,allow_execution:!0,lang:"javascript",api_version:_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a},conn=new Connection(config);conn.on("connectRPC",e=>{Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(conn,Object.assign(e.config,config))}),conn.connect(),self.postMessage({type:"worker-ready"})}()}]);\n//# sourceMappingURL=plugin.webworker.js.map',null)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return setupWebPython}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_pluginIframe__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(2);function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}const _importScript=function(e){return new Promise((t,r)=>{var n=document.createElement("script");n.src=e,n.onload=t,n.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},n.onerror=r,document.head.appendChild(n)})};async function importScripts(){for(var e=Array.prototype.slice.call(arguments),t=e.length,r=0;r<t;r++)await _importScript(e[r])}const startup_script='\nfrom js import api\nimport sys\nfrom types import ModuleType\nm = ModuleType("imjoy")\nsys.modules[m.__name__] = m\nm.__file__ = m.__name__ + ".py"\nm.api = api\n';let _export_plugin_api=null;const execute_python_code=function(e){try{_export_plugin_api||(_export_plugin_api=window.api.export,window.api.export=function(e){if("object"==typeof e){const t={};for(let r in e)r.startsWith("_")||(t[r]=e[r]);_export_plugin_api(t)}else{if("function"!=typeof e)throw"unsupported api export";{const t={},r=window.pyodide.pyimport("getattr"),n=window.pyodide.pyimport("hasattr");for(let i of Object.getOwnPropertyNames(e))if(!i.startsWith("_")&&n(e,i)){const n=r(e,i);t[i]=function(){return n(...Array.prototype.slice.call(arguments))}}_export_plugin_api(t)}}}),window.pyodide.runPython(startup_script),window.pyodide.runPython(e.content)}catch(e){throw e}};function setupPyodide(){return new Promise((e,t)=>{window.languagePluginUrl="https://static.imjoy.io/pyodide/",importScripts("https://static.imjoy.io/pyodide/pyodide.js").then(()=>{window.iodide={output:{element:function(e){const t=document.createElement(e);return(document.getElementById("output")||document.body).appendChild(t),t}}},window.languagePluginLoader.then(()=>{console.log(window.pyodide.runPython("import sys\nsys.version")),e()}).catch(t)})})}class Connection extends _pluginIframe__WEBPACK_IMPORTED_MODULE_2__.a{constructor(e){super(e)}async execute(code){if("requirements"===code.type){if(code.requirements){if(code.requirements="string"==typeof code.requirements?[code.requirements]:code.requirements,!Array.isArray(code.requirements))throw"unsupported requirements definition";{const e=[];for(var i=0;i<code.requirements.length;i++)code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:")?(code.requirements[i].startsWith("css:")&&(code.requirements[i]=code.requirements[i].slice(4)),link_node=document.createElement("link"),link_node.rel="stylesheet",link_node.href=code.requirements[i],document.head.appendChild(link_node)):code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),await importScripts(code.requirements[i])):code.requirements[i].startsWith("cache:")||(code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("package:")?(code.requirements[i].startsWith("package:")&&(code.requirements[i]=code.requirements[i].slice(8)),e.push(code.requirements[i])):code.requirements[i].startsWith("http:")||code.requirements[i].startsWith("https:")?console.log("Unprocessed requirements url: "+code.requirements[i]):e.push(code.requirements[i]));await window.pyodide.loadPackage(e)}}}else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(code.content&&"python"===code.lang)execute_python_code(code);else if(code.content&&"javascript"===code.lang)try{eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}else{const e=document.createElement("script");e.setAttribute("type",code.attrs.type),e.appendChild(document.createTextNode(code.content)),document.body.appendChild(e)}else if("style"===code.type){const e=document.createElement("style");code.src&&(e.src=code.src),e.innerHTML=code.content,document.head.appendChild(e)}else if("link"===code.type){const e=document.createElement("link");code.rel&&(e.rel=code.rel),code.href&&(e.href=code.href),code.attrs&&code.attrs.type&&(e.type=code.attrs.type),document.head.appendChild(e)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}}}function setupWebPython(e){(e=e||{}).debug=!0,e.dedicated_thread=!1,e.lang="python",e.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a;const t=new Connection(e);setupPyodide().then(()=>{Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(t,e),t.connect()})}},function(e,t,r){"use strict";r.r(t),r.d(t,"waitForInitialization",(function(){return d})),r.d(t,"setupRPC",(function(){return l}));var n=r(5),i=r.n(n),o=r(2),s=r(6),c=r(0),a=r(1);r.d(t,"RPC",(function(){return a.b})),r.d(t,"API_VERSION",(function(){return a.a}));var _=r(4);function d(e){const t=(e=e||{}).target_origin||"*";if(e.credential_required&&"function"!=typeof e.verify_credential)throw new Error("Please also provide the `verify_credential` function with `credential_required`.");if(e.credential_required&&"*"===t)throw new Error("`target_origin` was set to `*` with `credential_required=true`, there is a security risk that you may leak the credential to website from other origin. Please specify the `target_origin` explicitly.");const r=n=>{if("message"===n.type&&("*"===t||n.origin===t)){if("initialize"!==n.data.type)throw new Error(`invalid command: ${n.data.cmd}`);{window.removeEventListener("message",r);const i=n.data.config;"*"!==t&&(i.target_origin=t),e.credential_required?e.verify_credential(i.credential).then(e=>{if(!e||!e.auth||e.error)throw new Error("Failed to verify the credentail:"+(e&&e.error));i.auth=e.auth,l(i).then(()=>{console.log("ImJoy RPC loaded successfully!")})}):l(i).then(()=>{console.log("ImJoy RPC loaded successfully!")})}}};window.addEventListener("message",r),parent.postMessage({type:"imjoyRPCReady",config:e},"*")}function l(e){if(!(e=e||{}).name)throw new Error("Please specify a name for your app.");return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||Object(c.b)(),e.allow_execution=e.allow_execution||!1,e.enable_service_worker&&Object(c.c)(e.target_origin,e.cache_requirements),e.cache_requirements&&delete e.cache_requirements,e=Object.keys(e).reduce((t,r)=>("function"!=typeof e[r]&&(t[r]=e[r]),t),{}),new Promise((t,r)=>{if(function(){try{return window.self!==window.top}catch(e){return!0}}()){if("web-worker"===e.type)try{!function(e){if(!e.allow_execution)throw new Error("web-worker plugin can only work with allow_execution=true");const t=new i.a,r=setTimeout((function(){t.terminate(),console.warn("Plugin failed to start as a web-worker, running in an iframe instead."),Object(o.b)(e)}),2e3),n=Object(c.b)();t.addEventListener("message",(function(i){let o=void 0;const s=i.data;if("worker-ready"===s.type)return t.postMessage({type:"connectRPC",config:e}),void clearTimeout(r);"initialized"===s.type?(s.config=Object.assign({},e,s.config),s.origin=window.location.origin,s.peer_id=n):"imjoy_remote_api_ready"===s.type?window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:null})):"cacheRequirements"===s.type&&"function"==typeof cache_requirements?cache_requirements(s.requirements):"disconnect"===s.type?t.terminate():s.__transferables__&&(o=s.__transferables__,delete s.__transferables__),parent.postMessage(s,e.target_origin||"*",o)})),window.addEventListener("message",(function(r){let i=void 0;const o=r.data;o.__transferables__&&(i=o.__transferables__,delete o.__transferables__),o.peer_id===n?t.postMessage(o,i):e.debug&&console.log(`connection peer id mismatch ${o.peer_id} !== ${n}`)}))}(e)}catch(t){Object(o.b)(e)}else"web-python"===e.type||"web-python-window"===e.type?Object(s.a)(e):["rpc-window","rpc-worker","iframe","window"].includes(e.type)?Object(o.b)(e):(console.error("Unsupported plugin type: "+e.type),r("Unsupported plugin type: "+e.type));try{const r=n=>{const i=n.detail;e.expose_api_globally&&(window.api=i),t(i),window.removeEventListener("imjoy_remote_api_ready",r)};window.addEventListener("imjoy_remote_api_ready",r)}catch(e){r(e)}}else r(new Error("imjoy-rpc should only run inside an iframe."))})}r.d(t,"VERSION",(function(){return _.a}))},function(e,t,r){"use strict";var n=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var r;try{(r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),r=r.getBlob()}catch(t){r=new Blob([e])}return new Worker(n.createObjectURL(r))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}}])}));
//# sourceMappingURL=imjoy-rpc.min.js.map