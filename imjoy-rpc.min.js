!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("imjoyRPC",[],t):"object"==typeof exports?exports.imjoyRPC=t():e.imjoyRPC=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return a}));var n=r(1);const i="0.2.0",o=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function s(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}class a{constructor(e,t){this._connection=e,this.config=t||{},this._interface={},this._plugin_interfaces={},this._remote=null,this._remoteUpdateHandler=function(){},this._getInterfaceHandler=function(){},this._interfaceSetAsRemoteHandler=null,this._disconnectHandler=function(){},this._store=new _,this._method_refs=new _,this._connection=e;let r=this;this._connection.onMessage((function(e){r._processMessage(e)}))}onRemoteUpdate(e){this._remoteUpdateHandler=e}onRemoteReady(e){this._method_refs.onReady(e)}onRemoteBusy(e){this._method_refs.onBusy(e)}getRemoteCallStack(){return this._method_refs.getStack()}onGetInterface(e){this._getInterfaceHandler=e}getRemote(){return this._remote}setInterface(e){if(this.config.forwarding_functions)for(let t of this.config.forwarding_functions)this._remote[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{this._remote[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{this._remote[t](...e)})));this._interface=e}sendInterface(){return new Promise(e=>{var t=[];if(!this._interface)throw new Error("interface is not set.");if(this._interface.constructor===Object){for(var r of Object.keys(this._interface))if(!r.startsWith("_"))if("function"==typeof this._interface[r])t.push({name:r,data:null,type:"function"});else{var n=this._interface[r];if(null!==n&&"object"==typeof n){var i={};for(var o of Object.keys(n))"function"==typeof n[o]?i[o]="rpc_method::"+o:i[o]=n[o];t.push({name:r,data:i,type:"object"})}else Object(n)!==n&&t.push({name:r,data:n,type:"data"})}}else{if(this._interface.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(this._interface.constructor.constructor!==Function)throw Error("Unsupported interface type");for(var s=Object.getOwnPropertyNames(Object.getPrototypeOf(this._interface)).concat(Object.keys(this._interface)),a=0;a<s.length;a++){var _=s[a];_.startsWith("_")||"constructor"===_||"function"==typeof this._interface[_]&&t.push({name:_,data:null})}}this._interfaceSetAsRemoteHandler=e,this._connection.send({type:"setInterface",api:t})})}_processMessage(e){var t,r,n,i,o;switch(e.type){case"method":var s=this._interface,a=s.__this__||s;if(e.pid&&!(s=this._plugin_interfaces[e.pid]))return void(e.promise?([t,r]=this._unwrap(e.promise,!1),r(`plugin api function is not avaialbe in "${e.pid}", the plugin maybe terminated.`)):console.error(`plugin api function is not avaialbe in ${e.pid}, the plugin maybe terminated.`));if(-1!==e.name.indexOf(".")){var _=e.name.split(".");n=s[_[0]][_[1]]}else n=s[e.name];if(i=this._unwrap(e.args,!0),e.promise){[t,r]=this._unwrap(e.promise,!1);try{(o=n.apply(a,i))instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}catch(e){console.error(e,n),r(e)}}else try{n.apply(a,i)}catch(e){console.error(e,n,i)}break;case"callback":if(e.promise){[t,r]=this._unwrap(e.promise,!1);try{if(n=this._store.fetch(e.num),i=this._unwrap(e.args,!0),!n)throw"Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.";(o=n.apply(null,i))instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}catch(e){console.error(e,n),r(e)}}else try{if(n=this._store.fetch(e.num),i=this._unwrap(e.args,!0),!n)throw"Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.";n.apply(null,i)}catch(e){console.error(e,n,i)}break;case"setInterface":this._setRemote(e.api);break;case"getInterface":this.sendInterface(),this._getInterfaceHandler();break;case"interfaceSetAsRemote":"function"==typeof this._interfaceSetAsRemoteHandler&&(this._interfaceSetAsRemoteHandler(),this._interfaceSetAsRemoteHandler);break;case"disconnect":this._disconnectHandler(),this._connection.disconnect()}}requestRemote(){this._connection.send({type:"getInterface"})}_ndarray(e,t,r){var i=n.c[e.constructor.name];if(r&&r!==i)throw"dtype doesn't match the type of the array: "+i+" != "+r;return{__jailed_type__:"ndarray",__value__:e,__shape__:t=t||[e.length],__dtype__:i}}_setRemote(e){var t,r,n;for(this._remote={},t=0;t<e.length;t++)if(r=e[t].name,n=e[t].data,"data"===e[t].type)this._remote[r]=n;else if(n)if("object"==typeof n){var i={};for(var o in n)n.hasOwnProperty(o)&&(n[o]==="rpc_method::"+o?i[o]=this._genRemoteMethod(r+"."+o):i[o]=n[o]);this._remote[r]=i}else this._remote[r]=n;else this._remote[r]=this._genRemoteMethod(r);this._remoteUpdateHandler(),this._reportRemoteSet()}_genRemoteMethod(e,t){var r=this,n=function(){return new Promise((n,i)=>{let o=null;try{o=r._method_refs.put(t?t+"/"+e:e);var s=function(){return null!==o&&r._method_refs.fetch(o),n.apply(this,arguments)},a=function(){return null!==o&&r._method_refs.fetch(o),i.apply(this,arguments)};s.__jailed_pairs__=a,a.__jailed_pairs__=s;var _=Array.prototype.slice.call(arguments),c=(_="register"===e||"export"===e||"on"===e?r._wrap(_,!0):r._wrap(_)).args.__transferables__;c&&delete _.args.__transferables__,r._connection.send({type:"method",name:e,pid:t,args:_,promise:r._wrap([s,a])},c)}catch(n){o&&r._method_refs.fetch(o),i(`Failed to exectue remote method (plugin: ${t||r.id}, method: ${e}), error: ${n}`)}})};return n.__remote_method=!0,n}_reportRemoteSet(){this._connection.send({type:"interfaceSetAsRemote"})}_encode_interface(e,t){var r,i;const o={};for(i in e.__id__=e.__id__||Object(n.a)(),e)if("hasOwnProperty"!==i&&e.hasOwnProperty(i)){if(i.startsWith("_"))continue;"function"==typeof(r=e[i])?(t[i]={__jailed_type__:"plugin_interface",__plugin_id__:e.__id__,__value__:i,num:null},o[i]=r):Object(r)!==r?(t[i]={__jailed_type__:"argument",__value__:r},o[i]=r):"object"==typeof r&&(t[i]=Array.isArray(r)?[]:{},this._encode_interface(r,t[i]))}this._plugin_interfaces[e.__id__]=o,e.on&&e.on("close",()=>{delete this._plugin_interfaces[e.__id__]})}_encode(e,t){var r=[];if(!e)return e;var i,s,a,_=e._transfer,c=Array.isArray(e);if(i=c?[]:{},"object"==typeof e&&e.__jailed_type__&&e.__value__)return e;if("object"==typeof e&&!Array.isArray(e)&&(e.__as_interface__||t))return this._encode_interface(e,i),i;for(a in t&&(e.__id__=e.__id__||Object(n.a)(),this._plugin_interfaces[e.__id__]=this._plugin_interfaces[e.__id__]||{}),e)if("hasOwnProperty"!==a&&(c||e.hasOwnProperty(a))){if(s=e[a],"function"==typeof this._interface._rpcEncode){const e=this._interface._rpcEncode(s);if(e&&e.__rpc_dtype__){i[a]={__jailed_type__:"custom_encoding",__value__:e};continue}s=e}if("function"==typeof s){if(t){const t=this._plugin_interfaces[e.__id__];i[a]={__jailed_type__:"plugin_interface",__plugin_id__:e.__id__,__value__:a,num:null},t[a]=s;continue}let r=null;for(var d in this._interface)if(this._interface.hasOwnProperty(d)){if(d.startsWith("_"))continue;if(this._interface[d]===s){r=d;break}}for(var u=Object.getOwnPropertyNames(Object.getPrototypeOf(this._interface)),l=0;l<u.length;l++){var f=u[l];if(!f.startsWith("_")&&this._interface[f]===s){r=f;break}}if(r)i[a]={__jailed_type__:"interface",__value__:r,num:null};else{var p=this._store.put(s);i[a]={__jailed_type__:"callback",__value__:s.constructor&&s.constructor.name||p,num:p}}}else if("undefined"!=typeof tf&&tf.Tensor&&s instanceof tf.Tensor){const e=s.dataSync();(s._transfer||_)&&(r.push(e.buffer),delete s._transfer),i[a]={__jailed_type__:"ndarray",__value__:e,__shape__:s.shape,__dtype__:s.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&s instanceof nj.NdArray){var h=n.c[s.selection.data.constructor.name];(s._transfer||_)&&(r.push(s.selection.data.buffer),delete s._transfer),i[a]={__jailed_type__:"ndarray",__value__:s.selection.data,__shape__:s.shape,__dtype__:h}}else if(s instanceof Error)console.error(s),i[a]={__jailed_type__:"error",__value__:s.toString()};else if("undefined"!=typeof File&&s instanceof File)i[a]={__jailed_type__:"file",__value__:s,__relative_path__:s.relativePath||s.webkitRelativePath};else if(s!==Object(s)||s instanceof Boolean||s instanceof String||s instanceof Date||s instanceof RegExp||s instanceof Blob||s instanceof ImageData||"undefined"!=typeof FileList&&s instanceof FileList)i[a]={__jailed_type__:"argument",__value__:s};else if(s instanceof ArrayBuffer)(s._transfer||_)&&(r.push(s),delete s._transfer),i[a]={__jailed_type__:"argument",__value__:s};else if(s instanceof o)(s._transfer||_)&&(r.push(s.buffer),delete s._transfer),i[a]={__jailed_type__:"argument",__value__:s};else if(s.__as_interface__)i[a]=this._encode(s,!0);else{if("object"!=typeof s&&!Array.isArray(s))throw"object"==typeof s&&s.constructor?"Unsupported data type for transferring between the plugin and the main app: "+a+" : "+s.constructor.name:"Unsupported data type for transferring between the plugin and the main app: "+a+","+s;if(i[a]=this._encode(s,t),i[a].__transferables__){for(var y=0;y<i[a].__transferables__.length;y++)r.push(i[a].__transferables__[y]);delete i[a].__transferables__}}}return r.length>0&&(i.__transferables__=r),i}_decode(e,t,r){if(!e)return e;var n,i,o;if(e.hasOwnProperty("__jailed_type__")&&e.hasOwnProperty("__value__")){if(e.__jailed_type__.startsWith("custom_encoding"))if("function"==typeof this._interface._rpcDecode){n=this._interface._rpcDecode(e.__value__)}else n=e;else"callback"===e.__jailed_type__?n=this._genRemoteCallback(t,e.num,r):"interface"===e.__jailed_type__?n=this._remote[e.__value__]||this._genRemoteMethod(e.__value__):"plugin_interface"===e.__jailed_type__?n=this._genRemoteMethod(e.__value__,e.__plugin_id__):"ndarray"===e.__jailed_type__?"__plugin__"===this.id&&"undefined"!=typeof nj&&nj.array?(Array.isArray(e.__value__)&&(e.__value__=e.__value__.reduce(s)),n=nj.array(e.__value__,e.__dtype__).reshape(e.__shape__)):"__plugin__"===this.id&&"undefined"!=typeof tf&&tf.Tensor?(Array.isArray(e.__value__)&&(e.__value__=e.__value__.reduce(s)),n=tf.tensor(e.__value__,e.__shape__,e.__dtype__)):n=e:"error"===e.__jailed_type__?n=new Error(e.__value__):"file"===e.__jailed_type__?(n=e.__value__).relativePath=e.__relative_path__:"argument"===e.__jailed_type__&&(n=e.__value__);return n}var a=Array.isArray(e);for(o in n=a?[]:{},e)(a||e.hasOwnProperty(o))&&("object"==typeof(i=e[o])||Array.isArray(i))&&(n[o]=this._decode(i,t,r));return n}_wrap(e,t){return{args:this._encode(e,t)}}_unwrap(e,t){return this._decode(e.args,e.callbackId,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise((r,i)=>{var o=n._wrap(Array.prototype.slice.call(arguments)),s=o.args.__transferables__;s&&delete o.args.__transferables__,r.__jailed_pairs__=i,i.__jailed_pairs__=r;try{n._connection.send({type:"callback",id:e,num:t,args:o,promise:n._wrap([r,i])},s)}catch(r){i(`Failed to exectue remote callback (id: ${e}, argNum: ${t}).`)}})}:function(){var r=n._wrap(Array.prototype.slice.call(arguments)),i=r.args.__transferables__;return i&&delete r.args.__transferables__,n._connection.send({type:"callback",id:e,num:t,args:r},i)}}disconnect(){this._connection.send({type:"disconnect"}),setTimeout(this._connection.disconnect,2e3)}onDisconnect(e){this._disconnectHandler=e}}class _{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t,r,n=this._store[e];if(n&&!n.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),n&&n.__jailed_pairs__){const e=(t=this._store,r=n.__jailed_pairs__,Object.keys(t).find(e=>t[e]===r));this.fetch(e)}return n}}},function(e,t,r){"use strict";function n(){return Math.random().toString(36).substr(2,10)}r.d(t,"a",(function(){return n})),r.d(t,"c",(function(){return i})),r.d(t,"b",(function(){return a}));const i={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"};function o(e){return new Promise((function(t,r){const n={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void r("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?r(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(n,[i.port2]):r("Service worker controller is not available")}))}async function s(e){if(e&&e.length>0)for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await o(t).catch(e=>{console.error(e)})}function a(e,t){"serviceWorker"in navigator&&window.addEventListener("load",(function(){if(navigator.serviceWorker.register("/plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),e=e||"*",(t=t||s)&&"function"!=typeof t)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(r){if("*"===e||r.origin===e){const e=r.data;"cacheRequirements"===e.type&&t(e.requirements)}}))}))}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(0);function i(e,t){const r={};t=t||{};const i=new n.b(e,t);i.onGetInterface((function(){a()})),i.onRemoteUpdate((function(){if(r.remote=i.getRemote(),!r.remote)return;const e=r.remote||{};e.export&&console.error("WARNING: overwriting function 'export'."),e.onload&&console.error("WARNING: overwriting function 'onload'."),e.dispose&&console.error("WARNING: overwriting function 'dispose'."),e.export=r.setInterface,e.onLoad=r.whenConnected,e.dispose=r.disconnect,"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"})):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));var o=!1,s=[],a=function(){var e;if(!o)for(o=!0;e=s.pop();)e()};r.whenConnected=function(e){e=function(e){var t=typeof e;if("function"!==t)throw new Error("A function may only be subsribed to the event, "+t+" was provided instead");return e}(e),o?e():s.push(e)},r.setInterface=function(e){i.setInterface(e)},r.disconnect=function(e){i.disconnect()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return setupIframe}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0);function setupIframe(config){config=config||{};const targetOrigin=config.target_origin||"*";function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}var _importScript=function(e){return new Promise((t,r)=>{var n=document.createElement("script");n.src=e,n.type="text/javascript",n.onload=t,n.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},n.onerror=r,document.head.appendChild(n)})};async function importScripts(){for(var e=Array.prototype.slice.call(arguments),t=e.length,r=0;r<t;r++)await _importScript(e[r])}var execute=async function(code){try{if("requirements"===code.type){if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{var link_node;if(code.requirements="string"==typeof code.requirements?[code.requirements]:code.requirements,!Array.isArray(code.requirements))throw"unsupported requirements definition";for(var i=0;i<code.requirements.length;i++)code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:")?(code.requirements[i].startsWith("css:")&&(code.requirements[i]=code.requirements[i].slice(4)),link_node=document.createElement("link"),link_node.rel="stylesheet",link_node.href=code.requirements[i],document.head.appendChild(link_node)):code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),await importScripts(code.requirements[i])):code.requirements[i].startsWith("http")?await importScripts(code.requirements[i]):code.requirements[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+code.requirements[i])}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}}else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(!code.content||code.attrs.type&&"text/javascript"!==code.attrs.type){var node=document.createElement("script");node.setAttribute("type",code.attrs.type),node.appendChild(document.createTextNode(code.content)),document.body.appendChild(node)}else eval(code.content);else if("style"===code.type){var style_node=document.createElement("style");code.src&&(style_node.src=code.src),style_node.innerHTML=code.content,document.head.appendChild(style_node)}else if("link"===code.type){var link_node_=document.createElement("link");code.rel&&(link_node_.rel=code.rel),code.href&&(link_node_.href=code.href),code.attrs&&code.attrs.type&&(link_node_.type=code.attrs.type),document.head.appendChild(link_node_)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}parent.postMessage({type:"executeSuccess"},targetOrigin)}catch(e){console.error("failed to execute scripts: ",code,e),parent.postMessage({type:"executeFailure",error:e.stack||String(e)},targetOrigin)}};const conn={disconnect:function(){},send:function(e,t){parent.postMessage(e,targetOrigin,t)},onMessage:function(e){conn._messageHandler=e},_messageHandler:function(){},onDisconnect:function(){}};config.dedicated_thread=!1,config.lang="javascript",config.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a,window.addEventListener("message",(function(e){if("*"===targetOrigin||e.origin===targetOrigin){const t=e.data;switch(t&&t.type){case"getConfig":parent.postMessage({type:"config",config:config},targetOrigin);break;case"execute":config.allow_execution?(execute(t.code),"requirements"===t.code.type&&(Array.isArray(t.code.requirements)||(t.code.requirements=[t.code.requirements]))):console.warn("import script is not allowed (allow_execution=false)");break;default:conn._messageHandler(t)}}})),Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(conn,{forwarding_functions:config.forwarding_functions}),parent.postMessage({type:"initialized",config:config},targetOrigin)}},function(e){e.exports=JSON.parse('{"a":"0.1.17"}')},function(e,t,r){e.exports=function(){return r(8)('!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t,r){"use strict";function n(){return Math.random().toString(36).substr(2,10)}const i={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"};r.d(t,"a",(function(){return _})),r.d(t,"b",(function(){return a}));const _="0.2.0",o=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function s(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}class a{constructor(e,t){this._connection=e,this.config=t||{},this._interface={},this._plugin_interfaces={},this._remote=null,this._remoteUpdateHandler=function(){},this._getInterfaceHandler=function(){},this._interfaceSetAsRemoteHandler=null,this._disconnectHandler=function(){},this._store=new c,this._method_refs=new c,this._connection=e;let r=this;this._connection.onMessage((function(e){r._processMessage(e)}))}onRemoteUpdate(e){this._remoteUpdateHandler=e}onRemoteReady(e){this._method_refs.onReady(e)}onRemoteBusy(e){this._method_refs.onBusy(e)}getRemoteCallStack(){return this._method_refs.getStack()}onGetInterface(e){this._getInterfaceHandler=e}getRemote(){return this._remote}setInterface(e){if(this.config.forwarding_functions)for(let t of this.config.forwarding_functions)this._remote[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{this._remote[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{this._remote[t](...e)})));this._interface=e}sendInterface(){return new Promise(e=>{var t=[];if(!this._interface)throw new Error("interface is not set.");if(this._interface.constructor===Object){for(var r of Object.keys(this._interface))if(!r.startsWith("_"))if("function"==typeof this._interface[r])t.push({name:r,data:null,type:"function"});else{var n=this._interface[r];if(null!==n&&"object"==typeof n){var i={};for(var _ of Object.keys(n))"function"==typeof n[_]?i[_]="rpc_method::"+_:i[_]=n[_];t.push({name:r,data:i,type:"object"})}else Object(n)!==n&&t.push({name:r,data:n,type:"data"})}}else{if(this._interface.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(this._interface.constructor.constructor!==Function)throw Error("Unsupported interface type");for(var o=Object.getOwnPropertyNames(Object.getPrototypeOf(this._interface)).concat(Object.keys(this._interface)),s=0;s<o.length;s++){var a=o[s];a.startsWith("_")||"constructor"===a||"function"==typeof this._interface[a]&&t.push({name:a,data:null})}}this._interfaceSetAsRemoteHandler=e,this._connection.send({type:"setInterface",api:t})})}_processMessage(e){var t,r,n,i,_;switch(e.type){case"method":var o=this._interface,s=o.__this__||o;if(e.pid&&!(o=this._plugin_interfaces[e.pid]))return void(e.promise?([t,r]=this._unwrap(e.promise,!1),r(`plugin api function is not avaialbe in "${e.pid}", the plugin maybe terminated.`)):console.error(`plugin api function is not avaialbe in ${e.pid}, the plugin maybe terminated.`));if(-1!==e.name.indexOf(".")){var a=e.name.split(".");n=o[a[0]][a[1]]}else n=o[e.name];if(i=this._unwrap(e.args,!0),e.promise){[t,r]=this._unwrap(e.promise,!1);try{(_=n.apply(s,i))instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?_.then(t).catch(r):t(_)}catch(e){console.error(e,n),r(e)}}else try{n.apply(s,i)}catch(e){console.error(e,n,i)}break;case"callback":if(e.promise){[t,r]=this._unwrap(e.promise,!1);try{if(n=this._store.fetch(e.num),i=this._unwrap(e.args,!0),!n)throw"Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.";(_=n.apply(null,i))instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?_.then(t).catch(r):t(_)}catch(e){console.error(e,n),r(e)}}else try{if(n=this._store.fetch(e.num),i=this._unwrap(e.args,!0),!n)throw"Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.";n.apply(null,i)}catch(e){console.error(e,n,i)}break;case"setInterface":this._setRemote(e.api);break;case"getInterface":this.sendInterface(),this._getInterfaceHandler();break;case"interfaceSetAsRemote":"function"==typeof this._interfaceSetAsRemoteHandler&&(this._interfaceSetAsRemoteHandler(),this._interfaceSetAsRemoteHandler);break;case"disconnect":this._disconnectHandler(),this._connection.disconnect()}}requestRemote(){this._connection.send({type:"getInterface"})}_ndarray(e,t,r){var n=i[e.constructor.name];if(r&&r!==n)throw"dtype doesn\'t match the type of the array: "+n+" != "+r;return{__jailed_type__:"ndarray",__value__:e,__shape__:t=t||[e.length],__dtype__:n}}_setRemote(e){var t,r,n;for(this._remote={},t=0;t<e.length;t++)if(r=e[t].name,n=e[t].data,"data"===e[t].type)this._remote[r]=n;else if(n)if("object"==typeof n){var i={};for(var _ in n)n.hasOwnProperty(_)&&(n[_]==="rpc_method::"+_?i[_]=this._genRemoteMethod(r+"."+_):i[_]=n[_]);this._remote[r]=i}else this._remote[r]=n;else this._remote[r]=this._genRemoteMethod(r);this._remoteUpdateHandler(),this._reportRemoteSet()}_genRemoteMethod(e,t){var r=this,n=function(){return new Promise((n,i)=>{let _=null;try{_=r._method_refs.put(t?t+"/"+e:e);var o=function(){return null!==_&&r._method_refs.fetch(_),n.apply(this,arguments)},s=function(){return null!==_&&r._method_refs.fetch(_),i.apply(this,arguments)};o.__jailed_pairs__=s,s.__jailed_pairs__=o;var a=Array.prototype.slice.call(arguments),c=(a="register"===e||"export"===e||"on"===e?r._wrap(a,!0):r._wrap(a)).args.__transferables__;c&&delete a.args.__transferables__,r._connection.send({type:"method",name:e,pid:t,args:a,promise:r._wrap([o,s])},c)}catch(n){_&&r._method_refs.fetch(_),i(`Failed to exectue remote method (plugin: ${t||r.id}, method: ${e}), error: ${n}`)}})};return n.__remote_method=!0,n}_reportRemoteSet(){this._connection.send({type:"interfaceSetAsRemote"})}_encode_interface(e,t){var r,i;const _={};for(i in e.__id__=e.__id__||n(),e)if("hasOwnProperty"!==i&&e.hasOwnProperty(i)){if(i.startsWith("_"))continue;"function"==typeof(r=e[i])?(t[i]={__jailed_type__:"plugin_interface",__plugin_id__:e.__id__,__value__:i,num:null},_[i]=r):Object(r)!==r?(t[i]={__jailed_type__:"argument",__value__:r},_[i]=r):"object"==typeof r&&(t[i]=Array.isArray(r)?[]:{},this._encode_interface(r,t[i]))}this._plugin_interfaces[e.__id__]=_,e.on&&e.on("close",()=>{delete this._plugin_interfaces[e.__id__]})}_encode(e,t){var r=[];if(!e)return e;var _,s,a,c=e._transfer,f=Array.isArray(e);if(_=f?[]:{},"object"==typeof e&&e.__jailed_type__&&e.__value__)return e;if("object"==typeof e&&!Array.isArray(e)&&(e.__as_interface__||t))return this._encode_interface(e,_),_;for(a in t&&(e.__id__=e.__id__||n(),this._plugin_interfaces[e.__id__]=this._plugin_interfaces[e.__id__]||{}),e)if("hasOwnProperty"!==a&&(f||e.hasOwnProperty(a))){if(s=e[a],"function"==typeof this._interface._rpcEncode){const e=this._interface._rpcEncode(s);if(e&&e.__rpc_dtype__){_[a]={__jailed_type__:"custom_encoding",__value__:e};continue}s=e}if("function"==typeof s){if(t){const t=this._plugin_interfaces[e.__id__];_[a]={__jailed_type__:"plugin_interface",__plugin_id__:e.__id__,__value__:a,num:null},t[a]=s;continue}let r=null;for(var l in this._interface)if(this._interface.hasOwnProperty(l)){if(l.startsWith("_"))continue;if(this._interface[l]===s){r=l;break}}for(var u=Object.getOwnPropertyNames(Object.getPrototypeOf(this._interface)),d=0;d<u.length;d++){var p=u[d];if(!p.startsWith("_")&&this._interface[p]===s){r=p;break}}if(r)_[a]={__jailed_type__:"interface",__value__:r,num:null};else{var h=this._store.put(s);_[a]={__jailed_type__:"callback",__value__:s.constructor&&s.constructor.name||h,num:h}}}else if("undefined"!=typeof tf&&tf.Tensor&&s instanceof tf.Tensor){const e=s.dataSync();(s._transfer||c)&&(r.push(e.buffer),delete s._transfer),_[a]={__jailed_type__:"ndarray",__value__:e,__shape__:s.shape,__dtype__:s.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&s instanceof nj.NdArray){var y=i[s.selection.data.constructor.name];(s._transfer||c)&&(r.push(s.selection.data.buffer),delete s._transfer),_[a]={__jailed_type__:"ndarray",__value__:s.selection.data,__shape__:s.shape,__dtype__:y}}else if(s instanceof Error)console.error(s),_[a]={__jailed_type__:"error",__value__:s.toString()};else if("undefined"!=typeof File&&s instanceof File)_[a]={__jailed_type__:"file",__value__:s,__relative_path__:s.relativePath||s.webkitRelativePath};else if(s!==Object(s)||s instanceof Boolean||s instanceof String||s instanceof Date||s instanceof RegExp||s instanceof Blob||s instanceof ImageData||"undefined"!=typeof FileList&&s instanceof FileList)_[a]={__jailed_type__:"argument",__value__:s};else if(s instanceof ArrayBuffer)(s._transfer||c)&&(r.push(s),delete s._transfer),_[a]={__jailed_type__:"argument",__value__:s};else if(s instanceof o)(s._transfer||c)&&(r.push(s.buffer),delete s._transfer),_[a]={__jailed_type__:"argument",__value__:s};else if(s.__as_interface__)_[a]=this._encode(s,!0);else{if("object"!=typeof s&&!Array.isArray(s))throw"object"==typeof s&&s.constructor?"Unsupported data type for transferring between the plugin and the main app: "+a+" : "+s.constructor.name:"Unsupported data type for transferring between the plugin and the main app: "+a+","+s;if(_[a]=this._encode(s,t),_[a].__transferables__){for(var m=0;m<_[a].__transferables__.length;m++)r.push(_[a].__transferables__[m]);delete _[a].__transferables__}}}return r.length>0&&(_.__transferables__=r),_}_decode(e,t,r){if(!e)return e;var n,i,_;if(e.hasOwnProperty("__jailed_type__")&&e.hasOwnProperty("__value__")){if(e.__jailed_type__.startsWith("custom_encoding"))if("function"==typeof this._interface._rpcDecode){n=this._interface._rpcDecode(e.__value__)}else n=e;else"callback"===e.__jailed_type__?n=this._genRemoteCallback(t,e.num,r):"interface"===e.__jailed_type__?n=this._remote[e.__value__]||this._genRemoteMethod(e.__value__):"plugin_interface"===e.__jailed_type__?n=this._genRemoteMethod(e.__value__,e.__plugin_id__):"ndarray"===e.__jailed_type__?"__plugin__"===this.id&&"undefined"!=typeof nj&&nj.array?(Array.isArray(e.__value__)&&(e.__value__=e.__value__.reduce(s)),n=nj.array(e.__value__,e.__dtype__).reshape(e.__shape__)):"__plugin__"===this.id&&"undefined"!=typeof tf&&tf.Tensor?(Array.isArray(e.__value__)&&(e.__value__=e.__value__.reduce(s)),n=tf.tensor(e.__value__,e.__shape__,e.__dtype__)):n=e:"error"===e.__jailed_type__?n=new Error(e.__value__):"file"===e.__jailed_type__?(n=e.__value__).relativePath=e.__relative_path__:"argument"===e.__jailed_type__&&(n=e.__value__);return n}var o=Array.isArray(e);for(_ in n=o?[]:{},e)(o||e.hasOwnProperty(_))&&("object"==typeof(i=e[_])||Array.isArray(i))&&(n[_]=this._decode(i,t,r));return n}_wrap(e,t){return{args:this._encode(e,t)}}_unwrap(e,t){return this._decode(e.args,e.callbackId,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise((r,i)=>{var _=n._wrap(Array.prototype.slice.call(arguments)),o=_.args.__transferables__;o&&delete _.args.__transferables__,r.__jailed_pairs__=i,i.__jailed_pairs__=r;try{n._connection.send({type:"callback",id:e,num:t,args:_,promise:n._wrap([r,i])},o)}catch(r){i(`Failed to exectue remote callback (id: ${e}, argNum: ${t}).`)}})}:function(){var r=n._wrap(Array.prototype.slice.call(arguments)),i=r.args.__transferables__;return i&&delete r.args.__transferables__,n._connection.send({type:"callback",id:e,num:t,args:r},i)}}disconnect(){this._connection.send({type:"disconnect"}),setTimeout(this._connection.disconnect,2e3)}onDisconnect(e){this._disconnectHandler=e}}class c{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t,r,n=this._store[e];if(n&&!n.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),n&&n.__jailed_pairs__){const e=(t=this._store,r=n.__jailed_pairs__,Object.keys(t).find(e=>t[e]===r));this.fetch(e)}return n}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(0);function i(e,t){const r={};t=t||{};const i=new n.b(e,t);i.onGetInterface((function(){s()})),i.onRemoteUpdate((function(){if(r.remote=i.getRemote(),!r.remote)return;const e=r.remote||{};e.export&&console.error("WARNING: overwriting function \'export\'."),e.onload&&console.error("WARNING: overwriting function \'onload\'."),e.dispose&&console.error("WARNING: overwriting function \'dispose\'."),e.export=r.setInterface,e.onLoad=r.whenConnected,e.dispose=r.disconnect,"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"})):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));var _=!1,o=[],s=function(){var e;if(!_)for(_=!0;e=o.pop();)e()};r.whenConnected=function(e){e=function(e){var t=typeof e;if("function"!==t)throw new Error("A function may only be subsribed to the event, "+t+" was provided instead");return e}(e),_?e():o.push(e)},r.setInterface=function(e){i.setInterface(e)},r.disconnect=function(e){i.disconnect()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0);!function(){if(!("undefined"!=typeof WorkerGlobalScope&&self&&self instanceof WorkerGlobalScope))throw new Error("This script can only loaded in a webworker");var execute=function(code){try{if("requirements"===code.type)try{if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{Array.isArray(code.requirements)||(code.requirements=[code.requirements]);for(var i=0;i<code.requirements.length;i++){if(code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:"))throw"unable to import css in a webworker";code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),importScripts(code.requirements[i])):code.requirements[i].startsWith("http")?importScripts(code.requirements[i]):code.requirements[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+code.requirements[i])}}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}}catch(e){throw e}else{if("script"!==code.type)throw"unsupported code type.";try{if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{if(Array.isArray(code.requirements))for(let e=0;e<code.requirements.length;e++)importScripts(code.requirements[e]);else importScripts(code.requirements)}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}}self.postMessage({type:"executeSuccess"})}catch(e){console.error("failed to execute scripts: ",code,e),self.postMessage({type:"executeFailure",error:e.stack||String(e)})}};const conn={disconnect:function(){self.close()},send:function(e,t){e.__transferables__=t,self.postMessage(e,t)},onMessage:function(e){conn._messageHandler=e},_messageHandler:function(){},onDisconnect:function(){}},config={type:"web-worker",dedicated_thread:!0,allow_execution:!0,lang:"javascript",api_version:_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a};self.addEventListener("message",(function(e){const t=e.data;switch(t&&t.type){case"getConfig":self.postMessage({type:"config",config:config});break;case"execute":execute(t.code),"requirements"===t.code.type&&(Array.isArray(t.code.requirements)||(t.code.requirements=[t.code.requirements]),self.postMessage({type:"cacheRequirements",requirements:t.code.requirements}));break;case"connectRPC":Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(conn,t.config);break;default:conn._messageHandler(t)}})),self.postMessage({type:"initialized",config:config})}()}]);\n//# sourceMappingURL=imjoy-rpc-min-webworker.js.map',null)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return setupWebPython}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0);function setupWebPython(config){function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}config=config||{};var _importScript=function(e){return new Promise((t,r)=>{var n=document.createElement("script");n.src=e,n.onload=t,n.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},n.onerror=r,document.head.appendChild(n)})};async function importScripts(){for(var e=Array.prototype.slice.call(arguments),t=e.length,r=0;r<t;r++)await _importScript(e[r])}var startup_script='\n  from js import api\n  import sys\n  from types import ModuleType\n  m = ModuleType("imjoy")\n  sys.modules[m.__name__] = m\n  m.__file__ = m.__name__ + ".py"\n  m.api = api\n  ',_export_plugin_api=null,execute_python_code=function(e){try{_export_plugin_api||(_export_plugin_api=window.api.export,window.api.export=function(e){if("object"==typeof e){const t={};for(let r in e)r.startsWith("_")||(t[r]=e[r]);_export_plugin_api(t)}else{if("function"!=typeof e)throw"unsupported api export";{const t={},r=window.pyodide.pyimport("getattr"),n=window.pyodide.pyimport("hasattr");for(let i of Object.getOwnPropertyNames(e))if(!i.startsWith("_")&&n(e,i)){const n=r(e,i);t[i]=function(){return n(...Array.prototype.slice.call(arguments))}}_export_plugin_api(t)}}}),window.pyodide.runPython(startup_script),window.pyodide.runPython(e.content)}catch(e){throw e}},execute=async function(code){try{if("requirements"===code.type){if(code.requirements){if(code.requirements="string"==typeof code.requirements?[code.requirements]:code.requirements,!Array.isArray(code.requirements))throw"unsupported requirements definition";{const e=[];for(var i=0;i<code.requirements.length;i++)code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:")?(code.requirements[i].startsWith("css:")&&(code.requirements[i]=code.requirements[i].slice(4)),link_node=document.createElement("link"),link_node.rel="stylesheet",link_node.href=code.requirements[i],document.head.appendChild(link_node)):code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),await importScripts(code.requirements[i])):code.requirements[i].startsWith("cache:")||(code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("package:")?(code.requirements[i].startsWith("package:")&&(code.requirements[i]=code.requirements[i].slice(8)),e.push(code.requirements[i])):code.requirements[i].startsWith("http:")||code.requirements[i].startsWith("https:")?console.log("Unprocessed requirements url: "+code.requirements[i]):e.push(code.requirements[i]));await window.pyodide.loadPackage(e)}}}else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(code.content&&"python"===code.lang)execute_python_code(code);else if(code.content&&"javascript"===code.lang)try{eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}else{var node=document.createElement("script");node.setAttribute("type",code.attrs.type),node.appendChild(document.createTextNode(code.content)),document.body.appendChild(node)}else if("style"===code.type){var style_node=document.createElement("style");code.src&&(style_node.src=code.src),style_node.innerHTML=code.content,document.head.appendChild(style_node)}else if("link"===code.type){var link_node=document.createElement("link");code.rel&&(link_node.rel=code.rel),code.href&&(link_node.href=code.href),code.attrs&&code.attrs.type&&(link_node.type=code.attrs.type),document.head.appendChild(link_node)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}parent.postMessage({type:"executeSuccess"},"*")}catch(e){console.error("failed to execute scripts: ",code,e),parent.postMessage({type:"executeFailure",error:e.stack||String(e)},"*")}};const targetOrigin=config.target_origin||"*",conn={disconnect:function(){},send:function(e,t){parent.postMessage(e,targetOrigin,t)},onMessage:function(e){conn._messageHandler=e},_messageHandler:function(){},onDisconnect:function(){}};config.dedicated_thread=!1,config.lang="python",config.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a,window.addEventListener("message",(function(e){if("*"===targetOrigin||e.origin===targetOrigin){const t=e.data;switch(t&&t.type){case"getConfig":parent.postMessage({type:"config",config:config},targetOrigin);break;case"execute":config.allow_execution?(execute(t.code),"requirements"===t.code.type&&(Array.isArray(t.code.requirements)||(t.code.requirements=[t.code.requirements]))):console.warn("execute script is not allowed (allow_execution=false)");break;default:conn._messageHandler(t)}}})),window.languagePluginUrl="https://static.imjoy.io/pyodide/",importScripts("https://static.imjoy.io/pyodide/pyodide.js").then(()=>{window.iodide={output:{element:function(e){const t=document.createElement(e);return(document.getElementById("output")||document.body).appendChild(t),t}}},window.languagePluginLoader.then(()=>{console.log(window.pyodide.runPython("import sys\nsys.version")),Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(conn,{forwarding_functions:config.forwarding_functions}),parent.postMessage({type:"initialized",config:config},targetOrigin)})})}},function(e,t,r){"use strict";r.r(t),r.d(t,"setupBaseFrame",(function(){return d})),r.d(t,"setupRPC",(function(){return u}));var n=r(5),i=r.n(n),o=r(3),s=r(6),a=r(1),_=r(0);r.d(t,"RPC",(function(){return _.b})),r.d(t,"API_VERSION",(function(){return _.a}));var c=r(4);async function d(e){return(e=e||{}).name=e.name||"Generic RPC App",e.type=e.type||function(e){const t=window.location.search.substring(1).split("&");for(let r=0;r<t.length;r++){const n=t[r].split("=");if(n[0]===e)return n[1]}}("_plugin_type")||"window",e.allow_execution=e.allow_execution||!0,e.enable_service_worker=e.enable_service_worker||!0,e.enable_service_worker&&Object(a.b)(e.target_origin,e.cache_requirements),e.cache_requirements&&delete e.cache_requirements,e.forwarding_functions=e.forwarding_functions,void 0===e.forwarding_functions&&(e.forwarding_functions=["close","on","off","emit"],["rpc-window","window","web-python-window"].includes(e.type)&&(e.forwarding_functions=e.forwarding_functions.concat(["resize","show","hide","refresh"]))),window.api=await imjoyRPC.setupRPC(e),window.api}function u(e){if(!(e=e||{}).name)throw new Error("Please specify a name for your app.");return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||Object(a.a)(),e.allow_execution=e.allow_execution||!1,e.token=e.token||Object(a.a)(),e=Object.keys(e).reduce((t,r)=>("function"!=typeof e[r]&&(t[r]=e[r]),t),{}),new Promise((t,r)=>{if(function(){try{return window.self!==window.top}catch(e){return!0}}()){if("web-worker"===e.type)try{!function(e){if(!e.allow_execution)throw new Error("web-worker plugin can only work with allow_execution=true");const t=new i.a,r=setTimeout((function(){t.terminate(),console.warn("Plugin failed to start as a web-worker, running in an iframe instead."),Object(o.a)(e)}),2e3);t.addEventListener("message",(function(n){let i=void 0;const o=n.data;"initialized"===o.type?(t.postMessage({type:"connectRPC",config:e}),clearTimeout(r),o.config=Object.assign({},e,o.config)):"imjoy_remote_api_ready"===o.type?window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:null})):"cacheRequirements"===o.type&&"function"==typeof cache_requirements?cache_requirements(o.requirements):"disconnect"===o.type?t.terminate():o.__transferables__&&(i=o.__transferables__,delete o.__transferables__),parent.postMessage(o,"*",i)})),window.addEventListener("message",(function(e){let r=void 0;const n=e.data;n.__transferables__&&(r=n.__transferables__,delete n.__transferables__),t.postMessage(n,r)}))}(e)}catch(t){Object(o.a)(e)}else"web-python"===e.type||"web-python-window"===e.type?Object(s.a)(e):["rpc-window","rpc-worker","iframe","window"].includes(e.type)?Object(o.a)(e):(console.error("Unsupported plugin type: "+e.type),r("Unsupported plugin type: "+e.type));try{window.addEventListener("imjoy_remote_api_ready",e=>{t(e.detail)})}catch(e){r(e)}}else r(new Error("imjoy-rpc should only run inside an iframe."))})}r.d(t,"VERSION",(function(){return c.a}))},function(e,t,r){"use strict";var n=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var r;try{(r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),r=r.getBlob()}catch(t){r=new Blob([e])}return new Worker(n.createObjectURL(r))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}}])}));
//# sourceMappingURL=imjoy-rpc.min.js.map