!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("imjoyRPC",[],t):"object"==typeof exports?exports.imjoyRPC=t():e.imjoyRPC=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t,r){"use strict";function n(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}r.d(t,"c",(function(){return n})),r.d(t,"b",(function(){return i})),r.d(t,"e",(function(){return o})),r.d(t,"d",(function(){return a})),r.d(t,"a",(function(){return _}));const i={int8:"Int8Array",int16:"Int16Array",int32:"Int32Array",uint8:"Uint8Array",uint16:"Uint16Array",uint32:"Uint32Array",float32:"Float32Array",float64:"Float64Array",array:"Array"},o={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"};function s(e){return new Promise((function(t,r){const n={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void r("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?r(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(n,[i.port2]):r("Service worker controller is not available")}))}async function c(e){if(Array.isArray(e)||(requirementsm.code.requirements=[e]),e&&e.length>0)for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await s(t).catch(e=>{console.error(e)})}function a(e,t,r){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(r=r||c)&&"function"!=typeof r)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&r(t.requirements)}}))}}class _{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const r=this._event_handlers[e].indexOf(t);r>=0&&this._event_handlers[e].splice(r,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var r=this._event_handlers[e].length;r--;){const n=this._event_handlers[e][r];try{n(t)}catch(e){console.error(e)}finally{n.___event_run_once&&this._event_handlers[e].splice(r,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return API_VERSION})),__webpack_require__.d(__webpack_exports__,"b",(function(){return RPC}));var _utils_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);const API_VERSION="0.2.3",ArrayBufferView=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function _appendBuffer(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}function getKeyByValue(e,t){return Object.keys(e).find(r=>e[r]===t)}function indexObject(e,t){return"string"==typeof t?indexObject(e,t.split(".")):0==t.length?e:indexObject(e[t[0]],t.slice(1))}class RPC extends _utils_js__WEBPACK_IMPORTED_MODULE_0__.a{constructor(e,t,r){super(t&&t.debug),this._connection=e,this.config=t||{},this._codecs=r||{},this._object_store={},this._method_weakmap=new WeakMap,this._object_weakmap=new WeakMap,this._local_api=null;const n=this.config.name;this._connection.execute=this._connection.execute||function(){throw new Error(`connection.execute not implemented (in "${n}")`)},this._store=new ReferenceStore,this._method_refs=new ReferenceStore,this._method_refs.onReady(()=>{this._fire("remoteIdle")}),this._method_refs.onBusy(()=>{this._fire("remoteBusy")}),this._setupMessageHanlders()}init(){this._connection.emit({type:"initialized",config:this.config,peer_id:this._connection.peer_id})}getRemoteCallStack(){return this._method_refs.getStack()}getRemote(){return this._remote_interface}setInterface(e,t){if(t=t||{},this.config.name=t.name||this.config.name,this.config.description=t.description||this.config.description,this.config.forwarding_functions)for(let t of this.config.forwarding_functions){const r=this._remote_interface;r[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{r[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{r[t](...e)})))}this._local_api=e,this._fire("interfaceAvailable")}sendInterface(){if(!this._local_api)throw new Error("interface is not set.");this._encode(this._local_api,!0).then(e=>{this._connection.emit({type:"setInterface",api:e})})}_disposeObject(e){if(!this._object_store[e])throw new Error(`Object (id=${e}) not found.`);delete this._object_store[e]}disposeObject(e){return new Promise((t,r)=>{if(!this._object_weakmap.has(e))throw new Error("Invalid object");{const n=this._object_weakmap.get(e);this._connection.once("disposed",e=>{e.error?r(new Error(e.error)):t()}),this._connection.emit({type:"disposeObject",object_id:n})}})}_setupMessageHanlders(){this._connection.on("init",this.init),this._connection.on("execute",e=>{Promise.resolve(this._connection.execute(e.code)).then(()=>{this._connection.emit({type:"executed"})}).catch(e=>{console.error(e),this._connection.emit({type:"executed",error:String(e)})})}),this._connection.on("method",async e=>{let t,r,n,i,o;try{e.promise&&([t,r]=await this._unwrap(e.promise,!1));const s=this._object_store[e.object_id];n=indexObject(s,e.name),i=await this._unwrap(e.args,!0),e.promise?(o=n.apply(s,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)):n.apply(s,i)}catch(e){console.error(this.config.name,e),r&&r(e)}}),this._connection.on("callback",async e=>{let t,r,n,i,o;try{if(e.promise&&([t,r]=await this._unwrap(e.promise,!1)),e.promise){if(n=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!n)throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");o=n.apply(null,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}else{if(n=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!n)throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");n.apply(null,i)}}catch(e){console.error(this.config.name,e),r&&r(e)}}),this._connection.on("disposeObject",e=>{try{this._disposeObject(e.object_id),this._connection.emit({type:"disposed"})}catch(e){console.error(e),this._connection.emit({type:"disposed",error:String(e)})}}),this._connection.on("setInterface",e=>{this._setRemoteInterface(e.api)}),this._connection.on("getInterface",()=>{this._fire("getInterface"),this._local_api?this.sendInterface():this.once("interfaceAvailable",()=>{this.sendInterface()})}),this._connection.on("interfaceSetAsRemote",()=>{this._fire("interfaceSetAsRemote")}),this._connection.on("disconnect",()=>{this._fire("beforeDisconnect"),this._connection.disconnect(),this._fire("disconnected")})}requestRemote(){this._connection.emit({type:"getInterface"})}_ndarray(e,t,r){var n=_utils_js__WEBPACK_IMPORTED_MODULE_0__.e[e.constructor.name];if(r&&r!==n)throw"dtype doesn't match the type of the array: "+n+" != "+r;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:n}}_setRemoteInterface(e){this._decode(e).then(e=>{this._remote_interface=e,this._fire("remoteReady"),this._reportRemoteSet()})}_genRemoteMethod(e,t,r){var n=this,i=function(){return new Promise(async(i,o)=>{let s=null;try{s=n._method_refs.put(r?r+"/"+t:t);var c=function(){return null!==s&&n._method_refs.fetch(s),i.apply(this,arguments)},a=function(){return null!==s&&n._method_refs.fetch(s),o.apply(this,arguments)};c.__rpc_pair=a,a.__rpc_pair=c;var _=Array.prototype.slice.call(arguments),d=(_="register"===t||"export"===t||"on"===t?await n._wrap(_,!0):await n._wrap(_)).__transferables__;d&&delete _.__transferables__,n._connection.emit({type:"method",target_id:e,name:t,object_id:r,args:_,promise:await n._wrap([c,a])},d)}catch(e){s&&n._method_refs.fetch(s),o(`Failed to exectue remote method (interface: ${r||n.id}, method: ${t}), error: ${e}`)}})};return i.__remote_method=!0,i}_reportRemoteSet(){this._connection.emit({type:"interfaceSetAsRemote"})}async _encode(e,t,r){const n=typeof e;if("number"===n||"string"===n||"boolean"===n||null==e||e instanceof ArrayBuffer)return e;let i;if("function"==typeof e){if(t){if(!r)throw new Error("objectId is not specified.");i={_rtype:"interface",_rtarget_id:this._connection.peer_id,_rintf:r,_rvalue:t},this._method_weakmap.set(e,i)}else if(this._method_weakmap.has(e))i=this._method_weakmap.get(e);else{const t=this._store.put(e);i={_rtype:"callback",_rtarget_id:this._connection.peer_id,_rname:e.constructor&&e.constructor.name||t,_rvalue:t}}return i}if(e.constructor instanceof Object&&e._rtype){if(e._rintf){const n=e._rtype;delete e._rtype,i=await this._encode(e,t,r),i._rtype=n}else i=e;return i}const o=[],s=e._transfer,c=Array.isArray(e);for(let n of Object.keys(this._codecs)){const o=this._codecs[n];if(o.encoder&&e instanceof o.type){const n=await Promise.resolve(o.encoder(e));if(n&&!n._rtype&&(n._rtype=o.name),n&&n._rintf){const e=n._rtype;delete n._rtype,n=await this._encode(n,t,r),n._rtype=e}return i=n,i}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const t=e.dataSync();(e._transfer||s)&&(o.push(t.buffer),delete e._transfer),i={_rtype:"ndarray",_rvalue:t.buffer,_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){var a=_utils_js__WEBPACK_IMPORTED_MODULE_0__.e[e.selection.data.constructor.name];(e._transfer||s)&&(o.push(e.selection.data.buffer),delete e._transfer),i={_rtype:"ndarray",_rvalue:e.selection.data.buffer,_rshape:e.shape,_rdtype:a}}else if(e instanceof Error)console.error(e),i={_rtype:"error",_rvalue:e.toString()};else if("undefined"!=typeof File&&e instanceof File)i={_rtype:"file",_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList)i=e;else if("undefined"!=typeof File&&e instanceof File)i={_rtype:"file",_rname:e.name,_rmime:e.type,_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e instanceof Blob)i={_rtype:"blob",_rvalue:e};else if(e instanceof ArrayBufferView){(e._transfer||s)&&(o.push(e.buffer),delete e._transfer);const t=_utils_js__WEBPACK_IMPORTED_MODULE_0__.e[e.constructor.name];i={_rtype:"typedarray",_rvalue:e.buffer,_rdtype:t}}else if(e instanceof DataView)(e._transfer||s)&&(o.push(e.buffer),delete e._transfer),i={_rtype:"memoryview",_rvalue:e.buffer};else if(e instanceof Set)i={_rtype:"set",_rvalue:await this._encode(Array.from(e),t)};else if(e instanceof Map)i={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t)};else if(e.constructor instanceof Object||Array.isArray(e)){let n;if(i=c?[]:{},e.constructor===Object||Array.isArray(e))n=Object.keys(e);else{if(e.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(e.constructor.constructor!==Function)throw Error("Unsupported interface type");n=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),t=!0}if(e._rintf||t){r||(r=Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__.c)(),this._object_store[r]=e);for(let o of n)"constructor"!==o&&(o.startsWith("_")||(i[o]=await this._encode(e[o],"string"==typeof t?t+"."+o:o,r)));i._rintf=r,e.on&&"function"==typeof e.on&&e.on("close",()=>{delete this._object_store[r]})}else for(let t of n)["hasOwnProperty","constructor"].includes(t)||(i[t]=await this._encode(e[t]))}else{if("object"!=typeof e)throw"imjoy-rpc: Unsupported data type:"+e;{const t=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),r=Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__.c)();for(let r of t)["hasOwnProperty","constructor"].includes(r)||(i[r]=await this._encode(e[r],r,i));i._rintf=r}}if(o.length>0&&(i.__transferables__=o),!i)throw new Error("Failed to encode object");return i}async _decode(aObject,withPromise){if(!aObject)return aObject;var bObject,v,k;if(aObject._rtype)if(this._codecs[aObject._rtype]&&this._codecs[aObject._rtype].decoder){if(aObject._rintf){const e=aObject._rtype;delete aObject._rtype,aObject=await this._decode(aObject,withPromise),aObject._rtype=e}bObject=await Promise.resolve(this._codecs[aObject._rtype].decoder(aObject))}else if("callback"===aObject._rtype)bObject=this._genRemoteCallback(aObject._rtarget_id,aObject._rvalue,withPromise);else if("interface"===aObject._rtype)bObject=this._genRemoteMethod(aObject._rtarget_id,aObject._rvalue,aObject._rintf);else if("ndarray"===aObject._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(aObject._rvalue)&&(aObject._rvalue=aObject._rvalue.reduce(_appendBuffer)),bObject=nj.array(new Uint8(aObject._rvalue),aObject._rdtype).reshape(aObject._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(aObject._rvalue)&&(aObject._rvalue=aObject._rvalue.reduce(_appendBuffer));const arraytype=eval(_utils_js__WEBPACK_IMPORTED_MODULE_0__.b[aObject._rdtype]);bObject=tf.tensor(new arraytype(aObject._rvalue),aObject._rshape,aObject._rdtype)}else bObject=aObject;else if("error"===aObject._rtype)bObject=new Error(aObject._rvalue);else if("file"===aObject._rtype)aObject._rvalue instanceof File?(bObject=aObject._rvalue,bObject._path=aObject._rpath):(bObject=new File([aObject._rvalue],aObject._rname,{type:aObject._rmime}),bObject._path=aObject._rpath);else if("typedarray"===aObject._rtype){const arraytype=eval(_utils_js__WEBPACK_IMPORTED_MODULE_0__.b[aObject._rdtype]);if(!arraytype)throw new Error("unsupported dtype: "+aObject._rdtype);bObject=new arraytype(aObject._rvalue)}else if("memoryview"===aObject._rtype)bObject=new DataView(aObject._rvalue);else if("blob"===aObject._rtype)bObject=aObject._rvalue instanceof Blob?aObject._rvalue:new Blob([aObject._rvalue],{type:aObject._rmime});else if("orderedmap"===aObject._rtype)bObject=new Map(await this._decode(aObject._rvalue,withPromise));else if("set"===aObject._rtype)bObject=new Set(await this._decode(aObject._rvalue,withPromise));else{if(aObject._rintf){const e=aObject._rtype;delete aObject._rtype,aObject=await this._decode(aObject,withPromise),aObject._rtype=e}bObject=aObject}else if(aObject.constructor===Object||Array.isArray(aObject)){var isarray=Array.isArray(aObject);for(k in bObject=isarray?[]:{},aObject)(isarray||aObject.hasOwnProperty(k))&&(v=aObject[k],bObject[k]=await this._decode(v,withPromise))}else bObject=aObject;if(void 0===bObject)throw new Error("Failed to decode object");return aObject._rintf&&this._object_weakmap.set(bObject,aObject._rintf),bObject}async _wrap(e,t){return await this._encode(e,t)}async _unwrap(e,t){return await this._decode(e,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise(async(r,i)=>{var o=await n._wrap(Array.prototype.slice.call(arguments)),s=o.__transferables__;s&&delete o.__transferables__,r.__rpc_pair=i,i.__rpc_pair=r;try{n._connection.emit({type:"callback",target_id:e,id:t,args:o,promise:await n._wrap([r,i])},s)}catch(e){i(`Failed to exectue remote callback ( id: ${t}).`)}})}:async function(){var r=await n._wrap(Array.prototype.slice.call(arguments)),i=r.__transferables__;return i&&delete r.__transferables__,n._connection.emit({type:"callback",target_id:e,id:t,args:r},i)}}disconnect(){this._connection.emit({type:"disconnect"}),setTimeout(()=>{this._connection.disconnect()},2e3)}}class ReferenceStore{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t=this._store[e];if(t&&!t.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),t&&t.__rpc_pair){const e=getKeyByValue(this._store,t.__rpc_pair);this.fetch(e)}return t}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return Connection})),__webpack_require__.d(__webpack_exports__,"b",(function(){return setupIframe}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0);function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}var _importScript=function(e){return new Promise((t,r)=>{var n=document.createElement("script");n.src=e,n.type="text/javascript",n.onload=t,n.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},n.onerror=r,document.head.appendChild(n)})};async function importScripts(){for(var e=Array.prototype.slice.call(arguments),t=e.length,r=0;r<t;r++)await _importScript(e[r])}class Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__.a{constructor(e){super(e&&e.debug),this.config=e||{},this.peer_id=Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__.c)()}connect(){this.config.target_origin=this.config.target_origin||"*",window.addEventListener("message",this),this.emit({type:"initialized",config:this.config,origin:window.location.origin,peer_id:this.peer_id}),this._fire("connected")}handleEvent(e){"message"!==e.type||"*"!==this.config.target_origin&&e.origin!==this.config.target_origin||(e.data.peer_id===this.peer_id?this._fire(e.data.type,e.data):this.config.debug&&console.log(`connection peer id mismatch ${e.data.peer_id} !== ${this.peer_id}`))}disconnect(){this._fire("beforeDisconnect"),window.removeEventListener("message",this),this._fire("disconnected")}emit(e){let t;e.__transferables__&&(t=e.__transferables__,delete e.__transferables__),parent.postMessage(e,this.config.target_origin,t)}async execute(code){try{if("requirements"===code.type){if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{var link_node;if(code.requirements="string"==typeof code.requirements?[code.requirements]:code.requirements,!Array.isArray(code.requirements))throw"unsupported requirements definition";for(var i=0;i<code.requirements.length;i++)code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:")?(code.requirements[i].startsWith("css:")&&(code.requirements[i]=code.requirements[i].slice(4)),link_node=document.createElement("link"),link_node.rel="stylesheet",link_node.href=code.requirements[i],document.head.appendChild(link_node)):code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),await importScripts(code.requirements[i])):code.requirements[i].startsWith("http")?await importScripts(code.requirements[i]):code.requirements[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+code.requirements[i])}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}}else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(!code.content||code.attrs.type&&"text/javascript"!==code.attrs.type){var node=document.createElement("script");node.setAttribute("type",code.attrs.type),node.appendChild(document.createTextNode(code.content)),document.body.appendChild(node)}else eval(code.content);else if("style"===code.type){const e=document.createElement("style");code.src&&(e.src=code.src),e.innerHTML=code.content,document.head.appendChild(e)}else if("link"===code.type){const e=document.createElement("link");code.rel&&(e.rel=code.rel),code.href&&(e.href=code.href),code.attrs&&code.attrs.type&&(e.type=code.attrs.type),document.head.appendChild(e)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}parent.postMessage({type:"executed"},this.config.target_origin)}catch(e){console.error("failed to execute scripts: ",code,e),parent.postMessage({type:"executed",error:e.stack||String(e)},this.config.target_origin)}}}function setupIframe(e){(e=e||{}).dedicated_thread=!1,e.lang="javascript",e.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a;const t=new Connection(e);Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(t,e),t.connect()}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(1);function i(e,t){t=t||{};const r={},i=new n.b(e,t,r);i.on("getInterface",(function(){c()})),i.on("remoteReady",(function(){const e=i.getRemote()||{};if(e.export)throw new Error("`export` is a reserved function name");if(e.onload)throw new Error("`onload` is a reserved function name");if(e.dispose)throw new Error("`dispose` is a reserved function name");e.registerCodec=function(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(r))r[t].type!==e.type&&t!==e.name||(delete r[t],console.warn("Remove duplicated codec: "+t));r[e.name]=e},e.disposeObject=function(e){i.disposeObject(e)},e.export=function(e,t){i.setInterface(e,t)},e.onLoad=function(e){e=a(e),o?e():s.push(e)},e.dispose=function(e){i.disconnect()},"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"})):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));let o=!1;const s=[],c=function(){if(!o){let e;for(o=!0;e=s.pop();)e()}},a=function(e){const t=typeof e;if("function"!==t){throw new Error("A function may only be subsribed to the event, "+t+" was provided instead")}return e};return i}},function(e){e.exports=JSON.parse('{"a":"0.2.13"}')},function(e,t,r){e.exports=function(){return r(8)('!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t,r){"use strict";function n(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}r.d(t,"c",(function(){return n})),r.d(t,"b",(function(){return i})),r.d(t,"d",(function(){return o})),r.d(t,"a",(function(){return s}));const i={int8:"Int8Array",int16:"Int16Array",int32:"Int32Array",uint8:"Uint8Array",uint16:"Uint16Array",uint32:"Uint32Array",float32:"Float32Array",float64:"Float64Array",array:"Array"},o={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"};class s{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const r=this._event_handlers[e].indexOf(t);r>=0&&this._event_handlers[e].splice(r,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var r=this._event_handlers[e].length;r--;){const n=this._event_handlers[e][r];try{n(t)}catch(e){console.error(e)}finally{n.___event_run_once&&this._event_handlers[e].splice(r,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return API_VERSION})),__webpack_require__.d(__webpack_exports__,"b",(function(){return RPC}));var _utils_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);const API_VERSION="0.2.3",ArrayBufferView=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function _appendBuffer(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}function getKeyByValue(e,t){return Object.keys(e).find(r=>e[r]===t)}function indexObject(e,t){return"string"==typeof t?indexObject(e,t.split(".")):0==t.length?e:indexObject(e[t[0]],t.slice(1))}class RPC extends _utils_js__WEBPACK_IMPORTED_MODULE_0__.a{constructor(e,t,r){super(t&&t.debug),this._connection=e,this.config=t||{},this._codecs=r||{},this._object_store={},this._method_weakmap=new WeakMap,this._object_weakmap=new WeakMap,this._local_api=null;const n=this.config.name;this._connection.execute=this._connection.execute||function(){throw new Error(`connection.execute not implemented (in "${n}")`)},this._store=new ReferenceStore,this._method_refs=new ReferenceStore,this._method_refs.onReady(()=>{this._fire("remoteIdle")}),this._method_refs.onBusy(()=>{this._fire("remoteBusy")}),this._setupMessageHanlders()}init(){this._connection.emit({type:"initialized",config:this.config,peer_id:this._connection.peer_id})}getRemoteCallStack(){return this._method_refs.getStack()}getRemote(){return this._remote_interface}setInterface(e,t){if(t=t||{},this.config.name=t.name||this.config.name,this.config.description=t.description||this.config.description,this.config.forwarding_functions)for(let t of this.config.forwarding_functions){const r=this._remote_interface;r[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{r[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{r[t](...e)})))}this._local_api=e,this._fire("interfaceAvailable")}sendInterface(){if(!this._local_api)throw new Error("interface is not set.");this._encode(this._local_api,!0).then(e=>{this._connection.emit({type:"setInterface",api:e})})}_disposeObject(e){if(!this._object_store[e])throw new Error(`Object (id=${e}) not found.`);delete this._object_store[e]}disposeObject(e){return new Promise((t,r)=>{if(!this._object_weakmap.has(e))throw new Error("Invalid object");{const n=this._object_weakmap.get(e);this._connection.once("disposed",e=>{e.error?r(new Error(e.error)):t()}),this._connection.emit({type:"disposeObject",object_id:n})}})}_setupMessageHanlders(){this._connection.on("init",this.init),this._connection.on("execute",e=>{Promise.resolve(this._connection.execute(e.code)).then(()=>{this._connection.emit({type:"executed"})}).catch(e=>{console.error(e),this._connection.emit({type:"executed",error:String(e)})})}),this._connection.on("method",async e=>{let t,r,n,i,o;try{e.promise&&([t,r]=await this._unwrap(e.promise,!1));const s=this._object_store[e.object_id];n=indexObject(s,e.name),i=await this._unwrap(e.args,!0),e.promise?(o=n.apply(s,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)):n.apply(s,i)}catch(e){console.error(this.config.name,e),r&&r(e)}}),this._connection.on("callback",async e=>{let t,r,n,i,o;try{if(e.promise&&([t,r]=await this._unwrap(e.promise,!1)),e.promise){if(n=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!n)throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");o=n.apply(null,i),o instanceof Promise||n.constructor&&"AsyncFunction"===n.constructor.name?o.then(t).catch(r):t(o)}else{if(n=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!n)throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");n.apply(null,i)}}catch(e){console.error(this.config.name,e),r&&r(e)}}),this._connection.on("disposeObject",e=>{try{this._disposeObject(e.object_id),this._connection.emit({type:"disposed"})}catch(e){console.error(e),this._connection.emit({type:"disposed",error:String(e)})}}),this._connection.on("setInterface",e=>{this._setRemoteInterface(e.api)}),this._connection.on("getInterface",()=>{this._fire("getInterface"),this._local_api?this.sendInterface():this.once("interfaceAvailable",()=>{this.sendInterface()})}),this._connection.on("interfaceSetAsRemote",()=>{this._fire("interfaceSetAsRemote")}),this._connection.on("disconnect",()=>{this._fire("beforeDisconnect"),this._connection.disconnect(),this._fire("disconnected")})}requestRemote(){this._connection.emit({type:"getInterface"})}_ndarray(e,t,r){var n=_utils_js__WEBPACK_IMPORTED_MODULE_0__.d[e.constructor.name];if(r&&r!==n)throw"dtype doesn\'t match the type of the array: "+n+" != "+r;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:n}}_setRemoteInterface(e){this._decode(e).then(e=>{this._remote_interface=e,this._fire("remoteReady"),this._reportRemoteSet()})}_genRemoteMethod(e,t,r){var n=this,i=function(){return new Promise(async(i,o)=>{let s=null;try{s=n._method_refs.put(r?r+"/"+t:t);var c=function(){return null!==s&&n._method_refs.fetch(s),i.apply(this,arguments)},a=function(){return null!==s&&n._method_refs.fetch(s),o.apply(this,arguments)};c.__rpc_pair=a,a.__rpc_pair=c;var _=Array.prototype.slice.call(arguments),f=(_="register"===t||"export"===t||"on"===t?await n._wrap(_,!0):await n._wrap(_)).__transferables__;f&&delete _.__transferables__,n._connection.emit({type:"method",target_id:e,name:t,object_id:r,args:_,promise:await n._wrap([c,a])},f)}catch(e){s&&n._method_refs.fetch(s),o(`Failed to exectue remote method (interface: ${r||n.id}, method: ${t}), error: ${e}`)}})};return i.__remote_method=!0,i}_reportRemoteSet(){this._connection.emit({type:"interfaceSetAsRemote"})}async _encode(e,t,r){const n=typeof e;if("number"===n||"string"===n||"boolean"===n||null==e||e instanceof ArrayBuffer)return e;let i;if("function"==typeof e){if(t){if(!r)throw new Error("objectId is not specified.");i={_rtype:"interface",_rtarget_id:this._connection.peer_id,_rintf:r,_rvalue:t},this._method_weakmap.set(e,i)}else if(this._method_weakmap.has(e))i=this._method_weakmap.get(e);else{const t=this._store.put(e);i={_rtype:"callback",_rtarget_id:this._connection.peer_id,_rname:e.constructor&&e.constructor.name||t,_rvalue:t}}return i}if(e.constructor instanceof Object&&e._rtype){if(e._rintf){const n=e._rtype;delete e._rtype,i=await this._encode(e,t,r),i._rtype=n}else i=e;return i}const o=[],s=e._transfer,c=Array.isArray(e);for(let n of Object.keys(this._codecs)){const o=this._codecs[n];if(o.encoder&&e instanceof o.type){const n=await Promise.resolve(o.encoder(e));if(n&&!n._rtype&&(n._rtype=o.name),n&&n._rintf){const e=n._rtype;delete n._rtype,n=await this._encode(n,t,r),n._rtype=e}return i=n,i}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const t=e.dataSync();(e._transfer||s)&&(o.push(t.buffer),delete e._transfer),i={_rtype:"ndarray",_rvalue:t.buffer,_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){var a=_utils_js__WEBPACK_IMPORTED_MODULE_0__.d[e.selection.data.constructor.name];(e._transfer||s)&&(o.push(e.selection.data.buffer),delete e._transfer),i={_rtype:"ndarray",_rvalue:e.selection.data.buffer,_rshape:e.shape,_rdtype:a}}else if(e instanceof Error)console.error(e),i={_rtype:"error",_rvalue:e.toString()};else if("undefined"!=typeof File&&e instanceof File)i={_rtype:"file",_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList)i=e;else if("undefined"!=typeof File&&e instanceof File)i={_rtype:"file",_rname:e.name,_rmime:e.type,_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e instanceof Blob)i={_rtype:"blob",_rvalue:e};else if(e instanceof ArrayBufferView){(e._transfer||s)&&(o.push(e.buffer),delete e._transfer);const t=_utils_js__WEBPACK_IMPORTED_MODULE_0__.d[e.constructor.name];i={_rtype:"typedarray",_rvalue:e.buffer,_rdtype:t}}else if(e instanceof DataView)(e._transfer||s)&&(o.push(e.buffer),delete e._transfer),i={_rtype:"memoryview",_rvalue:e.buffer};else if(e instanceof Set)i={_rtype:"set",_rvalue:await this._encode(Array.from(e),t)};else if(e instanceof Map)i={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t)};else if(e.constructor instanceof Object||Array.isArray(e)){let n;if(i=c?[]:{},e.constructor===Object||Array.isArray(e))n=Object.keys(e);else{if(e.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(e.constructor.constructor!==Function)throw Error("Unsupported interface type");n=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),t=!0}if(e._rintf||t){r||(r=Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__.c)(),this._object_store[r]=e);for(let o of n)"constructor"!==o&&(o.startsWith("_")||(i[o]=await this._encode(e[o],"string"==typeof t?t+"."+o:o,r)));i._rintf=r,e.on&&"function"==typeof e.on&&e.on("close",()=>{delete this._object_store[r]})}else for(let t of n)["hasOwnProperty","constructor"].includes(t)||(i[t]=await this._encode(e[t]))}else{if("object"!=typeof e)throw"imjoy-rpc: Unsupported data type:"+e;{const t=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),r=Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__.c)();for(let r of t)["hasOwnProperty","constructor"].includes(r)||(i[r]=await this._encode(e[r],r,i));i._rintf=r}}if(o.length>0&&(i.__transferables__=o),!i)throw new Error("Failed to encode object");return i}async _decode(aObject,withPromise){if(!aObject)return aObject;var bObject,v,k;if(aObject._rtype)if(this._codecs[aObject._rtype]&&this._codecs[aObject._rtype].decoder){if(aObject._rintf){const e=aObject._rtype;delete aObject._rtype,aObject=await this._decode(aObject,withPromise),aObject._rtype=e}bObject=await Promise.resolve(this._codecs[aObject._rtype].decoder(aObject))}else if("callback"===aObject._rtype)bObject=this._genRemoteCallback(aObject._rtarget_id,aObject._rvalue,withPromise);else if("interface"===aObject._rtype)bObject=this._genRemoteMethod(aObject._rtarget_id,aObject._rvalue,aObject._rintf);else if("ndarray"===aObject._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(aObject._rvalue)&&(aObject._rvalue=aObject._rvalue.reduce(_appendBuffer)),bObject=nj.array(new Uint8(aObject._rvalue),aObject._rdtype).reshape(aObject._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(aObject._rvalue)&&(aObject._rvalue=aObject._rvalue.reduce(_appendBuffer));const arraytype=eval(_utils_js__WEBPACK_IMPORTED_MODULE_0__.b[aObject._rdtype]);bObject=tf.tensor(new arraytype(aObject._rvalue),aObject._rshape,aObject._rdtype)}else bObject=aObject;else if("error"===aObject._rtype)bObject=new Error(aObject._rvalue);else if("file"===aObject._rtype)aObject._rvalue instanceof File?(bObject=aObject._rvalue,bObject._path=aObject._rpath):(bObject=new File([aObject._rvalue],aObject._rname,{type:aObject._rmime}),bObject._path=aObject._rpath);else if("typedarray"===aObject._rtype){const arraytype=eval(_utils_js__WEBPACK_IMPORTED_MODULE_0__.b[aObject._rdtype]);if(!arraytype)throw new Error("unsupported dtype: "+aObject._rdtype);bObject=new arraytype(aObject._rvalue)}else if("memoryview"===aObject._rtype)bObject=new DataView(aObject._rvalue);else if("blob"===aObject._rtype)bObject=aObject._rvalue instanceof Blob?aObject._rvalue:new Blob([aObject._rvalue],{type:aObject._rmime});else if("orderedmap"===aObject._rtype)bObject=new Map(await this._decode(aObject._rvalue,withPromise));else if("set"===aObject._rtype)bObject=new Set(await this._decode(aObject._rvalue,withPromise));else{if(aObject._rintf){const e=aObject._rtype;delete aObject._rtype,aObject=await this._decode(aObject,withPromise),aObject._rtype=e}bObject=aObject}else if(aObject.constructor===Object||Array.isArray(aObject)){var isarray=Array.isArray(aObject);for(k in bObject=isarray?[]:{},aObject)(isarray||aObject.hasOwnProperty(k))&&(v=aObject[k],bObject[k]=await this._decode(v,withPromise))}else bObject=aObject;if(void 0===bObject)throw new Error("Failed to decode object");return aObject._rintf&&this._object_weakmap.set(bObject,aObject._rintf),bObject}async _wrap(e,t){return await this._encode(e,t)}async _unwrap(e,t){return await this._decode(e,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise(async(r,i)=>{var o=await n._wrap(Array.prototype.slice.call(arguments)),s=o.__transferables__;s&&delete o.__transferables__,r.__rpc_pair=i,i.__rpc_pair=r;try{n._connection.emit({type:"callback",target_id:e,id:t,args:o,promise:await n._wrap([r,i])},s)}catch(e){i(`Failed to exectue remote callback ( id: ${t}).`)}})}:async function(){var r=await n._wrap(Array.prototype.slice.call(arguments)),i=r.__transferables__;return i&&delete r.__transferables__,n._connection.emit({type:"callback",target_id:e,id:t,args:r},i)}}disconnect(){this._connection.emit({type:"disconnect"}),setTimeout(()=>{this._connection.disconnect()},2e3)}}class ReferenceStore{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t=this._store[e];if(t&&!t.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),t&&t.__rpc_pair){const e=getKeyByValue(this._store,t.__rpc_pair);this.fetch(e)}return t}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(1);function i(e,t){t=t||{};const r={},i=new n.b(e,t,r);i.on("getInterface",(function(){c()})),i.on("remoteReady",(function(){const e=i.getRemote()||{};if(e.export)throw new Error("`export` is a reserved function name");if(e.onload)throw new Error("`onload` is a reserved function name");if(e.dispose)throw new Error("`dispose` is a reserved function name");e.registerCodec=function(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(r))r[t].type!==e.type&&t!==e.name||(delete r[t],console.warn("Remove duplicated codec: "+t));r[e.name]=e},e.disposeObject=function(e){i.disposeObject(e)},e.export=function(e,t){i.setInterface(e,t)},e.onLoad=function(e){e=a(e),o?e():s.push(e)},e.dispose=function(e){i.disconnect()},"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"})):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));let o=!1;const s=[],c=function(){if(!o){let e;for(o=!0;e=s.pop();)e()}},a=function(e){const t=typeof e;if("function"!==t){throw new Error("A function may only be subsribed to the event, "+t+" was provided instead")}return e};return i}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0);!function(){if(!("undefined"!=typeof WorkerGlobalScope&&self&&self instanceof WorkerGlobalScope))throw new Error("This script can only loaded in a webworker");class Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__.a{constructor(e){super(e&&e.debug),this.config=e||{}}connect(){self.addEventListener("message",e=>{this._fire(e.data.type,e.data)}),this.emit({type:"initialized",config:this.config})}disconnect(){this._fire("beforeDisconnect"),self.close(),this._fire("disconnected")}emit(e){let t=void 0;e.__transferables__&&(t=e.__transferables__,delete e.__transferables__),self.postMessage(e,t)}async execute(code){if("requirements"===code.type)try{if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{Array.isArray(code.requirements)||(code.requirements=[code.requirements]);for(var i=0;i<code.requirements.length;i++){if(code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:"))throw"unable to import css in a webworker";code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),importScripts(code.requirements[i])):code.requirements[i].startsWith("http")?importScripts(code.requirements[i]):code.requirements[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+code.requirements[i])}}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}}catch(e){throw e}else{if("script"!==code.type)throw"unsupported code type.";try{if(code.requirements&&(Array.isArray(code.requirements)||"string"==typeof code.requirements))try{if(Array.isArray(code.requirements))for(let e=0;e<code.requirements.length;e++)importScripts(code.requirements[e]);else importScripts(code.requirements)}catch(e){throw"failed to import required scripts: "+code.requirements.toString()}eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}}"requirements"===code.type&&self.postMessage({type:"cacheRequirements",requirements:code.requirements})}}const config={type:"web-worker",dedicated_thread:!0,allow_execution:!0,lang:"javascript",api_version:_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a},conn=new Connection(config);conn.on("connectRPC",e=>{Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(conn,Object.assign(e.config,config))}),conn.connect(),self.postMessage({type:"worker-ready"})}()}]);\n//# sourceMappingURL=plugin.webworker.js.map',null)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return setupWebPython}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_pluginIframe__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(2);function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}const _importScript=function(e){return new Promise((t,r)=>{var n=document.createElement("script");n.src=e,n.onload=t,n.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},n.onerror=r,document.head.appendChild(n)})};async function importScripts(){for(var e=Array.prototype.slice.call(arguments),t=e.length,r=0;r<t;r++)await _importScript(e[r])}const startup_script='\nfrom js import api\nimport sys\nfrom types import ModuleType\nm = ModuleType("imjoy")\nsys.modules[m.__name__] = m\nm.__file__ = m.__name__ + ".py"\nm.api = api\n';let _export_plugin_api=null;const execute_python_code=function(e){try{_export_plugin_api||(_export_plugin_api=window.api.export,window.api.export=function(e){if("object"==typeof e){const t={};for(let r in e)r.startsWith("_")||(t[r]=e[r]);_export_plugin_api(t)}else{if("function"!=typeof e)throw"unsupported api export";{const t={},r=window.pyodide.pyimport("getattr"),n=window.pyodide.pyimport("hasattr");for(let i of Object.getOwnPropertyNames(e))if(!i.startsWith("_")&&n(e,i)){const n=r(e,i);t[i]=function(){return n(...Array.prototype.slice.call(arguments))}}_export_plugin_api(t)}}}),window.pyodide.runPython(startup_script),window.pyodide.runPython(e.content)}catch(e){throw e}};function setupPyodide(){return new Promise((e,t)=>{window.languagePluginUrl="https://static.imjoy.io/pyodide/",importScripts("https://static.imjoy.io/pyodide/pyodide.js").then(()=>{window.iodide={output:{element:function(e){const t=document.createElement(e);return(document.getElementById("output")||document.body).appendChild(t),t}}},window.languagePluginLoader.then(()=>{console.log(window.pyodide.runPython("import sys\nsys.version")),e()}).catch(t)})})}class Connection extends _pluginIframe__WEBPACK_IMPORTED_MODULE_2__.a{constructor(e){super(e)}async execute(code){if("requirements"===code.type){if(code.requirements){if(code.requirements="string"==typeof code.requirements?[code.requirements]:code.requirements,!Array.isArray(code.requirements))throw"unsupported requirements definition";{const e=[];for(var i=0;i<code.requirements.length;i++)code.requirements[i].toLowerCase().endsWith(".css")||code.requirements[i].startsWith("css:")?(code.requirements[i].startsWith("css:")&&(code.requirements[i]=code.requirements[i].slice(4)),link_node=document.createElement("link"),link_node.rel="stylesheet",link_node.href=code.requirements[i],document.head.appendChild(link_node)):code.requirements[i].startsWith("js:")?(code.requirements[i].startsWith("js:")&&(code.requirements[i]=code.requirements[i].slice(3)),await importScripts(code.requirements[i])):code.requirements[i].startsWith("cache:")||(code.requirements[i].toLowerCase().endsWith(".js")||code.requirements[i].startsWith("package:")?(code.requirements[i].startsWith("package:")&&(code.requirements[i]=code.requirements[i].slice(8)),e.push(code.requirements[i])):code.requirements[i].startsWith("http:")||code.requirements[i].startsWith("https:")?console.log("Unprocessed requirements url: "+code.requirements[i]):e.push(code.requirements[i]));await window.pyodide.loadPackage(e)}}}else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(code.content&&"python"===code.lang)execute_python_code(code);else if(code.content&&"javascript"===code.lang)try{eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}else{const e=document.createElement("script");e.setAttribute("type",code.attrs.type),e.appendChild(document.createTextNode(code.content)),document.body.appendChild(e)}else if("style"===code.type){const e=document.createElement("style");code.src&&(e.src=code.src),e.innerHTML=code.content,document.head.appendChild(e)}else if("link"===code.type){const e=document.createElement("link");code.rel&&(e.rel=code.rel),code.href&&(e.href=code.href),code.attrs&&code.attrs.type&&(e.type=code.attrs.type),document.head.appendChild(e)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}}}function setupWebPython(e){(e=e||{}).debug=!0,e.dedicated_thread=!1,e.lang="python",e.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a;const t=new Connection(e);setupPyodide().then(()=>{Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(t,e),t.connect()})}},function(e,t,r){"use strict";r.r(t),r.d(t,"waitForInitialization",(function(){return p})),r.d(t,"setupRPC",(function(){return l}));var n=r(5),i=r.n(n),o=r(2),s=r(6),c=r(0),a=r(1);r.d(t,"RPC",(function(){return a.b})),r.d(t,"API_VERSION",(function(){return a.a}));var _=r(4);function d(){try{return window.self!==window.top}catch(e){return!0}}function p(e){if(!d())throw new Error("waitForInitialization (imjoy-rpc) should only run inside an iframe.");const t=(e=e||{}).target_origin||"*";if(e.credential_required&&"function"!=typeof e.verify_credential)throw new Error("Please also provide the `verify_credential` function with `credential_required`.");if(e.credential_required&&"*"===t)throw new Error("`target_origin` was set to `*` with `credential_required=true`, there is a security risk that you may leak the credential to website from other origin. Please specify the `target_origin` explicitly.");const r=Object(c.c)(),n=i=>{if("message"===i.type&&("*"===t||i.origin===t)){if("initialize"!==i.data.type)throw new Error(`unrecognized message: ${i.data}`);{window.removeEventListener("message",n),i.data.peer_id!==r&&console.warn(`${i.data.config&&i.data.config.name}: connection peer id mismatch ${i.data.peer_id} !== ${r}`);const o=i.data.config;"*"!==t&&(o.target_origin=t),e.credential_required?e.verify_credential(o.credential).then(e=>{if(!e||!e.auth||e.error)throw new Error("Failed to verify the credentail:"+(e&&e.error));o.auth=e.auth,l(o).then(()=>{console.log("ImJoy RPC loaded successfully!")})}):l(o).then(()=>{console.log("ImJoy RPC loaded successfully!")})}}};window.addEventListener("message",n),parent.postMessage({type:"imjoyRPCReady",config:e,peer_id:r},"*")}function l(e){if(!(e=e||{}).name)throw new Error("Please specify a name for your app.");return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||Object(c.c)(),e.allow_execution=e.allow_execution||!1,e.enable_service_worker&&Object(c.d)(e.base_url,e.target_origin,e.cache_requirements),e.cache_requirements&&delete e.cache_requirements,e=Object.keys(e).reduce((t,r)=>("function"!=typeof e[r]&&(t[r]=e[r]),t),{}),new Promise((t,r)=>{if(d()){if("web-worker"===e.type)try{!function(e){if(!e.allow_execution)throw new Error("web-worker plugin can only work with allow_execution=true");const t=new i.a,r=setTimeout((function(){t.terminate(),console.warn("Plugin failed to start as a web-worker, running in an iframe instead."),Object(o.b)(e)}),2e3),n=Object(c.c)();t.addEventListener("message",(function(i){let o=void 0;const s=i.data;if("worker-ready"===s.type)return t.postMessage({type:"connectRPC",config:e}),void clearTimeout(r);"initialized"===s.type?(s.config=Object.assign({},e,s.config),s.origin=window.location.origin,s.peer_id=n):"imjoy_remote_api_ready"===s.type?window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:null})):"cacheRequirements"===s.type&&"function"==typeof cache_requirements?cache_requirements(s.requirements):"disconnect"===s.type?t.terminate():s.__transferables__&&(o=s.__transferables__,delete s.__transferables__),parent.postMessage(s,e.target_origin||"*",o)})),window.addEventListener("message",(function(r){let i=void 0;const o=r.data;o.__transferables__&&(i=o.__transferables__,delete o.__transferables__),o.peer_id===n?t.postMessage(o,i):e.debug&&console.log(`connection peer id mismatch ${o.peer_id} !== ${n}`)}))}(e)}catch(t){Object(o.b)(e)}else"web-python"===e.type||"web-python-window"===e.type?Object(s.a)(e):["rpc-window","rpc-worker","iframe","window"].includes(e.type)?Object(o.b)(e):(console.error("Unsupported plugin type: "+e.type),r("Unsupported plugin type: "+e.type));try{const r=n=>{const i=n.detail;e.expose_api_globally&&(window.api=i),t(i),window.removeEventListener("imjoy_remote_api_ready",r)};window.addEventListener("imjoy_remote_api_ready",r)}catch(e){r(e)}}else r(new Error("imjoy-rpc should only run inside an iframe."))})}r.d(t,"VERSION",(function(){return _.a}))},function(e,t,r){"use strict";var n=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var r;try{(r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),r=r.getBlob()}catch(t){r=new Blob([e])}return new Worker(n.createObjectURL(r))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}}])}));
//# sourceMappingURL=imjoy-rpc.min.js.map