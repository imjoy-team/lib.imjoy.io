{"version":3,"sources":["webpack://imjoyRPC/webpack/universalModuleDefinition","webpack://imjoyRPC/webpack/bootstrap","webpack://imjoyRPC/./src/rpc.js","webpack://imjoyRPC/./src/utils.js","webpack://imjoyRPC/./src/pluginCore.js","webpack://imjoyRPC/./src/pluginIframe.js","webpack://imjoyRPC/./src/plugin.webworker.js","webpack://imjoyRPC/./src/pluginWebPython.js","webpack://imjoyRPC/./src/main.js","webpack://imjoyRPC/./node_modules/worker-loader/dist/workers/InlineWorker.js"],"names":["root","factory","exports","module","define","amd","window","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","API_VERSION","ArrayBufferView","getPrototypeOf","Uint8Array","constructor","_appendBuffer","buffer1","buffer2","tmp","byteLength","set","buffer","RPC","connection","config","this","_connection","_interface","_plugin_interfaces","_remote","_remoteUpdateHandler","_getInterfaceHandler","_interfaceSetAsRemoteHandler","_disconnectHandler","_store","ReferenceStore","_method_refs","me","onMessage","data","_processMessage","onRemoteUpdate","handler","onRemoteReady","onReady","onRemoteBusy","onBusy","getRemoteCallStack","getStack","onGetInterface","getRemote","setInterface","forwarding_functions","func_name","args","Function","sendInterface","Promise","resolve","names","Error","keys","startsWith","push","type","data2","k","functions","getOwnPropertyNames","concat","length","name_","send","api","reject","method","result","_method_context","__this__","pid","promise","_unwrap","console","error","indexOf","split","apply","then","catch","e","fetch","num","_setRemote","disconnect","requestRemote","_ndarray","typedArray","shape","dtype","_dtype","typedArrayToDtype","__jailed_type__","__value__","__shape__","__dtype__","_genRemoteMethod","_reportRemoteSet","plugin_id","remoteMethod","id","put","wrapped_resolve","arguments","wrapped_reject","__jailed_pairs__","Array","slice","transferables","_wrap","__transferables__","__remote_method","_encode_interface","aObject","bObject","v","encoded_interface","randId","__plugin_id__","isArray","on","_encode","as_interface","_transfer","isarray","__as_interface__","_rpcEncode","encoded_obj","__rpc_dtype__","interfaceFuncName","tf","Tensor","v_buffer","dataSync","nj","NdArray","selection","toString","File","__relative_path__","relativePath","webkitRelativePath","Boolean","String","Date","RegExp","Blob","ImageData","FileList","ArrayBuffer","_decode","callbackId","withPromise","_rpcDecode","_genRemoteCallback","array","reduce","reshape","tensor","argNum","setTimeout","onDisconnect","_indices","_readyHandler","_busyHandler","readyHandler","busyHandler","_genId","shift","_releaseId","splice","pop","obj","_id","find","Math","random","substr","Int8Array","Int16Array","Int32Array","Uint16Array","Uint32Array","Float32Array","Float64Array","cacheUrlInServiceWorker","url","message","command","navigator","serviceWorker","register","messageChannel","MessageChannel","port1","onmessage","event","controller","postMessage","port2","async","cacheRequirements","requirements","req","setupServiceWorker","targetOrigin","cacheCallback","addEventListener","registration","log","scope","err","origin","connectRPC","application","rpc","launchConnected","remote","export","onload","dispose","onLoad","whenConnected","WorkerGlobalScope","self","dispatchEvent","CustomEvent","detail","connected","connectedHandlers","checkHandler","setupIframe","target_origin","_htmlToElement","html","template","document","createElement","trim","innerHTML","content","firstChild","_importScript","scriptTag","src","onreadystatechange","readyState","onerror","head","appendChild","importScripts","len","execute","code","link_node","toLowerCase","endsWith","rel","href","script_node","setAttribute","attrs","node","createTextNode","body","eval","style_node","link_node_","parent","stack","conn","h","_messageHandler","dedicated_thread","lang","api_version","allow_execution","warn","setupWebPython","startup_script","_export_plugin_api","execute_python_code","_api","getattr","pyodide","pyimport","hasattr","func","runPython","python_packages","loadPackage","languagePluginUrl","iodide","output","element","div","getElementById","languagePluginLoader","setupBaseFrame","paramName","qArray","location","search","substring","pArr","getParamValue","enable_service_worker","cache_requirements","undefined","includes","imjoyRPC","setupRPC","version","description","token","top","inIframe","worker","PluginWorker","fallbackTimeout","terminate","clearTimeout","assign","setupWebWorker","URL","webkitURL","blob","BlobBuilder","WebKitBlobBuilder","MozBlobBuilder","MSBlobBuilder","append","getBlob","Worker","createObjectURL","encodeURIComponent"],"mappings":"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","file":"imjoy-rpc.min.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"imjoyRPC\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"imjoyRPC\"] = factory();\n\telse\n\t\troot[\"imjoyRPC\"] = factory();\n})(window, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 7);\n","/**\n * Contains the RPC object used both by the application\n * site, and by each plugin\n */\nimport { randId, typedArrayToDtype } from \"./utils.js\";\n\nexport const API_VERSION = \"0.2.0\";\n\nconst ArrayBufferView = Object.getPrototypeOf(\n  Object.getPrototypeOf(new Uint8Array())\n).constructor;\n\nfunction _appendBuffer(buffer1, buffer2) {\n  const tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n  tmp.set(new Uint8Array(buffer1), 0);\n  tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n  return tmp.buffer;\n}\n\nfunction getKeyByValue(object, value) {\n  return Object.keys(object).find(key => object[key] === value);\n}\n/**\n * RPC object represents a single site in the\n * communication protocol between the application and the plugin\n *\n * @param {Object} connection a special object allowing to send\n * and receive messages from the opposite site (basically it\n * should only provide send() and onMessage() methods)\n */\nexport class RPC {\n  constructor(connection, config) {\n    this._connection = connection;\n    this.config = config || {};\n    this._interface = {};\n    this._plugin_interfaces = {};\n    this._remote = null;\n    this._remoteUpdateHandler = function() {};\n    this._getInterfaceHandler = function() {};\n    this._interfaceSetAsRemoteHandler = null;\n    this._disconnectHandler = function() {};\n    this._store = new ReferenceStore();\n    this._method_refs = new ReferenceStore();\n    this._connection = connection;\n    let me = this;\n    this._connection.onMessage(function(data) {\n      me._processMessage(data);\n    });\n  }\n\n  /**\n   * Set a handler to be called when the remote site updates its\n   * interface\n   *\n   * @param {Function} handler\n   */\n  onRemoteUpdate(handler) {\n    this._remoteUpdateHandler = handler;\n  }\n\n  /**\n   * Set a handler to be called when received a responce from the\n   * remote site reporting that the previously provided interface\n   * has been successfully set as remote for that site\n   *\n   * @param {Function} handler\n   */\n\n  onRemoteReady(handler) {\n    this._method_refs.onReady(handler);\n  }\n\n  onRemoteBusy(handler) {\n    this._method_refs.onBusy(handler);\n  }\n\n  getRemoteCallStack() {\n    return this._method_refs.getStack();\n  }\n  /**\n   * Set a handler to be called when the remote site requests to\n   * (re)send the interface. Used to detect an initialzation\n   * completion without sending additional request, since in fact\n   * 'getInterface' request is only sent by application at the last\n   * step of the plugin initialization\n   *\n   * @param {Function} handler\n   */\n  onGetInterface(handler) {\n    this._getInterfaceHandler = handler;\n  }\n\n  /**\n   * @returns {Object} set of remote interface methods\n   */\n  getRemote() {\n    return this._remote;\n  }\n\n  /**\n   * Sets the interface of this site making it available to the\n   * remote site by sending a message with a set of methods names\n   *\n   * @param {Object} _interface to set\n   */\n  setInterface(_interface) {\n    if (this.config.forwarding_functions) {\n      for (let func_name of this.config.forwarding_functions) {\n        if (this._remote[func_name]) {\n          if (_interface.constructor === Object) {\n            if (!_interface[func_name]) {\n              _interface[func_name] = (...args) => {\n                this._remote[func_name](...args);\n              };\n            }\n          } else if (_interface.constructor.constructor === Function) {\n            if (!_interface.constructor.prototype[func_name]) {\n              _interface.constructor.prototype[func_name] = (...args) => {\n                this._remote[func_name](...args);\n              };\n            }\n          }\n        }\n      }\n    }\n    this._interface = _interface;\n  }\n\n  /**\n   * Sends the actual interface to the remote site upon it was\n   * updated or by a special request of the remote site\n   */\n  sendInterface() {\n    return new Promise(resolve => {\n      var names = [];\n      if (!this._interface) {\n        throw new Error(\"interface is not set.\");\n      }\n      if (this._interface.constructor === Object) {\n        for (var name of Object.keys(this._interface)) {\n          if (name.startsWith(\"_\")) continue;\n          if (typeof this._interface[name] === \"function\") {\n            names.push({ name: name, data: null, type: \"function\" });\n          } else {\n            var data = this._interface[name];\n            if (data !== null && typeof data === \"object\") {\n              var data2 = {};\n              for (var k of Object.keys(data)) {\n                if (typeof data[k] === \"function\") {\n                  data2[k] = \"rpc_method::\" + k;\n                } else {\n                  data2[k] = data[k];\n                }\n              }\n              names.push({ name: name, data: data2, type: \"object\" });\n            } else if (Object(data) !== data) {\n              names.push({ name: name, data: data, type: \"data\" });\n            }\n          }\n        }\n      }\n      // a class\n      else if (this._interface.constructor === Function) {\n        throw new Error(\"Please instantiate the class before exportting it.\");\n      }\n      // instance of a class\n      else if (this._interface.constructor.constructor === Function) {\n        var functions = Object.getOwnPropertyNames(\n          Object.getPrototypeOf(this._interface)\n        ).concat(Object.keys(this._interface));\n        for (var i = 0; i < functions.length; i++) {\n          var name_ = functions[i];\n          if (name_.startsWith(\"_\") || name_ === \"constructor\") continue;\n          if (typeof this._interface[name_] === \"function\") {\n            names.push({ name: name_, data: null });\n          }\n        }\n      } else {\n        throw Error(\"Unsupported interface type\");\n      }\n      this._interfaceSetAsRemoteHandler = resolve;\n      this._connection.send({ type: \"setInterface\", api: names });\n    });\n  }\n\n  /**\n   * Handles a message from the remote site\n   */\n  // var callback_reg = new RegExp(\"onupdate|run$\")\n  _processMessage(data) {\n    var resolve, reject, method, args, result;\n    switch (data.type) {\n      case \"method\":\n        var _interface = this._interface;\n        var _method_context = _interface.__this__ || _interface;\n        if (data.pid) {\n          _interface = this._plugin_interfaces[data.pid];\n          if (!_interface) {\n            if (data.promise) {\n              [resolve, reject] = this._unwrap(data.promise, false);\n              reject(\n                `plugin api function is not avaialbe in \"${data.pid}\", the plugin maybe terminated.`\n              );\n            } else {\n              console.error(\n                `plugin api function is not avaialbe in ${data.pid}, the plugin maybe terminated.`\n              );\n            }\n            return;\n          }\n        }\n        if (data.name.indexOf(\".\") !== -1) {\n          var names = data.name.split(\".\");\n          method = _interface[names[0]][names[1]];\n        } else {\n          method = _interface[data.name];\n        }\n        args = this._unwrap(data.args, true);\n        if (data.promise) {\n          [resolve, reject] = this._unwrap(data.promise, false);\n          try {\n            result = method.apply(_method_context, args);\n            if (\n              result instanceof Promise ||\n              (method.constructor &&\n                method.constructor.name === \"AsyncFunction\")\n            ) {\n              result.then(resolve).catch(reject);\n            } else {\n              resolve(result);\n            }\n          } catch (e) {\n            console.error(e, method);\n            reject(e);\n          }\n        } else {\n          try {\n            method.apply(_method_context, args);\n          } catch (e) {\n            console.error(e, method, args);\n          }\n        }\n\n        break;\n      case \"callback\":\n        if (data.promise) {\n          [resolve, reject] = this._unwrap(data.promise, false);\n          try {\n            method = this._store.fetch(data.num);\n            args = this._unwrap(data.args, true);\n            if (!method) {\n              throw \"Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.\";\n            }\n            result = method.apply(null, args);\n            if (\n              result instanceof Promise ||\n              (method.constructor &&\n                method.constructor.name === \"AsyncFunction\")\n            ) {\n              result.then(resolve).catch(reject);\n            } else {\n              resolve(result);\n            }\n          } catch (e) {\n            console.error(e, method);\n            reject(e);\n          }\n        } else {\n          try {\n            method = this._store.fetch(data.num);\n            args = this._unwrap(data.args, true);\n            if (!method) {\n              throw \"Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.\";\n            }\n            method.apply(null, args);\n          } catch (e) {\n            console.error(e, method, args);\n          }\n        }\n        break;\n      case \"setInterface\":\n        this._setRemote(data.api);\n        break;\n      case \"getInterface\":\n        this.sendInterface();\n        this._getInterfaceHandler();\n        break;\n      case \"interfaceSetAsRemote\":\n        if (typeof this._interfaceSetAsRemoteHandler === \"function\") {\n          this._interfaceSetAsRemoteHandler();\n          this._interfaceSetAsRemoteHandler === null;\n        }\n        break;\n      case \"disconnect\":\n        this._disconnectHandler();\n        this._connection.disconnect();\n        break;\n    }\n  }\n\n  /**\n   * Sends a requests to the remote site asking it to provide its\n   * current interface\n   */\n  requestRemote() {\n    this._connection.send({ type: \"getInterface\" });\n  }\n\n  _ndarray(typedArray, shape, dtype) {\n    var _dtype = typedArrayToDtype[typedArray.constructor.name];\n    if (dtype && dtype !== _dtype) {\n      throw \"dtype doesn't match the type of the array: \" +\n        _dtype +\n        \" != \" +\n        dtype;\n    }\n    shape = shape || [typedArray.length];\n    return {\n      __jailed_type__: \"ndarray\",\n      __value__: typedArray,\n      __shape__: shape,\n      __dtype__: _dtype\n    };\n  }\n\n  /**\n   * Sets the new remote interface provided by the other site\n   *\n   * @param {Array} names list of function names\n   */\n  _setRemote(api) {\n    this._remote = {};\n    var i, name, data, type;\n    for (i = 0; i < api.length; i++) {\n      name = api[i].name;\n      data = api[i].data;\n      type = api[i].type;\n      if (type === \"data\") {\n        this._remote[name] = data;\n      } else if (data) {\n        if (typeof data === \"object\") {\n          var data2 = {};\n          for (var key in data) {\n            if (data.hasOwnProperty(key)) {\n              if (data[key] === \"rpc_method::\" + key) {\n                data2[key] = this._genRemoteMethod(name + \".\" + key);\n              } else {\n                data2[key] = data[key];\n              }\n            }\n          }\n          this._remote[name] = data2;\n        } else {\n          this._remote[name] = data;\n        }\n      } else {\n        this._remote[name] = this._genRemoteMethod(name);\n      }\n    }\n\n    this._remoteUpdateHandler();\n    this._reportRemoteSet();\n  }\n\n  /**\n   * Generates the wrapped function corresponding to a single remote\n   * method. When the generated function is called, it will send the\n   * corresponding message to the remote site asking it to execute\n   * the particular method of its interface\n   *\n   * @param {String} name of the remote method\n   *\n   * @returns {Function} wrapped remote method\n   */\n  _genRemoteMethod(name, plugin_id) {\n    var me = this;\n    var remoteMethod = function() {\n      return new Promise((resolve, reject) => {\n        let id = null;\n        try {\n          id = me._method_refs.put(plugin_id ? plugin_id + \"/\" + name : name);\n          var wrapped_resolve = function() {\n            if (id !== null) me._method_refs.fetch(id);\n            return resolve.apply(this, arguments);\n          };\n          var wrapped_reject = function() {\n            if (id !== null) me._method_refs.fetch(id);\n            return reject.apply(this, arguments);\n          };\n\n          wrapped_resolve.__jailed_pairs__ = wrapped_reject;\n          wrapped_reject.__jailed_pairs__ = wrapped_resolve;\n\n          var args = Array.prototype.slice.call(arguments);\n          if (name === \"register\" || name === \"export\" || name === \"on\") {\n            args = me._wrap(args, true);\n          } else {\n            args = me._wrap(args);\n          }\n          var transferables = args.args.__transferables__;\n          if (transferables) delete args.args.__transferables__;\n          me._connection.send(\n            {\n              type: \"method\",\n              name: name,\n              pid: plugin_id,\n              args: args,\n              promise: me._wrap([wrapped_resolve, wrapped_reject])\n            },\n            transferables\n          );\n        } catch (e) {\n          if (id) me._method_refs.fetch(id);\n          reject(\n            `Failed to exectue remote method (plugin: ${plugin_id ||\n              me.id}, method: ${name}), error: ${e}`\n          );\n        }\n      });\n    };\n    remoteMethod.__remote_method = true;\n    return remoteMethod;\n  }\n\n  /**\n   * Sends a responce reporting that interface just provided by the\n   * remote site was successfully set by this site as remote\n   */\n  _reportRemoteSet() {\n    this._connection.send({ type: \"interfaceSetAsRemote\" });\n  }\n\n  /**\n   * Prepares the provided set of remote method arguments for\n   * sending to the remote site, replaces all the callbacks with\n   * identifiers\n   *\n   * @param {Array} args to wrap\n   *\n   * @returns {Array} wrapped arguments\n   */\n\n  _encode_interface(aObject, bObject) {\n    var v, k;\n    const encoded_interface = {};\n    aObject[\"__id__\"] = aObject[\"__id__\"] || randId();\n    for (k in aObject) {\n      if (k === \"hasOwnProperty\") continue;\n      if (aObject.hasOwnProperty(k)) {\n        if (k.startsWith(\"_\")) {\n          continue;\n        }\n        v = aObject[k];\n\n        if (typeof v === \"function\") {\n          bObject[k] = {\n            __jailed_type__: \"plugin_interface\",\n            __plugin_id__: aObject[\"__id__\"],\n            __value__: k,\n            num: null\n          };\n          encoded_interface[k] = v;\n        } else if (Object(v) !== v) {\n          bObject[k] = { __jailed_type__: \"argument\", __value__: v };\n          encoded_interface[k] = v;\n        } else if (typeof v === \"object\") {\n          bObject[k] = Array.isArray(v) ? [] : {};\n          this._encode_interface(v, bObject[k]);\n        }\n      }\n    }\n    this._plugin_interfaces[aObject[\"__id__\"]] = encoded_interface;\n\n    if (aObject.on) {\n      aObject.on(\"close\", () => {\n        delete this._plugin_interfaces[aObject[\"__id__\"]];\n      });\n    }\n  }\n\n  _encode(aObject, as_interface) {\n    var transferables = [];\n    if (!aObject) {\n      return aObject;\n    }\n    var _transfer = aObject._transfer;\n    var bObject, v, k;\n    var isarray = Array.isArray(aObject);\n    bObject = isarray ? [] : {};\n    //skip if already encoded\n    if (\n      typeof aObject === \"object\" &&\n      aObject.__jailed_type__ &&\n      aObject.__value__\n    ) {\n      return aObject;\n    }\n\n    //encode interfaces\n    if (\n      typeof aObject === \"object\" &&\n      !Array.isArray(aObject) &&\n      (aObject.__as_interface__ || as_interface)\n    ) {\n      this._encode_interface(aObject, bObject);\n      return bObject;\n    }\n\n    if (as_interface) {\n      aObject[\"__id__\"] = aObject[\"__id__\"] || randId();\n      this._plugin_interfaces[aObject[\"__id__\"]] =\n        this._plugin_interfaces[aObject[\"__id__\"]] || {};\n    }\n    for (k in aObject) {\n      if (k === \"hasOwnProperty\") continue;\n      if (isarray || aObject.hasOwnProperty(k)) {\n        v = aObject[k];\n        if (typeof this._interface._rpcEncode === \"function\") {\n          const encoded_obj = this._interface._rpcEncode(v);\n          if (encoded_obj && encoded_obj.__rpc_dtype__) {\n            bObject[k] = {\n              __jailed_type__: \"custom_encoding\",\n              __value__: encoded_obj\n            };\n            continue;\n          }\n          // if the returned object does not contain __jailed_type__, assuming the object has been transformed\n          else {\n            v = encoded_obj;\n          }\n        }\n        if (typeof v === \"function\") {\n          if (as_interface) {\n            const encoded_interface = this._plugin_interfaces[\n              aObject[\"__id__\"]\n            ];\n            bObject[k] = {\n              __jailed_type__: \"plugin_interface\",\n              __plugin_id__: aObject[\"__id__\"],\n              __value__: k,\n              num: null\n            };\n            encoded_interface[k] = v;\n            continue;\n          }\n          let interfaceFuncName = null;\n          for (var name in this._interface) {\n            if (this._interface.hasOwnProperty(name)) {\n              if (name.startsWith(\"_\")) continue;\n              if (this._interface[name] === v) {\n                interfaceFuncName = name;\n                break;\n              }\n            }\n          }\n          // search for prototypes\n          var functions = Object.getOwnPropertyNames(\n            Object.getPrototypeOf(this._interface)\n          );\n          for (var i = 0; i < functions.length; i++) {\n            var name_ = functions[i];\n            if (name_.startsWith(\"_\")) continue;\n            if (this._interface[name_] === v) {\n              interfaceFuncName = name_;\n              break;\n            }\n          }\n          if (!interfaceFuncName) {\n            var id = this._store.put(v);\n            bObject[k] = {\n              __jailed_type__: \"callback\",\n              __value__: (v.constructor && v.constructor.name) || id,\n              num: id\n            };\n          } else {\n            bObject[k] = {\n              __jailed_type__: \"interface\",\n              __value__: interfaceFuncName,\n              num: null\n            };\n          }\n        } else if (\n          /*global tf*/\n          typeof tf !== \"undefined\" &&\n          tf.Tensor &&\n          v instanceof tf.Tensor\n        ) {\n          const v_buffer = v.dataSync();\n          if (v._transfer || _transfer) {\n            transferables.push(v_buffer.buffer);\n            delete v._transfer;\n          }\n          bObject[k] = {\n            __jailed_type__: \"ndarray\",\n            __value__: v_buffer,\n            __shape__: v.shape,\n            __dtype__: v.dtype\n          };\n        } else if (\n          /*global nj*/\n          typeof nj !== \"undefined\" &&\n          nj.NdArray &&\n          v instanceof nj.NdArray\n        ) {\n          var dtype = typedArrayToDtype[v.selection.data.constructor.name];\n          if (v._transfer || _transfer) {\n            transferables.push(v.selection.data.buffer);\n            delete v._transfer;\n          }\n          bObject[k] = {\n            __jailed_type__: \"ndarray\",\n            __value__: v.selection.data,\n            __shape__: v.shape,\n            __dtype__: dtype\n          };\n        } else if (v instanceof Error) {\n          console.error(v);\n          bObject[k] = { __jailed_type__: \"error\", __value__: v.toString() };\n        } else if (typeof File !== \"undefined\" && v instanceof File) {\n          bObject[k] = {\n            __jailed_type__: \"file\",\n            __value__: v,\n            __relative_path__: v.relativePath || v.webkitRelativePath\n          };\n        }\n        // send objects supported by structure clone algorithm\n        // https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\n        else if (\n          v !== Object(v) ||\n          v instanceof Boolean ||\n          v instanceof String ||\n          v instanceof Date ||\n          v instanceof RegExp ||\n          v instanceof Blob ||\n          v instanceof ImageData ||\n          (typeof FileList !== \"undefined\" && v instanceof FileList)\n        ) {\n          bObject[k] = { __jailed_type__: \"argument\", __value__: v };\n        } else if (v instanceof ArrayBuffer) {\n          if (v._transfer || _transfer) {\n            transferables.push(v);\n            delete v._transfer;\n          }\n          bObject[k] = { __jailed_type__: \"argument\", __value__: v };\n        } else if (v instanceof ArrayBufferView) {\n          if (v._transfer || _transfer) {\n            transferables.push(v.buffer);\n            delete v._transfer;\n          }\n          bObject[k] = { __jailed_type__: \"argument\", __value__: v };\n        }\n        // TODO: support also Map and Set\n        // TODO: avoid object such as DynamicPlugin instance.\n        else if (v.__as_interface__) {\n          bObject[k] = this._encode(v, true);\n        } else if (typeof v === \"object\" || Array.isArray(v)) {\n          bObject[k] = this._encode(v, as_interface);\n          // move transferables to the top level object\n          if (bObject[k].__transferables__) {\n            for (var t = 0; t < bObject[k].__transferables__.length; t++) {\n              transferables.push(bObject[k].__transferables__[t]);\n            }\n            delete bObject[k].__transferables__;\n          }\n        } else if (typeof v === \"object\" && v.constructor) {\n          throw \"Unsupported data type for transferring between the plugin and the main app: \" +\n            k +\n            \" : \" +\n            v.constructor.name;\n        } else {\n          throw \"Unsupported data type for transferring between the plugin and the main app: \" +\n            k +\n            \",\" +\n            v;\n        }\n      }\n    }\n    if (transferables.length > 0) {\n      bObject.__transferables__ = transferables;\n    }\n    return bObject;\n  }\n\n  _decode(aObject, callbackId, withPromise) {\n    if (!aObject) {\n      return aObject;\n    }\n    var bObject, v, k;\n\n    if (\n      aObject.hasOwnProperty(\"__jailed_type__\") &&\n      aObject.hasOwnProperty(\"__value__\")\n    ) {\n      if (aObject.__jailed_type__.startsWith(\"custom_encoding\")) {\n        if (typeof this._interface._rpcDecode === \"function\") {\n          const decodedObj = this._interface._rpcDecode(aObject.__value__);\n          bObject = decodedObj;\n        } else {\n          bObject = aObject;\n        }\n      } else if (aObject.__jailed_type__ === \"callback\") {\n        bObject = this._genRemoteCallback(callbackId, aObject.num, withPromise);\n      } else if (aObject.__jailed_type__ === \"interface\") {\n        bObject =\n          this._remote[aObject.__value__] ||\n          this._genRemoteMethod(aObject.__value__);\n      } else if (aObject.__jailed_type__ === \"plugin_interface\") {\n        bObject = this._genRemoteMethod(\n          aObject.__value__,\n          aObject.__plugin_id__\n        );\n      } else if (aObject.__jailed_type__ === \"ndarray\") {\n        /*global nj tf*/\n        //create build array/tensor if used in the plugin\n        if (this.id === \"__plugin__\" && typeof nj !== \"undefined\" && nj.array) {\n          if (Array.isArray(aObject.__value__)) {\n            aObject.__value__ = aObject.__value__.reduce(_appendBuffer);\n          }\n          bObject = nj\n            .array(aObject.__value__, aObject.__dtype__)\n            .reshape(aObject.__shape__);\n        } else if (\n          this.id === \"__plugin__\" &&\n          typeof tf !== \"undefined\" &&\n          tf.Tensor\n        ) {\n          if (Array.isArray(aObject.__value__)) {\n            aObject.__value__ = aObject.__value__.reduce(_appendBuffer);\n          }\n          bObject = tf.tensor(\n            aObject.__value__,\n            aObject.__shape__,\n            aObject.__dtype__\n          );\n        } else {\n          //keep it as regular if transfered to the main app\n          bObject = aObject;\n        }\n      } else if (aObject.__jailed_type__ === \"error\") {\n        bObject = new Error(aObject.__value__);\n      } else if (aObject.__jailed_type__ === \"file\") {\n        bObject = aObject.__value__;\n        //patch relativePath\n        bObject.relativePath = aObject.__relative_path__;\n      } else if (aObject.__jailed_type__ === \"argument\") {\n        bObject = aObject.__value__;\n      }\n      return bObject;\n    } else {\n      var isarray = Array.isArray(aObject);\n      bObject = isarray ? [] : {};\n      for (k in aObject) {\n        if (isarray || aObject.hasOwnProperty(k)) {\n          v = aObject[k];\n          if (typeof v === \"object\" || Array.isArray(v)) {\n            bObject[k] = this._decode(v, callbackId, withPromise);\n          }\n        }\n      }\n      return bObject;\n    }\n  }\n\n  _wrap(args, as_interface) {\n    var wrapped = this._encode(args, as_interface);\n    var result = { args: wrapped };\n    return result;\n  }\n\n  /**\n   * Unwraps the set of arguments delivered from the remote site,\n   * replaces all callback identifiers with a function which will\n   * initiate sending that callback identifier back to other site\n   *\n   * @param {Object} args to unwrap\n   *\n   * @param {Boolean} withPromise is true means this the callback should contain a promise\n   *\n   * @returns {Array} unwrapped args\n   */\n  _unwrap(args, withPromise) {\n    // var called = false;\n\n    // wraps each callback so that the only one could be called\n    // var once(cb) {\n    //     return function() {\n    //         if (!called) {\n    //             called = true;\n    //             return cb.apply(this, arguments);\n    //         } else {\n    //             var msg =\n    //               'A callback from this set has already been executed';\n    //             throw new Error(msg);\n    //         }\n    //     };\n    // }\n    var result = this._decode(args.args, args.callbackId, withPromise);\n    return result;\n  }\n\n  /**\n   * Generates the wrapped function corresponding to a single remote\n   * callback. When the generated function is called, it will send\n   * the corresponding message to the remote site asking it to\n   * execute the particular callback previously saved during a call\n   * by the remote site a method from the interface of this site\n   *\n   * @param {Number} id of the remote callback to execute\n   * @param {Number} argNum argument index of the callback\n   * @param {Boolean} withPromise is true means this the callback should contain a promise\n   *\n   * @returns {Function} wrapped remote callback\n   */\n  _genRemoteCallback(id, argNum, withPromise) {\n    var me = this;\n    var remoteCallback;\n    if (withPromise) {\n      remoteCallback = function() {\n        return new Promise((resolve, reject) => {\n          var args = me._wrap(Array.prototype.slice.call(arguments));\n          var transferables = args.args.__transferables__;\n          if (transferables) delete args.args.__transferables__;\n          resolve.__jailed_pairs__ = reject;\n          reject.__jailed_pairs__ = resolve;\n          try {\n            me._connection.send(\n              {\n                type: \"callback\",\n                id: id,\n                num: argNum,\n                args: args,\n                // pid :  me.id,\n                promise: me._wrap([resolve, reject])\n              },\n              transferables\n            );\n          } catch (e) {\n            reject(\n              `Failed to exectue remote callback (id: ${id}, argNum: ${argNum}).`\n            );\n          }\n        });\n      };\n      return remoteCallback;\n    } else {\n      remoteCallback = function() {\n        var args = me._wrap(Array.prototype.slice.call(arguments));\n        var transferables = args.args.__transferables__;\n        if (transferables) delete args.args.__transferables__;\n        return me._connection.send(\n          {\n            type: \"callback\",\n            id: id,\n            num: argNum,\n            args: args\n            // pid :  me.id\n          },\n          transferables\n        );\n      };\n      return remoteCallback;\n    }\n  }\n\n  /**\n   * Sends the notification message and breaks the connection\n   */\n  disconnect() {\n    this._connection.send({ type: \"disconnect\" });\n    setTimeout(this._connection.disconnect, 2000);\n  }\n\n  /**\n   * Set a handler to be called when received a disconnect message\n   * from the remote site\n   *\n   * @param {Function} handler\n   */\n  onDisconnect(handler) {\n    this._disconnectHandler = handler;\n  }\n}\n\n/**\n * ReferenceStore is a special object which stores other objects\n * and provides the references (number) instead. This reference\n * may then be sent over a json-based communication channel (IPC\n * to another Node.js process or a message to the Worker). Other\n * site may then provide the reference in the responce message\n * implying the given object should be activated.\n *\n * Primary usage for the ReferenceStore is a storage for the\n * callbacks, which therefore makes it possible to initiate a\n * callback execution by the opposite site (which normally cannot\n * directly execute functions over the communication channel).\n *\n * Each stored object can only be fetched once and is not\n * available for the second time. Each stored object must be\n * fetched, since otherwise it will remain stored forever and\n * consume memory.\n *\n * Stored object indeces are simply the numbers, which are however\n * released along with the objects, and are later reused again (in\n * order to postpone the overflow, which should not likely happen,\n * but anyway).\n */\nclass ReferenceStore {\n  constructor() {\n    this._store = {}; // stored object\n    this._indices = [0]; // smallest available indices\n    this._readyHandler = function() {};\n    this._busyHandler = function() {};\n    this._readyHandler();\n  }\n\n  /**\n   * call handler when the store is empty\n   *\n   * @param {FUNCTION} id of a handler\n   */\n  onReady(readyHandler) {\n    this._readyHandler = readyHandler || function() {};\n  }\n\n  /**\n   * call handler when the store is not empty\n   *\n   * @param {FUNCTION} id of a handler\n   */\n  onBusy(busyHandler) {\n    this._busyHandler = busyHandler || function() {};\n  }\n\n  /**\n   * get the length of the store\n   *\n   */\n  getStack() {\n    return Object.keys(this._store).length;\n  }\n\n  /**\n   * @function _genId() generates the new reference id\n   *\n   * @returns {Number} smallest available id and reserves it\n   */\n  _genId() {\n    var id;\n    if (this._indices.length === 1) {\n      id = this._indices[0]++;\n    } else {\n      id = this._indices.shift();\n    }\n\n    return id;\n  }\n\n  /**\n   * Releases the given reference id so that it will be available by\n   * another object stored\n   *\n   * @param {Number} id to release\n   */\n  _releaseId(id) {\n    for (var i = 0; i < this._indices.length; i++) {\n      if (id < this._indices[i]) {\n        this._indices.splice(i, 0, id);\n        break;\n      }\n    }\n\n    // cleaning-up the sequence tail\n    for (i = this._indices.length - 1; i >= 0; i--) {\n      if (this._indices[i] - 1 === this._indices[i - 1]) {\n        this._indices.pop();\n      } else {\n        break;\n      }\n    }\n  }\n\n  /**\n   * Stores the given object and returns the refernce id instead\n   *\n   * @param {Object} obj to store\n   *\n   * @returns {Number} reference id of the stored object\n   */\n  put(obj) {\n    if (this._busyHandler && Object.keys(this._store).length === 0) {\n      this._busyHandler();\n    }\n    var id = this._genId();\n    this._store[id] = obj;\n    return id;\n  }\n\n  /**\n   * Retrieves previously stored object and releases its reference\n   *\n   * @param {Number} id of an object to retrieve\n   */\n  fetch(id) {\n    var obj = this._store[id];\n    if (obj && !obj.__remote_method) {\n      delete this._store[id];\n      this._releaseId(id);\n      if (this._readyHandler && Object.keys(this._store).length === 0) {\n        this._readyHandler();\n      }\n    }\n    if (obj && obj.__jailed_pairs__) {\n      const _id = getKeyByValue(this._store, obj.__jailed_pairs__);\n      this.fetch(_id);\n    }\n    return obj;\n  }\n\n  /**\n   * Retrieves previously stored object\n   *\n   * @param {Number} id of an object to retrieve\n   */\n  // retrieve(id) {\n  //     var obj = this._store[id];\n  //     return obj;\n  // }\n}\n","export function randId() {\n  return Math.random()\n    .toString(36)\n    .substr(2, 10);\n}\n\nexport const dtypeToTypedArray = {\n  int8: \"Int8Array\",\n  int16: \"Int16Array\",\n  int32: \"Int32Array\",\n  uint8: \"Uint8Array\",\n  uint16: \"Uint16Array\",\n  uint32: \"Uint32Array\",\n  float32: \"Float32Array\",\n  float64: \"Float64Array\",\n  array: \"Array\"\n};\nexport const typedArrayToDtype = {\n  Int8Array: \"int8\",\n  Int16Array: \"int16\",\n  Int32Array: \"int32\",\n  Uint8Array: \"uint8\",\n  Uint16Array: \"uint16\",\n  Uint32Array: \"uint32\",\n  Float32Array: \"float32\",\n  Float64Array: \"float64\",\n  Array: \"array\"\n};\n\nfunction cacheUrlInServiceWorker(url) {\n  return new Promise(function(resolve, reject) {\n    const message = {\n      command: \"add\",\n      url: url\n    };\n    if (!navigator.serviceWorker || !navigator.serviceWorker.register) {\n      reject(\"Service worker is not supported.\");\n      return;\n    }\n    const messageChannel = new MessageChannel();\n    messageChannel.port1.onmessage = function(event) {\n      if (event.data && event.data.error) {\n        reject(event.data.error);\n      } else {\n        resolve(event.data && event.data.result);\n      }\n    };\n\n    if (navigator.serviceWorker && navigator.serviceWorker.controller) {\n      navigator.serviceWorker.controller.postMessage(message, [\n        messageChannel.port2\n      ]);\n    } else {\n      reject(\"Service worker controller is not available\");\n    }\n  });\n}\n\nexport async function cacheRequirements(requirements) {\n  if (requirements && requirements.length > 0) {\n    for (let req of requirements) {\n      //remove prefix\n      if (req.startsWith(\"js:\")) req = req.slice(3);\n      if (req.startsWith(\"css:\")) req = req.slice(4);\n      if (req.startsWith(\"cache:\")) req = req.slice(6);\n      if (!req.startsWith(\"http\")) continue;\n\n      await cacheUrlInServiceWorker(req).catch(e => {\n        console.error(e);\n      });\n    }\n  }\n}\n\nexport function setupServiceWorker(targetOrigin, cacheCallback) {\n  // register service worker for offline access\n  if (\"serviceWorker\" in navigator) {\n    window.addEventListener(\"load\", function() {\n      navigator.serviceWorker.register(\"/plugin-service-worker.js\").then(\n        function(registration) {\n          // Registration was successful\n          console.log(\n            \"ServiceWorker registration successful with scope: \",\n            registration.scope\n          );\n        },\n        function(err) {\n          // registration failed :(\n          console.log(\"ServiceWorker registration failed: \", err);\n        }\n      );\n      targetOrigin = targetOrigin || \"*\";\n      cacheCallback = cacheCallback || cacheRequirements;\n      if (cacheCallback && typeof cacheCallback !== \"function\") {\n        throw new Error(\"config.cache_requirements must be a function\");\n      }\n      window.addEventListener(\"message\", function(e) {\n        if (targetOrigin === \"*\" || e.origin === targetOrigin) {\n          const m = e.data;\n          if (m.type === \"cacheRequirements\") {\n            cacheCallback(m.requirements);\n          }\n        }\n      });\n    });\n  }\n}\n\n//#Source https://bit.ly/2neWfJ2\nexport function urlJoin(...args) {\n  return args\n    .join(\"/\")\n    .replace(/[\\/]+/g, \"/\")\n    .replace(/^(.+):\\//, \"$1://\")\n    .replace(/^file:/, \"file:/\")\n    .replace(/\\/(\\?|&|#[^!])/g, \"$1\")\n    .replace(/\\?/g, \"&\")\n    .replace(\"&\", \"?\");\n}\n","/**\n * Core plugin script loaded into the plugin process/thread.\n *\n * Initializes the plugin-site API global methods.\n */\nimport { RPC } from \"./rpc.js\";\n\nexport function connectRPC(connection, config) {\n  const application = {};\n  config = config || {};\n\n  const rpc = new RPC(connection, config);\n  rpc.onGetInterface(function() {\n    launchConnected();\n  });\n\n  rpc.onRemoteUpdate(function() {\n    application.remote = rpc.getRemote();\n    if (!application.remote) return;\n    const api = application.remote || {};\n    if (api.export) {\n      console.error(\"WARNING: overwriting function 'export'.\");\n    }\n    if (api.onload) {\n      console.error(\"WARNING: overwriting function 'onload'.\");\n    }\n    if (api.dispose) {\n      console.error(\"WARNING: overwriting function 'dispose'.\");\n    }\n    api.export = application.setInterface;\n    api.onLoad = application.whenConnected;\n    api.dispose = application.disconnect;\n    if (\n      typeof WorkerGlobalScope !== \"undefined\" &&\n      self instanceof WorkerGlobalScope\n    ) {\n      self.api = api;\n      self.postMessage({\n        type: \"imjoy_remote_api_ready\"\n      });\n    } else if (typeof window) {\n      window.dispatchEvent(\n        new CustomEvent(\"imjoy_remote_api_ready\", { detail: api })\n      );\n    }\n  });\n\n  var connected = false;\n  var connectedHandlers = [];\n\n  var launchConnected = function() {\n    if (!connected) {\n      connected = true;\n\n      var handler;\n      while ((handler = connectedHandlers.pop())) {\n        handler();\n      }\n    }\n  };\n\n  var checkHandler = function(handler) {\n    var type = typeof handler;\n    if (type !== \"function\") {\n      var msg =\n        \"A function may only be subsribed to the event, \" +\n        type +\n        \" was provided instead\";\n      throw new Error(msg);\n    }\n\n    return handler;\n  };\n\n  /**\n   * Sets a function executed after the connection to the\n   * application is estaplished, and the initial interface-exchange\n   * messaging is completed\n   *\n   * @param {Function} handler to be called upon initialization\n   */\n  application.whenConnected = function(handler) {\n    handler = checkHandler(handler);\n    if (connected) {\n      handler();\n    } else {\n      connectedHandlers.push(handler);\n    }\n  };\n\n  /**\n   * Sets the plugin interface available to the application\n   *\n   * @param {Object} _interface to set\n   */\n  application.setInterface = function(_interface) {\n    rpc.setInterface(_interface);\n  };\n\n  /**\n   * Disconnects the plugin from the application (sending\n   * notification message) and destroys itself\n   */\n  application.disconnect = function(_interface) {\n    rpc.disconnect();\n  };\n}\n","/**\n * Contains the routines loaded by the plugin iframe under web-browser\n * in case when worker failed to initialize\n *\n * Initializes the web environment version of the platform-dependent\n * connection object for the plugin site\n */\nimport { connectRPC } from \"./pluginCore.js\";\nimport { API_VERSION } from \"./rpc.js\";\n\nexport default function setupIframe(config) {\n  config = config || {};\n  const targetOrigin = config.target_origin || \"*\";\n  // Create a new, plain <span> element\n  function _htmlToElement(html) {\n    var template = document.createElement(\"template\");\n    html = html.trim(); // Never return a text node of whitespace as the result\n    template.innerHTML = html;\n    return template.content.firstChild;\n  }\n\n  var _importScript = function(url) {\n    //url is URL of external file, implementationCode is the code\n    //to be called from the file, location is the location to\n    //insert the <script> element\n    return new Promise((resolve, reject) => {\n      var scriptTag = document.createElement(\"script\");\n      scriptTag.src = url;\n      scriptTag.type = \"text/javascript\";\n      scriptTag.onload = resolve;\n      scriptTag.onreadystatechange = function() {\n        if (this.readyState === \"loaded\" || this.readyState === \"complete\") {\n          resolve();\n        }\n      };\n      scriptTag.onerror = reject;\n      document.head.appendChild(scriptTag);\n    });\n  };\n\n  // support importScripts outside web worker\n\n  async function importScripts() {\n    var args = Array.prototype.slice.call(arguments),\n      len = args.length,\n      i = 0;\n    for (; i < len; i++) {\n      await _importScript(args[i]);\n    }\n  }\n\n  // evaluates the provided string\n  var execute = async function(code) {\n    try {\n      if (code.type === \"requirements\") {\n        if (\n          code.requirements &&\n          (Array.isArray(code.requirements) ||\n            typeof code.requirements === \"string\")\n        ) {\n          try {\n            var link_node;\n            code.requirements =\n              typeof code.requirements === \"string\"\n                ? [code.requirements]\n                : code.requirements;\n            if (Array.isArray(code.requirements)) {\n              for (var i = 0; i < code.requirements.length; i++) {\n                if (\n                  code.requirements[i].toLowerCase().endsWith(\".css\") ||\n                  code.requirements[i].startsWith(\"css:\")\n                ) {\n                  if (code.requirements[i].startsWith(\"css:\")) {\n                    code.requirements[i] = code.requirements[i].slice(4);\n                  }\n                  link_node = document.createElement(\"link\");\n                  link_node.rel = \"stylesheet\";\n                  link_node.href = code.requirements[i];\n                  document.head.appendChild(link_node);\n                } else if (\n                  code.requirements[i].toLowerCase().endsWith(\".js\") ||\n                  code.requirements[i].startsWith(\"js:\")\n                ) {\n                  if (code.requirements[i].startsWith(\"js:\")) {\n                    code.requirements[i] = code.requirements[i].slice(3);\n                  }\n                  await importScripts(code.requirements[i]);\n                } else if (code.requirements[i].startsWith(\"http\")) {\n                  await importScripts(code.requirements[i]);\n                } else if (code.requirements[i].startsWith(\"cache:\")) {\n                  //ignore cache\n                } else {\n                  console.log(\n                    \"Unprocessed requirements url: \" + code.requirements[i]\n                  );\n                }\n              }\n            } else {\n              throw \"unsupported requirements definition\";\n            }\n          } catch (e) {\n            throw \"failed to import required scripts: \" +\n              code.requirements.toString();\n          }\n        }\n      } else if (code.type === \"script\") {\n        if (code.src) {\n          var script_node = document.createElement(\"script\");\n          script_node.setAttribute(\"type\", code.attrs.type);\n          script_node.setAttribute(\"src\", code.src);\n          document.head.appendChild(script_node);\n        } else {\n          if (\n            code.content &&\n            (!code.attrs.type || code.attrs.type === \"text/javascript\")\n          ) {\n            // document.addEventListener(\"DOMContentLoaded\", function(){\n            eval(code.content);\n            // });\n          } else {\n            var node = document.createElement(\"script\");\n            node.setAttribute(\"type\", code.attrs.type);\n            node.appendChild(document.createTextNode(code.content));\n            document.body.appendChild(node);\n          }\n        }\n      } else if (code.type === \"style\") {\n        var style_node = document.createElement(\"style\");\n        if (code.src) {\n          style_node.src = code.src;\n        }\n        style_node.innerHTML = code.content;\n        document.head.appendChild(style_node);\n      } else if (code.type === \"link\") {\n        var link_node_ = document.createElement(\"link\");\n        if (code.rel) {\n          link_node_.rel = code.rel;\n        }\n        if (code.href) {\n          link_node_.href = code.href;\n        }\n        if (code.attrs && code.attrs.type) {\n          link_node_.type = code.attrs.type;\n        }\n        document.head.appendChild(link_node_);\n      } else if (code.type === \"html\") {\n        document.body.appendChild(_htmlToElement(code.content));\n      } else {\n        throw \"unsupported code type.\";\n      }\n      parent.postMessage({ type: \"executeSuccess\" }, targetOrigin);\n    } catch (e) {\n      console.error(\"failed to execute scripts: \", code, e);\n      parent.postMessage(\n        { type: \"executeFailure\", error: e.stack || String(e) },\n        targetOrigin\n      );\n    }\n  };\n\n  // connection object for the RPC constructor\n  const conn = {\n    disconnect: function() {},\n    send: function(data, transferables) {\n      parent.postMessage(data, targetOrigin, transferables);\n    },\n    onMessage: function(h) {\n      conn._messageHandler = h;\n    },\n    _messageHandler: function() {},\n    onDisconnect: function() {}\n  };\n\n  config.dedicated_thread = false;\n  config.lang = \"javascript\";\n  config.api_version = API_VERSION;\n\n  // event listener for the plugin message\n  window.addEventListener(\"message\", function(e) {\n    if (targetOrigin === \"*\" || e.origin === targetOrigin) {\n      const m = e.data;\n      switch (m && m.type) {\n        case \"getConfig\":\n          parent.postMessage(\n            {\n              type: \"config\",\n              config: config\n            },\n            targetOrigin\n          );\n          break;\n        case \"execute\":\n          if (config.allow_execution) {\n            execute(m.code);\n            if (m.code.type === \"requirements\") {\n              if (!Array.isArray(m.code.requirements)) {\n                m.code.requirements = [m.code.requirements];\n              }\n            }\n          } else {\n            console.warn(\n              \"import script is not allowed (allow_execution=false)\"\n            );\n          }\n          break;\n        default:\n          conn._messageHandler(m);\n      }\n    }\n  });\n\n  connectRPC(conn, {\n    forwarding_functions: config.forwarding_functions\n  });\n\n  parent.postMessage(\n    {\n      type: \"initialized\",\n      config: config\n    },\n    targetOrigin\n  );\n}\n","module.exports = function() {\n  return require(\"!!/Users/wei.ouyang/workspace/imjoy-rpc/javascript/node_modules/worker-loader/dist/workers/InlineWorker.js\")(\"!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){\\\"undefined\\\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\\\"Module\\\"}),Object.defineProperty(e,\\\"__esModule\\\",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&\\\"object\\\"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,\\\"default\\\",{enumerable:!0,value:e}),2&t&&\\\"string\\\"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,\\\"a\\\",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p=\\\"\\\",r(r.s=2)}([function(e,t,r){\\\"use strict\\\";function n(){return Math.random().toString(36).substr(2,10)}const i={Int8Array:\\\"int8\\\",Int16Array:\\\"int16\\\",Int32Array:\\\"int32\\\",Uint8Array:\\\"uint8\\\",Uint16Array:\\\"uint16\\\",Uint32Array:\\\"uint32\\\",Float32Array:\\\"float32\\\",Float64Array:\\\"float64\\\",Array:\\\"array\\\"};r.d(t,\\\"a\\\",(function(){return _})),r.d(t,\\\"b\\\",(function(){return a}));const _=\\\"0.2.0\\\",o=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function s(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}class a{constructor(e,t){this._connection=e,this.config=t||{},this._interface={},this._plugin_interfaces={},this._remote=null,this._remoteUpdateHandler=function(){},this._getInterfaceHandler=function(){},this._interfaceSetAsRemoteHandler=null,this._disconnectHandler=function(){},this._store=new c,this._method_refs=new c,this._connection=e;let r=this;this._connection.onMessage((function(e){r._processMessage(e)}))}onRemoteUpdate(e){this._remoteUpdateHandler=e}onRemoteReady(e){this._method_refs.onReady(e)}onRemoteBusy(e){this._method_refs.onBusy(e)}getRemoteCallStack(){return this._method_refs.getStack()}onGetInterface(e){this._getInterfaceHandler=e}getRemote(){return this._remote}setInterface(e){if(this.config.forwarding_functions)for(let t of this.config.forwarding_functions)this._remote[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{this._remote[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{this._remote[t](...e)})));this._interface=e}sendInterface(){return new Promise(e=>{var t=[];if(!this._interface)throw new Error(\\\"interface is not set.\\\");if(this._interface.constructor===Object){for(var r of Object.keys(this._interface))if(!r.startsWith(\\\"_\\\"))if(\\\"function\\\"==typeof this._interface[r])t.push({name:r,data:null,type:\\\"function\\\"});else{var n=this._interface[r];if(null!==n&&\\\"object\\\"==typeof n){var i={};for(var _ of Object.keys(n))\\\"function\\\"==typeof n[_]?i[_]=\\\"rpc_method::\\\"+_:i[_]=n[_];t.push({name:r,data:i,type:\\\"object\\\"})}else Object(n)!==n&&t.push({name:r,data:n,type:\\\"data\\\"})}}else{if(this._interface.constructor===Function)throw new Error(\\\"Please instantiate the class before exportting it.\\\");if(this._interface.constructor.constructor!==Function)throw Error(\\\"Unsupported interface type\\\");for(var o=Object.getOwnPropertyNames(Object.getPrototypeOf(this._interface)).concat(Object.keys(this._interface)),s=0;s<o.length;s++){var a=o[s];a.startsWith(\\\"_\\\")||\\\"constructor\\\"===a||\\\"function\\\"==typeof this._interface[a]&&t.push({name:a,data:null})}}this._interfaceSetAsRemoteHandler=e,this._connection.send({type:\\\"setInterface\\\",api:t})})}_processMessage(e){var t,r,n,i,_;switch(e.type){case\\\"method\\\":var o=this._interface,s=o.__this__||o;if(e.pid&&!(o=this._plugin_interfaces[e.pid]))return void(e.promise?([t,r]=this._unwrap(e.promise,!1),r(`plugin api function is not avaialbe in \\\"${e.pid}\\\", the plugin maybe terminated.`)):console.error(`plugin api function is not avaialbe in ${e.pid}, the plugin maybe terminated.`));if(-1!==e.name.indexOf(\\\".\\\")){var a=e.name.split(\\\".\\\");n=o[a[0]][a[1]]}else n=o[e.name];if(i=this._unwrap(e.args,!0),e.promise){[t,r]=this._unwrap(e.promise,!1);try{(_=n.apply(s,i))instanceof Promise||n.constructor&&\\\"AsyncFunction\\\"===n.constructor.name?_.then(t).catch(r):t(_)}catch(e){console.error(e,n),r(e)}}else try{n.apply(s,i)}catch(e){console.error(e,n,i)}break;case\\\"callback\\\":if(e.promise){[t,r]=this._unwrap(e.promise,!1);try{if(n=this._store.fetch(e.num),i=this._unwrap(e.args,!0),!n)throw\\\"Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.\\\";(_=n.apply(null,i))instanceof Promise||n.constructor&&\\\"AsyncFunction\\\"===n.constructor.name?_.then(t).catch(r):t(_)}catch(e){console.error(e,n),r(e)}}else try{if(n=this._store.fetch(e.num),i=this._unwrap(e.args,!0),!n)throw\\\"Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.\\\";n.apply(null,i)}catch(e){console.error(e,n,i)}break;case\\\"setInterface\\\":this._setRemote(e.api);break;case\\\"getInterface\\\":this.sendInterface(),this._getInterfaceHandler();break;case\\\"interfaceSetAsRemote\\\":\\\"function\\\"==typeof this._interfaceSetAsRemoteHandler&&(this._interfaceSetAsRemoteHandler(),this._interfaceSetAsRemoteHandler);break;case\\\"disconnect\\\":this._disconnectHandler(),this._connection.disconnect()}}requestRemote(){this._connection.send({type:\\\"getInterface\\\"})}_ndarray(e,t,r){var n=i[e.constructor.name];if(r&&r!==n)throw\\\"dtype doesn't match the type of the array: \\\"+n+\\\" != \\\"+r;return{__jailed_type__:\\\"ndarray\\\",__value__:e,__shape__:t=t||[e.length],__dtype__:n}}_setRemote(e){var t,r,n;for(this._remote={},t=0;t<e.length;t++)if(r=e[t].name,n=e[t].data,\\\"data\\\"===e[t].type)this._remote[r]=n;else if(n)if(\\\"object\\\"==typeof n){var i={};for(var _ in n)n.hasOwnProperty(_)&&(n[_]===\\\"rpc_method::\\\"+_?i[_]=this._genRemoteMethod(r+\\\".\\\"+_):i[_]=n[_]);this._remote[r]=i}else this._remote[r]=n;else this._remote[r]=this._genRemoteMethod(r);this._remoteUpdateHandler(),this._reportRemoteSet()}_genRemoteMethod(e,t){var r=this,n=function(){return new Promise((n,i)=>{let _=null;try{_=r._method_refs.put(t?t+\\\"/\\\"+e:e);var o=function(){return null!==_&&r._method_refs.fetch(_),n.apply(this,arguments)},s=function(){return null!==_&&r._method_refs.fetch(_),i.apply(this,arguments)};o.__jailed_pairs__=s,s.__jailed_pairs__=o;var a=Array.prototype.slice.call(arguments),c=(a=\\\"register\\\"===e||\\\"export\\\"===e||\\\"on\\\"===e?r._wrap(a,!0):r._wrap(a)).args.__transferables__;c&&delete a.args.__transferables__,r._connection.send({type:\\\"method\\\",name:e,pid:t,args:a,promise:r._wrap([o,s])},c)}catch(n){_&&r._method_refs.fetch(_),i(`Failed to exectue remote method (plugin: ${t||r.id}, method: ${e}), error: ${n}`)}})};return n.__remote_method=!0,n}_reportRemoteSet(){this._connection.send({type:\\\"interfaceSetAsRemote\\\"})}_encode_interface(e,t){var r,i;const _={};for(i in e.__id__=e.__id__||n(),e)if(\\\"hasOwnProperty\\\"!==i&&e.hasOwnProperty(i)){if(i.startsWith(\\\"_\\\"))continue;\\\"function\\\"==typeof(r=e[i])?(t[i]={__jailed_type__:\\\"plugin_interface\\\",__plugin_id__:e.__id__,__value__:i,num:null},_[i]=r):Object(r)!==r?(t[i]={__jailed_type__:\\\"argument\\\",__value__:r},_[i]=r):\\\"object\\\"==typeof r&&(t[i]=Array.isArray(r)?[]:{},this._encode_interface(r,t[i]))}this._plugin_interfaces[e.__id__]=_,e.on&&e.on(\\\"close\\\",()=>{delete this._plugin_interfaces[e.__id__]})}_encode(e,t){var r=[];if(!e)return e;var _,s,a,c=e._transfer,f=Array.isArray(e);if(_=f?[]:{},\\\"object\\\"==typeof e&&e.__jailed_type__&&e.__value__)return e;if(\\\"object\\\"==typeof e&&!Array.isArray(e)&&(e.__as_interface__||t))return this._encode_interface(e,_),_;for(a in t&&(e.__id__=e.__id__||n(),this._plugin_interfaces[e.__id__]=this._plugin_interfaces[e.__id__]||{}),e)if(\\\"hasOwnProperty\\\"!==a&&(f||e.hasOwnProperty(a))){if(s=e[a],\\\"function\\\"==typeof this._interface._rpcEncode){const e=this._interface._rpcEncode(s);if(e&&e.__rpc_dtype__){_[a]={__jailed_type__:\\\"custom_encoding\\\",__value__:e};continue}s=e}if(\\\"function\\\"==typeof s){if(t){const t=this._plugin_interfaces[e.__id__];_[a]={__jailed_type__:\\\"plugin_interface\\\",__plugin_id__:e.__id__,__value__:a,num:null},t[a]=s;continue}let r=null;for(var l in this._interface)if(this._interface.hasOwnProperty(l)){if(l.startsWith(\\\"_\\\"))continue;if(this._interface[l]===s){r=l;break}}for(var u=Object.getOwnPropertyNames(Object.getPrototypeOf(this._interface)),d=0;d<u.length;d++){var p=u[d];if(!p.startsWith(\\\"_\\\")&&this._interface[p]===s){r=p;break}}if(r)_[a]={__jailed_type__:\\\"interface\\\",__value__:r,num:null};else{var h=this._store.put(s);_[a]={__jailed_type__:\\\"callback\\\",__value__:s.constructor&&s.constructor.name||h,num:h}}}else if(\\\"undefined\\\"!=typeof tf&&tf.Tensor&&s instanceof tf.Tensor){const e=s.dataSync();(s._transfer||c)&&(r.push(e.buffer),delete s._transfer),_[a]={__jailed_type__:\\\"ndarray\\\",__value__:e,__shape__:s.shape,__dtype__:s.dtype}}else if(\\\"undefined\\\"!=typeof nj&&nj.NdArray&&s instanceof nj.NdArray){var y=i[s.selection.data.constructor.name];(s._transfer||c)&&(r.push(s.selection.data.buffer),delete s._transfer),_[a]={__jailed_type__:\\\"ndarray\\\",__value__:s.selection.data,__shape__:s.shape,__dtype__:y}}else if(s instanceof Error)console.error(s),_[a]={__jailed_type__:\\\"error\\\",__value__:s.toString()};else if(\\\"undefined\\\"!=typeof File&&s instanceof File)_[a]={__jailed_type__:\\\"file\\\",__value__:s,__relative_path__:s.relativePath||s.webkitRelativePath};else if(s!==Object(s)||s instanceof Boolean||s instanceof String||s instanceof Date||s instanceof RegExp||s instanceof Blob||s instanceof ImageData||\\\"undefined\\\"!=typeof FileList&&s instanceof FileList)_[a]={__jailed_type__:\\\"argument\\\",__value__:s};else if(s instanceof ArrayBuffer)(s._transfer||c)&&(r.push(s),delete s._transfer),_[a]={__jailed_type__:\\\"argument\\\",__value__:s};else if(s instanceof o)(s._transfer||c)&&(r.push(s.buffer),delete s._transfer),_[a]={__jailed_type__:\\\"argument\\\",__value__:s};else if(s.__as_interface__)_[a]=this._encode(s,!0);else{if(\\\"object\\\"!=typeof s&&!Array.isArray(s))throw\\\"object\\\"==typeof s&&s.constructor?\\\"Unsupported data type for transferring between the plugin and the main app: \\\"+a+\\\" : \\\"+s.constructor.name:\\\"Unsupported data type for transferring between the plugin and the main app: \\\"+a+\\\",\\\"+s;if(_[a]=this._encode(s,t),_[a].__transferables__){for(var m=0;m<_[a].__transferables__.length;m++)r.push(_[a].__transferables__[m]);delete _[a].__transferables__}}}return r.length>0&&(_.__transferables__=r),_}_decode(e,t,r){if(!e)return e;var n,i,_;if(e.hasOwnProperty(\\\"__jailed_type__\\\")&&e.hasOwnProperty(\\\"__value__\\\")){if(e.__jailed_type__.startsWith(\\\"custom_encoding\\\"))if(\\\"function\\\"==typeof this._interface._rpcDecode){n=this._interface._rpcDecode(e.__value__)}else n=e;else\\\"callback\\\"===e.__jailed_type__?n=this._genRemoteCallback(t,e.num,r):\\\"interface\\\"===e.__jailed_type__?n=this._remote[e.__value__]||this._genRemoteMethod(e.__value__):\\\"plugin_interface\\\"===e.__jailed_type__?n=this._genRemoteMethod(e.__value__,e.__plugin_id__):\\\"ndarray\\\"===e.__jailed_type__?\\\"__plugin__\\\"===this.id&&\\\"undefined\\\"!=typeof nj&&nj.array?(Array.isArray(e.__value__)&&(e.__value__=e.__value__.reduce(s)),n=nj.array(e.__value__,e.__dtype__).reshape(e.__shape__)):\\\"__plugin__\\\"===this.id&&\\\"undefined\\\"!=typeof tf&&tf.Tensor?(Array.isArray(e.__value__)&&(e.__value__=e.__value__.reduce(s)),n=tf.tensor(e.__value__,e.__shape__,e.__dtype__)):n=e:\\\"error\\\"===e.__jailed_type__?n=new Error(e.__value__):\\\"file\\\"===e.__jailed_type__?(n=e.__value__).relativePath=e.__relative_path__:\\\"argument\\\"===e.__jailed_type__&&(n=e.__value__);return n}var o=Array.isArray(e);for(_ in n=o?[]:{},e)(o||e.hasOwnProperty(_))&&(\\\"object\\\"==typeof(i=e[_])||Array.isArray(i))&&(n[_]=this._decode(i,t,r));return n}_wrap(e,t){return{args:this._encode(e,t)}}_unwrap(e,t){return this._decode(e.args,e.callbackId,t)}_genRemoteCallback(e,t,r){var n=this;return r?function(){return new Promise((r,i)=>{var _=n._wrap(Array.prototype.slice.call(arguments)),o=_.args.__transferables__;o&&delete _.args.__transferables__,r.__jailed_pairs__=i,i.__jailed_pairs__=r;try{n._connection.send({type:\\\"callback\\\",id:e,num:t,args:_,promise:n._wrap([r,i])},o)}catch(r){i(`Failed to exectue remote callback (id: ${e}, argNum: ${t}).`)}})}:function(){var r=n._wrap(Array.prototype.slice.call(arguments)),i=r.args.__transferables__;return i&&delete r.args.__transferables__,n._connection.send({type:\\\"callback\\\",id:e,num:t,args:r},i)}}disconnect(){this._connection.send({type:\\\"disconnect\\\"}),setTimeout(this._connection.disconnect,2e3)}onDisconnect(e){this._disconnectHandler=e}}class c{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){return 1===this._indices.length?this._indices[0]++:this._indices.shift()}_releaseId(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0&&this._indices[t]-1===this._indices[t-1];t--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();var t=this._genId();return this._store[t]=e,t}fetch(e){var t,r,n=this._store[e];if(n&&!n.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),n&&n.__jailed_pairs__){const e=(t=this._store,r=n.__jailed_pairs__,Object.keys(t).find(e=>t[e]===r));this.fetch(e)}return n}}},function(e,t,r){\\\"use strict\\\";r.d(t,\\\"a\\\",(function(){return i}));var n=r(0);function i(e,t){const r={};t=t||{};const i=new n.b(e,t);i.onGetInterface((function(){s()})),i.onRemoteUpdate((function(){if(r.remote=i.getRemote(),!r.remote)return;const e=r.remote||{};e.export&&console.error(\\\"WARNING: overwriting function 'export'.\\\"),e.onload&&console.error(\\\"WARNING: overwriting function 'onload'.\\\"),e.dispose&&console.error(\\\"WARNING: overwriting function 'dispose'.\\\"),e.export=r.setInterface,e.onLoad=r.whenConnected,e.dispose=r.disconnect,\\\"undefined\\\"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:\\\"imjoy_remote_api_ready\\\"})):window.dispatchEvent(new CustomEvent(\\\"imjoy_remote_api_ready\\\",{detail:e}))}));var _=!1,o=[],s=function(){var e;if(!_)for(_=!0;e=o.pop();)e()};r.whenConnected=function(e){e=function(e){var t=typeof e;if(\\\"function\\\"!==t)throw new Error(\\\"A function may only be subsribed to the event, \\\"+t+\\\" was provided instead\\\");return e}(e),_?e():o.push(e)},r.setInterface=function(e){i.setInterface(e)},r.disconnect=function(e){i.disconnect()}}},function(module,__webpack_exports__,__webpack_require__){\\\"use strict\\\";__webpack_require__.r(__webpack_exports__);var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0);!function(){if(!(\\\"undefined\\\"!=typeof WorkerGlobalScope&&self&&self instanceof WorkerGlobalScope))throw new Error(\\\"This script can only loaded in a webworker\\\");var execute=function(code){try{if(\\\"requirements\\\"===code.type)try{if(code.requirements&&(Array.isArray(code.requirements)||\\\"string\\\"==typeof code.requirements))try{Array.isArray(code.requirements)||(code.requirements=[code.requirements]);for(var i=0;i<code.requirements.length;i++){if(code.requirements[i].toLowerCase().endsWith(\\\".css\\\")||code.requirements[i].startsWith(\\\"css:\\\"))throw\\\"unable to import css in a webworker\\\";code.requirements[i].toLowerCase().endsWith(\\\".js\\\")||code.requirements[i].startsWith(\\\"js:\\\")?(code.requirements[i].startsWith(\\\"js:\\\")&&(code.requirements[i]=code.requirements[i].slice(3)),importScripts(code.requirements[i])):code.requirements[i].startsWith(\\\"http\\\")?importScripts(code.requirements[i]):code.requirements[i].startsWith(\\\"cache:\\\")||console.log(\\\"Unprocessed requirements url: \\\"+code.requirements[i])}}catch(e){throw\\\"failed to import required scripts: \\\"+code.requirements.toString()}}catch(e){throw e}else{if(\\\"script\\\"!==code.type)throw\\\"unsupported code type.\\\";try{if(code.requirements&&(Array.isArray(code.requirements)||\\\"string\\\"==typeof code.requirements))try{if(Array.isArray(code.requirements))for(let e=0;e<code.requirements.length;e++)importScripts(code.requirements[e]);else importScripts(code.requirements)}catch(e){throw\\\"failed to import required scripts: \\\"+code.requirements.toString()}eval(code.content)}catch(e){throw console.error(e.message,e.stack),e}}self.postMessage({type:\\\"executeSuccess\\\"})}catch(e){console.error(\\\"failed to execute scripts: \\\",code,e),self.postMessage({type:\\\"executeFailure\\\",error:e.stack||String(e)})}};const conn={disconnect:function(){self.close()},send:function(e,t){e.__transferables__=t,self.postMessage(e,t)},onMessage:function(e){conn._messageHandler=e},_messageHandler:function(){},onDisconnect:function(){}},config={type:\\\"web-worker\\\",dedicated_thread:!0,allow_execution:!0,lang:\\\"javascript\\\",api_version:_rpc_js__WEBPACK_IMPORTED_MODULE_1__.a};self.addEventListener(\\\"message\\\",(function(e){const t=e.data;switch(t&&t.type){case\\\"getConfig\\\":self.postMessage({type:\\\"config\\\",config:config});break;case\\\"execute\\\":execute(t.code),\\\"requirements\\\"===t.code.type&&(Array.isArray(t.code.requirements)||(t.code.requirements=[t.code.requirements]),self.postMessage({type:\\\"cacheRequirements\\\",requirements:t.code.requirements}));break;case\\\"connectRPC\\\":Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.a)(conn,t.config);break;default:conn._messageHandler(t)}})),self.postMessage({type:\\\"initialized\\\",config:config})}()}]);\\n//# sourceMappingURL=imjoy-rpc-min-webworker.js.map\", null);\n};","/**\n * Contains the routines loaded by the plugin iframe under web-browser\n * in case when worker failed to initialize\n *\n * Initializes the web environment version of the platform-dependent\n * connection object for the plugin site\n */\n\nimport { connectRPC } from \"./pluginCore.js\";\nimport { API_VERSION } from \"./rpc.js\";\n\nexport default function setupWebPython(config) {\n  config = config || {};\n  // Create a new, plain <span> element\n  function _htmlToElement(html) {\n    var template = document.createElement(\"template\");\n    html = html.trim(); // Never return a text node of whitespace as the result\n    template.innerHTML = html;\n    return template.content.firstChild;\n  }\n\n  var _importScript = function(url) {\n    //url is URL of external file, implementationCode is the code\n    //to be called from the file, location is the location to\n    //insert the <script> element\n    return new Promise((resolve, reject) => {\n      var scriptTag = document.createElement(\"script\");\n      scriptTag.src = url;\n      scriptTag.onload = resolve;\n      scriptTag.onreadystatechange = function() {\n        if (this.readyState === \"loaded\" || this.readyState === \"complete\") {\n          resolve();\n        }\n      };\n      scriptTag.onerror = reject;\n      document.head.appendChild(scriptTag);\n    });\n  };\n\n  // support importScripts outside web worker\n\n  async function importScripts() {\n    var args = Array.prototype.slice.call(arguments),\n      len = args.length,\n      i = 0;\n    for (; i < len; i++) {\n      await _importScript(args[i]);\n    }\n  }\n\n  var startup_script = `\n  from js import api\n  import sys\n  from types import ModuleType\n  m = ModuleType(\"imjoy\")\n  sys.modules[m.__name__] = m\n  m.__file__ = m.__name__ + \".py\"\n  m.api = api\n  `;\n  var _export_plugin_api = null;\n  var execute_python_code = function(code) {\n    try {\n      if (!_export_plugin_api) {\n        _export_plugin_api = window.api.export;\n        window.api.export = function(p) {\n          if (typeof p === \"object\") {\n            const _api = {};\n            for (let k in p) {\n              if (!k.startsWith(\"_\")) {\n                _api[k] = p[k];\n              }\n            }\n            _export_plugin_api(_api);\n          } else if (typeof p === \"function\") {\n            const _api = {};\n            const getattr = window.pyodide.pyimport(\"getattr\");\n            const hasattr = window.pyodide.pyimport(\"hasattr\");\n            for (let k of Object.getOwnPropertyNames(p)) {\n              if (!k.startsWith(\"_\") && hasattr(p, k)) {\n                const func = getattr(p, k);\n                _api[k] = function() {\n                  return func(...Array.prototype.slice.call(arguments));\n                };\n              }\n            }\n            _export_plugin_api(_api);\n          } else {\n            throw \"unsupported api export\";\n          }\n        };\n      }\n      window.pyodide.runPython(startup_script);\n      window.pyodide.runPython(code.content);\n    } catch (e) {\n      throw e;\n    }\n  };\n\n  // evaluates the provided string\n  var execute = async function(code) {\n    try {\n      if (code.type === \"requirements\") {\n        if (code.requirements) {\n          code.requirements =\n            typeof code.requirements === \"string\"\n              ? [code.requirements]\n              : code.requirements;\n          if (Array.isArray(code.requirements)) {\n            const python_packages = [];\n            for (var i = 0; i < code.requirements.length; i++) {\n              if (\n                code.requirements[i].toLowerCase().endsWith(\".css\") ||\n                code.requirements[i].startsWith(\"css:\")\n              ) {\n                if (code.requirements[i].startsWith(\"css:\")) {\n                  code.requirements[i] = code.requirements[i].slice(4);\n                }\n                link_node = document.createElement(\"link\");\n                link_node.rel = \"stylesheet\";\n                link_node.href = code.requirements[i];\n                document.head.appendChild(link_node);\n              } else if (\n                // code.requirements[i].toLowerCase().endsWith(\".js\") ||\n                code.requirements[i].startsWith(\"js:\")\n              ) {\n                if (code.requirements[i].startsWith(\"js:\")) {\n                  code.requirements[i] = code.requirements[i].slice(3);\n                }\n                await importScripts(code.requirements[i]);\n              } else if (code.requirements[i].startsWith(\"cache:\")) {\n                //ignore cache\n              } else if (\n                code.requirements[i].toLowerCase().endsWith(\".js\") ||\n                code.requirements[i].startsWith(\"package:\")\n              ) {\n                if (code.requirements[i].startsWith(\"package:\")) {\n                  code.requirements[i] = code.requirements[i].slice(8);\n                }\n                python_packages.push(code.requirements[i]);\n              } else if (\n                code.requirements[i].startsWith(\"http:\") ||\n                code.requirements[i].startsWith(\"https:\")\n              ) {\n                console.log(\n                  \"Unprocessed requirements url: \" + code.requirements[i]\n                );\n              } else {\n                python_packages.push(code.requirements[i]);\n              }\n            }\n            await window.pyodide.loadPackage(python_packages);\n          } else {\n            throw \"unsupported requirements definition\";\n          }\n        }\n      } else if (code.type === \"script\") {\n        if (code.src) {\n          var script_node = document.createElement(\"script\");\n          script_node.setAttribute(\"type\", code.attrs.type);\n          script_node.setAttribute(\"src\", code.src);\n          document.head.appendChild(script_node);\n        } else {\n          if (code.content && code.lang === \"python\") {\n            execute_python_code(code);\n          } else if (code.content && code.lang === \"javascript\") {\n            try {\n              eval(code.content);\n            } catch (e) {\n              console.error(e.message, e.stack);\n              throw e;\n            }\n          } else {\n            var node = document.createElement(\"script\");\n            node.setAttribute(\"type\", code.attrs.type);\n            node.appendChild(document.createTextNode(code.content));\n            document.body.appendChild(node);\n          }\n        }\n      } else if (code.type === \"style\") {\n        var style_node = document.createElement(\"style\");\n        if (code.src) {\n          style_node.src = code.src;\n        }\n        style_node.innerHTML = code.content;\n        document.head.appendChild(style_node);\n      } else if (code.type === \"link\") {\n        var link_node = document.createElement(\"link\");\n        if (code.rel) {\n          link_node.rel = code.rel;\n        }\n        if (code.href) {\n          link_node.href = code.href;\n        }\n        if (code.attrs && code.attrs.type) {\n          link_node.type = code.attrs.type;\n        }\n        document.head.appendChild(link_node);\n      } else if (code.type === \"html\") {\n        document.body.appendChild(_htmlToElement(code.content));\n      } else {\n        throw \"unsupported code type.\";\n      }\n      parent.postMessage({ type: \"executeSuccess\" }, \"*\");\n    } catch (e) {\n      console.error(\"failed to execute scripts: \", code, e);\n      parent.postMessage(\n        { type: \"executeFailure\", error: e.stack || String(e) },\n        \"*\"\n      );\n    }\n  };\n  const targetOrigin = config.target_origin || \"*\";\n  // connection object for the RPC constructor\n  const conn = {\n    disconnect: function() {},\n    send: function(data, transferables) {\n      parent.postMessage(data, targetOrigin, transferables);\n    },\n    onMessage: function(h) {\n      conn._messageHandler = h;\n    },\n    _messageHandler: function() {},\n    onDisconnect: function() {}\n  };\n\n  config.dedicated_thread = false;\n  config.lang = \"python\";\n  config.api_version = API_VERSION;\n\n  // event listener for the plugin message\n  window.addEventListener(\"message\", function(e) {\n    if (targetOrigin === \"*\" || e.origin === targetOrigin) {\n      const m = e.data;\n      switch (m && m.type) {\n        case \"getConfig\":\n          parent.postMessage(\n            {\n              type: \"config\",\n              config: config\n            },\n            targetOrigin\n          );\n          break;\n        case \"execute\":\n          if (config.allow_execution) {\n            execute(m.code);\n            if (m.code.type === \"requirements\") {\n              if (!Array.isArray(m.code.requirements)) {\n                m.code.requirements = [m.code.requirements];\n              }\n            }\n          } else {\n            console.warn(\n              \"execute script is not allowed (allow_execution=false)\"\n            );\n          }\n          break;\n        default:\n          conn._messageHandler(m);\n      }\n    }\n  });\n\n  window.languagePluginUrl = \"https://static.imjoy.io/pyodide/\";\n\n  importScripts(\"https://static.imjoy.io/pyodide/pyodide.js\").then(() => {\n    // hack for matplotlib etc.\n    window.iodide = {\n      output: {\n        element: function element(type) {\n          const div = document.createElement(type);\n          const output = document.getElementById(\"output\") || document.body;\n          output.appendChild(div);\n          return div;\n        }\n      }\n    };\n\n    window.languagePluginLoader.then(() => {\n      // pyodide is now ready to use...\n      console.log(window.pyodide.runPython(\"import sys\\nsys.version\"));\n\n      connectRPC(conn, {\n        forwarding_functions: config.forwarding_functions\n      });\n      parent.postMessage(\n        {\n          type: \"initialized\",\n          config: config\n        },\n        targetOrigin\n      );\n    });\n  });\n}\n","/**\n * Contains the code executed in the sandboxed frame under web-browser\n *\n * Tries to create a Web-Worker inside the frame and set up the\n * communication between the worker and the parent window. Some\n * browsers restrict creating a worker inside a sandboxed iframe - if\n * this happens, the plugin initialized right inside the frame (in the\n * same thread)\n */\nimport PluginWorker from \"./plugin.webworker.js\";\nimport setupIframe from \"./pluginIframe.js\";\nimport setupWebPython from \"./pluginWebPython.js\";\nimport { setupServiceWorker, randId } from \"./utils.js\";\n\nexport { RPC, API_VERSION } from \"./rpc.js\";\nexport { version as VERSION } from \"../package.json\";\n\nfunction inIframe() {\n  try {\n    return window.self !== window.top;\n  } catch (e) {\n    return true;\n  }\n}\n\nfunction getParamValue(paramName) {\n  const url = window.location.search.substring(1); //get rid of \"?\" in querystring\n  const qArray = url.split(\"&\"); //get key-value pairs\n  for (let i = 0; i < qArray.length; i++) {\n    const pArr = qArray[i].split(\"=\"); //split key and value\n    if (pArr[0] === paramName) return pArr[1]; //return value\n  }\n}\n\n/**\n * Initializes the plugin inside a web worker. May throw an exception\n * in case this was not permitted by the browser.\n */\nfunction setupWebWorker(config) {\n  if (!config.allow_execution)\n    throw new Error(\n      \"web-worker plugin can only work with allow_execution=true\"\n    );\n  const worker = new PluginWorker();\n  // mixed content warning in Chrome silently skips worker\n  // initialization without exception, handling this with timeout\n  const fallbackTimeout = setTimeout(function() {\n    worker.terminate();\n    console.warn(\n      `Plugin failed to start as a web-worker, running in an iframe instead.`\n    );\n    setupIframe(config);\n  }, 2000);\n\n  // forwarding messages between the worker and parent window\n  worker.addEventListener(\"message\", function(e) {\n    let transferables = undefined;\n    const m = e.data;\n    if (m.type === \"initialized\") {\n      // send config to the worker\n      worker.postMessage({ type: \"connectRPC\", config: config });\n      clearTimeout(fallbackTimeout);\n      // complete the missing fields\n      m.config = Object.assign({}, config, m.config);\n    } else if (m.type === \"imjoy_remote_api_ready\") {\n      // if it's a webworker, there will be no api object returned\n      window.dispatchEvent(\n        new CustomEvent(\"imjoy_remote_api_ready\", { detail: null })\n      );\n    } else if (\n      m.type === \"cacheRequirements\" &&\n      typeof cache_requirements === \"function\"\n    ) {\n      cache_requirements(m.requirements);\n    } else if (m.type === \"disconnect\") {\n      worker.terminate();\n    } else {\n      if (m.__transferables__) {\n        transferables = m.__transferables__;\n        delete m.__transferables__;\n      }\n    }\n    parent.postMessage(m, \"*\", transferables);\n  });\n\n  window.addEventListener(\"message\", function(e) {\n    let transferables = undefined;\n    const m = e.data;\n    if (m.__transferables__) {\n      transferables = m.__transferables__;\n      delete m.__transferables__;\n    }\n    worker.postMessage(m, transferables);\n  });\n}\n\nexport async function setupBaseFrame(config) {\n  config = config || {};\n  config.name = config.name || \"Generic RPC App\";\n  config.type = config.type || getParamValue(\"_plugin_type\") || \"window\";\n  config.allow_execution = config.allow_execution || true;\n  config.enable_service_worker = config.enable_service_worker || true;\n  if (config.enable_service_worker) {\n    setupServiceWorker(config.target_origin, config.cache_requirements);\n  }\n  if (config.cache_requirements) {\n    delete config.cache_requirements;\n  }\n  config.forwarding_functions = config.forwarding_functions;\n  if (config.forwarding_functions === undefined) {\n    config.forwarding_functions = [\"close\", \"on\", \"off\", \"emit\"];\n    if ([\"rpc-window\", \"window\", \"web-python-window\"].includes(config.type)) {\n      config.forwarding_functions = config.forwarding_functions.concat([\n        \"resize\",\n        \"show\",\n        \"hide\",\n        \"refresh\"\n      ]);\n    }\n  }\n  // expose the api object to window globally.\n  // note: the returned value will be null for webworker\n  window.api = await imjoyRPC.setupRPC(config);\n  return window.api;\n}\n\nexport function setupRPC(config) {\n  config = config || {};\n  if (!config.name) throw new Error(\"Please specify a name for your app.\");\n  config.version = config.version || \"0.1.0\";\n  config.description =\n    config.description || `[TODO: add description for ${config.name} ]`;\n  config.type = config.type || \"rpc-window\";\n  config.id = config.id || randId();\n  config.allow_execution = config.allow_execution || false;\n  config.token = config.token || randId();\n  // remove functions\n  config = Object.keys(config).reduce((p, c) => {\n    if (typeof config[c] !== \"function\") p[c] = config[c];\n    return p;\n  }, {});\n  return new Promise((resolve, reject) => {\n    if (inIframe()) {\n      if (config.type === \"web-worker\") {\n        try {\n          setupWebWorker(config);\n        } catch (e) {\n          // fallback to iframe\n          setupIframe(config);\n        }\n      } else if (\n        config.type === \"web-python\" ||\n        config.type === \"web-python-window\"\n      ) {\n        setupWebPython(config);\n      } else if (\n        [\"rpc-window\", \"rpc-worker\", \"iframe\", \"window\"].includes(config.type)\n      ) {\n        setupIframe(config);\n      } else {\n        console.error(\"Unsupported plugin type: \" + config.type);\n        reject(\"Unsupported plugin type: \" + config.type);\n      }\n      try {\n        window.addEventListener(\"imjoy_remote_api_ready\", e => {\n          // imjoy plugin api\n          resolve(e.detail);\n        });\n      } catch (e) {\n        reject(e);\n      }\n    } else {\n      reject(new Error(\"imjoy-rpc should only run inside an iframe.\"));\n    }\n  });\n}\n","'use strict';\n\n// http://stackoverflow.com/questions/10343913/how-to-create-a-web-worker-from-a-string\n\nvar URL = window.URL || window.webkitURL;\n\nmodule.exports = function (content, url) {\n  try {\n    try {\n      var blob;\n\n      try {\n        // BlobBuilder = Deprecated, but widely implemented\n        var BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder;\n\n        blob = new BlobBuilder();\n\n        blob.append(content);\n\n        blob = blob.getBlob();\n      } catch (e) {\n        // The proposed API\n        blob = new Blob([content]);\n      }\n\n      return new Worker(URL.createObjectURL(blob));\n    } catch (e) {\n      return new Worker('data:application/javascript,' + encodeURIComponent(content));\n    }\n  } catch (e) {\n    if (!url) {\n      throw Error('Inline worker is not supported');\n    }\n\n    return new Worker(url);\n  }\n};"],"sourceRoot":""}