<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ImJoy Web App</title>
    <script src="./imjoy-lib.js"></script>
    <link rel="stylesheet" href="./joy.css">
    <link rel="stylesheet" href="https://static.imjoy.io/spectre.css/spectre.min.css">
    <link rel="stylesheet" href="https://static.imjoy.io/spectre.css/spectre-exp.min.css">
    <link rel="stylesheet" href="https://static.imjoy.io/spectre.css/spectre-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.15.3/axios.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            overflow-y: hidden;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            -webkit-transform: translate3d(0, 0, 0);
            /* Disables pull-to-refresh but allows overscroll glow effects. */
            overscroll-behavior-y: contain;
            overscroll-behavior-x: none;
            position: fixed;
            overflow-wrap: break-word;
        }
        .navbar .navbar-brand {
            font-size: 1.2rem;
        }
        .whiteboard{
            width: 100%;
            height: calc(100% - 36px);
        }
        .window_container{
            width: 100%;
            height: 100%;
        }
        .site-title-small{
            height: 32px;
        }
    </style>
</head>

<body>
    <div class="modal" id="dialog-container">
        <a href="#close" class="modal-overlay" aria-label="Close"></a>
        <div class="modal-container">
            <div class="modal-header">
                <a href="#close" class="btn btn-clear float-right" aria-label="Close"
                    onclick="closeDialog()"></a>
                <div class="modal-title h5" id="window-dialog-title">Dialog</div>
            </div>
            <div class="modal-body">
                <div class="content">
                    <div id="window-dialog-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <header class="navbar">
            
    <section class="navbar-section">
        <img
            class="site-title-small"
            src="https://imjoy.io/static/img/imjoy-logo-black.svg"
            alt="ImJoy"
        />
        <!-- <a href="https://imjoy.io/docs" target="_blank" class="btn btn-link">Docs</a>
        <a href="https://github.com/oeway/ImJoy" target="_blank" class="btn btn-link">GitHub</a> -->
    </section>
    <section class="navbar-section" id="header" style="flex: 0 1 0;">
         
    </section>
    <progress class="progress" id="progress" value="100" max="100"></progress>
    </header>
    
    <div class="whiteboard" id="whiteboard">

    </div>

    <script>
        var selected_window = null
        var imjoy = null
        var windows = null
        var imjoy_api = {
            showMessage(plugin, info, duration){
                console.log(info)
            },
            showProgress(plugin, progress){
                if (p < 1) progress =  progress * 100;
                document.getElementById('progress').value = progress
            },
            showDialog(_plugin, config) {
                return new Promise((resolve, reject) => {
                    document.getElementById('window-dialog-container').innerHTML = '';
                    if (config.ui) {
                        openDialog()
                        const joy_config = {
                            // Where the Joy editor goes:
                            container:  document.getElementById('window-dialog-container'),

                            // The words & ops inside the editor:
                            init: config.ui || "", //"{id:'localizationWorkflow', type:'ops'} " + // a list of ops
                            //"<hr> {type:'save'}", // a save button!

                            // Load data from URL, otherwise blank:
                            data: config.data, // || Joy.loadFromURL(),

                            // Other ops to include, beyond turtle ops:
                            modules: config.modules || ["instructions", "math"],

                            onexecute: config.onexecute,
                            // What to do when the user makes a change:
                            onupdate: config.onupdate,
                        };
                        // console.log('setting up joy ', config)
                        try {
                            new imjoyLib.Joy(joy_config);
                        } catch (e) {
                            console.error("error occured when loading the workflow", e);
                            joy_config.data = "";
                            new imjoyLib.Joy(joy_config);
                            throw e;
                        }
                 
                    } else if (config.type) {
                        openDialog()
                        config.window_container = "window-dialog-container";
                        config.standalone = true;
                        if (config.type.startsWith("imjoy/")) {
                            config.render = wconfig => {
                            };
                        }
                        setTimeout(() => {
                            imjoy.pm.createWindow(null, config)
                            .then(api => {
                                const _close = api.close;
                                api.close = async () => {
                                    await _close();
                                    closeDialog();
                                };
                                resolve(api);
                            })
                            .catch(reject);
                        }, 0);
                    } else {
                        alert("Unsupported dialog type.");
                    }
                });
            },
        }
        function openDialog() {
            document.getElementById('dialog-container').classList.add('active')
        }
        function closeDialog() {
            document.getElementById('dialog-container').classList.remove('active')
        }
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };
        function addWindow(title, id){
            document.getElementById('header').innerHTML =`
            <span class="chip" id="header_${id}" onclick="selectWindow('${id}')">
                ${title}
                <a href="#" onclick="removeWindow('${id}')" class="btn btn-clear" aria-label="Close" role="button"></a>
            </span>` + document.getElementById('header').innerHTML;

            document.getElementById('whiteboard').innerHTML =`
                <div class="window_container" id="${id}"></div>
            ` + document.getElementById('whiteboard').innerHTML;

            selectWindow(id)
        }
        function removeWindow(id){
            document.getElementById('header').removeChild(document.getElementById('header_'+id));
            document.getElementById('whiteboard').removeChild(document.getElementById(id));
        }

        function selectWindow(id){
            for(let c of document.getElementById('whiteboard').children){
                if(c.id !== 'site-title'){
                    c.style.display = "none";
                }
            } 

            for(let c of document.getElementById('header').children)
                c.classList.remove('active')
            selected_window = id;
            document.getElementById(id).style.display = "block";
            document.getElementById('header_'+id).classList.add('active')
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            imjoy = new imjoyLib.ImJoy({
                imjoy_api: imjoy_api,
                show_message_callback: console.log,
                show_engine_callback: console.log,
                add_window_callback: async (w)=>{
                    addWindow(w.name, w.iframe_container)
                },
                update_ui_callback: ()=>{}
            })
            imjoy.start().then(()=>{
                windows = imjoy.wm.windows
                console.log(imjoy)
                const p = getUrlParameter('plugin');
                if(p){
                    axios.get(p).then((response)=>{
                        imjoy.pm.reloadPlugin({code: response.data}).then((plugin)=>{
                            plugin.api.run({config: {}, data: {}})
                        })
                    })
                }

                axios.get('https://raw.githubusercontent.com/oeway/ImJoy-Plugins/master/repository/ImageSelection.imjoy.html').then((response)=>{
                    imjoy.pm.reloadPlugin({code: response.data}).then((plugin)=>{
                        plugin.api.run({config: {}, data: {}})
                    })
                })

                axios.get('https://raw.githubusercontent.com/oeway/ImJoy-Plugins/master/repository/ImageAnnotator.imjoy.html').then((response)=>{
                    imjoy.pm.reloadPlugin({code: response.data}).then((plugin)=>{
                        plugin.api.run({config: {}, data: {}})
                    })
                })
                
            })
            .catch((e)=>{
                console.error(e)
                alert('Error: '+ e)
            })
        })
    </script>
</body>

</html>